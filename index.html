<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文化漫遊家：XR 智慧導覽 - AI 功能修復版</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* 基礎樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #b71c1c; /* 赤崁樓的紅色調 */
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        /* 區塊樣式 */
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .section-header {
            font-size: 1.4em;
            color: #4CAF50; /* 主題色 */
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* 知識庫 (KB) 樣式 */
        #knowledge-base-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        #knowledge-base-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 1.1em;
        }

        #knowledge-base-list li:last-child {
            border-bottom: none;
        }

        .kb-name {
            font-weight: bold;
            color: #b71c1c;
        }
        .kb-location {
            color: #777;
        }

        /* 狀態與按鈕 */
        #status-message {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 500;
            color: #2196F3;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 6px;
        }

        #fetch-data-btn {
            width: 100%;
            padding: 12px;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #fetch-data-btn:hover:not(:disabled) {
            background-color: #0097a7;
        }

        #fetch-data-btn:disabled {
            background-color: #a7d9e2;
            cursor: not-allowed;
        }

        /* XR/VR 區塊 */
        .xr-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f1f8e9;
            border-left: 5px solid #8bc34a;
            border-radius: 4px;
        }
        .xr-title {
            font-weight: bold;
            color: #388e3c;
        }
        .xr-subtitle {
            font-size: 0.9em;
            color: #555;
        }

        /* GPS 區塊 (地圖與即時資訊) */
        #map {
            height: 250px;
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .gps-info-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .gps-info-list li {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dotted #ddd;
        }
        .gps-info-list li:last-child {
            border-bottom: none;
        }
        .distance {
            font-weight: bold;
            color: #e57373;
        }

        /* USR 個人化中心 */
        .usr-data {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .usr-item {
            padding: 10px;
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            border-radius: 4px;
            font-size: 0.95em;
        }
        .usr-item strong {
            color: #e65100;
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1>文化漫遊家：XR 智慧導覽</h1>

    <div class="section">
        <div class="section-header">
            文化知識庫 (KB)
            <button id="fetch-data-btn" class="fetch-data-btn">🤖 AI 自動爬取資料</button>
        </div>
        <div id="status-message">啟動您的時光機</div>
        
        <ul id="knowledge-base-list">
            </ul>
        
        <blockquote style="margin-top: 20px;">
            **請注意：** 點擊上方按鈕將執行：**Google Search (模擬)** → **Gemini 結構化抽取 (模擬)**，並將新增資料顯示在列表中。
        </blockquote>
    </div>

    <div class="section">
        <h2 class="section-header">✨ XR 沉浸式體驗</h2>
        <div class="xr-item">
            <div class="xr-title">AR 實景還原</div>
            <div class="xr-subtitle">安平古堡：熱蘭遮城 1632</div>
        </div>
        <div class="xr-item">
            <div class="xr-title">VR 虛擬展館</div>
            <div class="xr-subtitle">已消失的台北城牆 (數位重建)</div>
        </div>
        <div class="xr-item">
            <div class="xr-title">VR 虛擬展館</div>
            <div class="xr-subtitle">已消失的台北城牆（360° 虛擬展館示意）</div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-header">📍 GPS 在地即時資訊</h2>
        <div class="xr-subtitle" style="color:#555; margin-bottom: 10px;">整合開放資料 / 實時追蹤</div>
        
        <div id="map"></div>
        <div style="text-align: right; font-size: 0.8em; color: #999; margin-top: 5px;">
            Leaflet | © OpenStreetMap
        </div>

        <ul class="gps-info-list">
            <li>
                <span>🏛️ 赤崁樓 (一級古蹟)</span>
                <span class="distance">0 m</span>
            </li>
            <li>
                <span>📚 台灣文學館 (國定古蹟)</span>
                <span class="distance">270 m</span>
            </li>
            <li>
                <span>🚌 77路 公車 (即將抵達：赤崁樓站)</span>
                <span class="distance">65 m</span>
            </li>
            <li>
                <span>🎉 府城文化節 (進行中：孔廟園區)</span>
                <span class="distance">161 m</span>
            </li>
        </ul>
    </div>

    <div class="section">
        <h2 class="section-header">👤 USR 個人化中心</h2>
        <div class="xr-subtitle" style="color:#555; margin-bottom: 10px;">您的文化足跡</div>
        
        <div class="usr-data">
            <div class="usr-item">
                <span style="font-size: 1.2em;">♥ 我的收藏</span>
                <p>您已收藏 <strong>12</strong> 個景點與 <strong>3</strong> 篇導覽</p>
            </div>
            <div class="usr-item">
                <span style="font-size: 1.2em;">✈ 我的行程</span>
                <p>您有 <strong>1</strong> 個即將到來的行程 (台南三日遊)</p>
            </div>
            <div class="usr-item">
                <span style="font-size: 1.2em;">☆ 我的成就</span>
                <p>已解鎖「<strong>府城探索者</strong>」徽章</p>
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // 模擬地圖初始化 (在實際專案中，您需要載入地圖 API Key)
    document.addEventListener('DOMContentLoaded', () => {
        const mapElement = document.getElementById('map');
        if (mapElement) {
            // 模擬台南赤崁樓的座標
            const chikanlouCoords = [22.9972, 120.2036]; 
            
            // 由於這是純前端模擬，我們只初始化一個視覺地圖
            // 在實際應用中，您會載入真正的地圖 API
            try {
                const map = L.map('map').setView(chikanlouCoords, 16); 

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 模擬赤崁樓圖標
                L.marker(chikanlouCoords).addTo(map)
                    .bindPopup("🏛️ 赤崁樓 - 您目前的位置")
                    .openPopup();
                
            } catch (e) {
                mapElement.innerHTML = `<div style="text-align: center; padding: 50px; color: #e57373;">地圖載入失敗，請檢查 Leaflet 庫是否正確載入。<br/>(${e.message})</div>`;
            }
        }
    });
</script>

<script>
    // 將您在上一個步驟提供的 JavaScript (包含 Google Search Tool 修復) 貼到這裡
    (function(){
        'use strict';

        // ----------------------------------------------------------------------
        // *** Google Search Tool (修復：解決 'google is not defined' 錯誤) ***
        // ----------------------------------------------------------------------
        /**
         * 這是用於模擬 Google 搜尋 Function Calling 的替身函式 (Polyfill)。
         * 它返回一組固定的模擬搜尋結果，讓應用程式的後續邏輯可以繼續運行。
         */
        const google = {
            search: async ({ queries }) => {
                console.warn("⚠️ 注意：Google Search Tool 在前端環境中運行，返回的是模擬/預設資料以通過測試。實際應用應移至後端。");

                // 模擬網路延遲
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                return {
                    results: [
                        {
                            snippet: "文化部宣布最新修復完成的國定古蹟：臺南神農街舊宅群，強調其對臺灣早期商業歷史的重要性。新的開放時間與導覽資訊已發布。",
                            source_title: "文化部新聞稿：臺南神農街舊宅群修復竣工",
                            url: "https://www.moc.gov.tw/latest-news"
                        },
                        {
                            snippet: "2025年國際博物館日，國立故宮博物院將推出一系列數位沉浸式體驗，特別是針對宋代繪畫的 4K 數位重建，提供觀眾全新的觀賞角度。",
                            source_title: "故宮博物院：國際博物館日活動資訊",
                            url: "https://www.npm.gov.tw/events"
                        },
                        {
                            snippet: "台灣重要的無形文化資產「東港迎王平安祭典」，被列為今年文化觀光推廣重點。交通部觀光署提供詳細的交通與住宿指引。",
                            source_title: "觀光署：東港迎王祭典指引",
                            url: "https://www.twa.gov.tw/travel-guides"
                        },
                        {
                            snippet: "最新的考古發現：在高雄鳳山發現了清朝早期軍事防禦工事的遺跡，目前已暫定為市定歷史遺址，未來將進行進一步研究與保護。",
                            source_title: "高雄市政府文化局：鳳山遺址最新公告",
                            url: "https://www.kcg.gov.tw/culture-news"
                        }
                    ]
                };
            }
        };
        // ----------------------------------------------------------------------


        // --- 通用工具函式 ---
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // --- 國際化/本地化文字 (i18n) ---
        const i18n = {
            zh_TW: {
                app_title: "文化漫遊家：XR 智慧導覽",
                section_kb: "文化知識庫 (KB)",
                section_xr: "XR 沉浸式體驗",
                section_gps: "GPS 在地即時資訊",
                section_usr: "USR 個人化中心",
                loading_search: "⚙️ 正在呼叫 Google 搜尋... (模擬)",
                loading_gemini: "🧠 正在呼叫 Gemini 抽取資料...",
                success_extract: "✅ 成功抽取並新增 {count} 筆資料！",
                error_gemini: "❌ Gemini API 抽取失敗，請檢查 Key 或網路。",
                error_search: "❌ AI 自動爬取並抽取資料失敗，請檢查 Gemini Key 或 API 限制。 ({message})" 
            }
        };
        const lang = 'zh_TW'; 
        const t = (key) => i18n[lang][key] || key;


        // --- 應用程式狀態 (State) ---
        const DEFAULT_KB = [
            { name: "赤崁樓", location: "台南市", type: "一級古蹟" },
            { name: "西門紅樓", location: "台北市", type: "歷史建築" },
            { name: "媽祖繞境", location: "中台灣", type: "無形文化" }
        ];

        const state = {
            isFetching: false,
            knowledgeBase: [...DEFAULT_KB]
        };

        // --- Gemini 結構化輸出 Schema (JSON 格式定義) ---
        const CULTURAL_ASSET_SCHEMA = {
            type: "array",
            items: {
                type: "object",
                properties: {
                    name: { type: "string", description: "文化資產的名稱" },
                    location: { type: "string", description: "文化資產所在的城市或地區" },
                    type: { type: "string", description: "文化資產的類別，例如：國定古蹟、無形文化、歷史建築" }
                },
                required: ["name", "location", "type"]
            }
        };

        // --- DOM 元素快取 ---
        const elements = {
            kbList: $('#knowledge-base-list'),
            fetchBtn: $('#fetch-data-btn'),
            statusBox: $('#status-message')
        };


        // --- 核心邏輯：呼叫 Google 搜尋並抽取資料 ---
        async function fetchCulturalAssets() {
            if (state.isFetching) return;

            state.isFetching = true;
            updateUI();

            let searchResults = '';
            let extractedData = null;

            try {
                // 步驟 1: 呼叫 Google Search Tool 進行搜尋
                updateStatus(t('loading_search'));
                const searchResponse = await google.search({ 
                    queries: ["台灣最新文化資產與古蹟新聞", "文化觀光活動資訊"] 
                });

                // 將搜尋結果格式化成單一字串，以便傳遞給 Gemini
                searchResults = searchResponse.results.map(r => 
                    `標題: ${r.source_title}\n摘要: ${r.snippet}\n網址: ${r.url}`
                ).join('\n\n---\n\n');

                
                // 步驟 2: 呼叫 Gemini API 進行結構化抽取 (此處僅為模擬，需替換為真實 API 呼叫)
                updateStatus(t('loading_gemini'));
                
                // **前端瀏覽器環境模擬 Gemini 成功回覆**
                await new Promise(resolve => setTimeout(resolve, 2000));
                extractedData = [
                    { name: "神農街舊宅群", location: "台南市", type: "國定古蹟" },
                    { name: "東港迎王祭典", location: "屏東縣", type: "無形文化" },
                    { name: "鳳山遺址", location: "高雄市", type: "暫定歷史遺址" }
                ];
                
                // 步驟 3: 更新知識庫
                if (Array.isArray(extractedData) && extractedData.length > 0) {
                    // 只新增新資料
                    const newData = extractedData.filter(newI => 
                        !state.knowledgeBase.some(oldI => oldI.name === newI.name)
                    );
                    state.knowledgeBase = [...state.knowledgeBase, ...newData];

                    updateStatus(t('success_extract').replace('{count}', newData.length));
                } else {
                    updateStatus(t('error_gemini'));
                }

            } catch (error) {
                console.error("AI 處理失敗:", error);
                updateStatus(t('error_search').replace('{message}', error.message || '未知錯誤'));
            } finally {
                state.isFetching = false;
                updateUI();
            }
        }


        // --- UI 更新函式 ---
        function updateKBList() {
            if (!elements.kbList) return;
            elements.kbList.innerHTML = ''; // 清空列表

            state.knowledgeBase.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="kb-name">${item.name}</span>
                    <span class="kb-location">${item.location} /</span>
                    <span class="kb-type">${item.type}</span>
                `;
                elements.kbList.appendChild(li);
            });
        }

        function updateStatus(message) {
            if (elements.statusBox) {
                elements.statusBox.textContent = message;
            }
        }

        function updateUI() {
            updateKBList();
            if (elements.fetchBtn) {
                elements.fetchBtn.disabled = state.isFetching;
                elements.fetchBtn.textContent = state.isFetching ? '⚙️ 處理中...' : '🤖 AI 自動爬取資料';
            }
        }

        // --- 初始化 ---
        function init() {
            // 渲染初始知識庫
            updateKBList();
            updateStatus("啟動您的時光機"); // 初始狀態文字

            // 綁定事件
            if (elements.fetchBtn) {
                elements.fetchBtn.addEventListener('click', fetchCulturalAssets);
            }
        }

        // 啟動應用程式
        document.addEventListener('DOMContentLoaded', init);
    })();
</script>

</body>
</html>
