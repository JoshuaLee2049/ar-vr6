
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–‡åŒ–æ™ºéŠ - AI ç§‘æŠ€å„€è¡¨æ¿ï¼ˆAR/VRæ•´åˆç‰ˆ v3ï¼‰</title>
  <meta name="color-scheme" content="dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#070718; --bg-grad-a:rgba(0,255,255,.1); --bg-grad-b:rgba(187,0,255,.1);
      --pri:#00ffff; --sec:#bb00ff; --text:#e6f7ff; --muted:#8090a0; --glass:rgba(0,0,0,.7);
      --glass-border:rgba(255,255,255,.06); --glow-pri:0 0 15px rgba(0,255,255,.4), 0 0 5px rgba(0,255,255,.18);
      --glow-sec:0 0 15px rgba(187,0,255,.4), 0 0 5px rgba(187,0,255,.18); --ok:#4aff8f; --bad:#ff4a4a;
      --radius:18px; --radius-sm:10px; --shadow-deep:0 0 30px rgba(0,0,0,.7), 0 0 20px rgba(0,255,255,.05), 0 0 40px rgba(187,0,255,.08); --space:clamp(.75rem, .75rem + 1.2vw, 2rem); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:radial-gradient(circle at 15% 15%, var(--bg-grad-a), transparent 30%), radial-gradient(circle at 85% 75%, var(--bg-grad-b), transparent 35%), linear-gradient(135deg,#070718 0%,#030018 100%);
      background-color:var(--bg); padding:clamp(1rem,3vw,2.5rem)}
    :focus-visible{outline:2px solid var(--pri); outline-offset:2px; border-radius:8px}
    @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(1rem,2vw,2rem)}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:var(--shadow-deep);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:calc(var(--space)*1.1);transition:transform .25s ease,box-shadow .25s ease}
    .panel:hover{transform:translateY(-2px);box-shadow:var(--glow-pri)}
    .module-header{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem}
    .module-header h2{margin:0;font-size:clamp(1.1rem,1rem + .8vw,1.5rem);color:var(--pri);text-shadow:0 0 6px rgba(0,255,255,.28)}
    .module-sub{margin:0;color:var(--muted);font-size:.95rem}
    .chip{display:inline-flex;align-items:center;gap:.4rem;font-family:'Orbitron',monospace;font-weight:700;background:linear-gradient(45deg,var(--pri),var(--sec));color:#091018;border-radius:var(--radius-sm);padding:.35rem .6rem;letter-spacing:.5px}
    .btn{cursor:pointer;border:1.5px solid var(--pri);background:rgba(0,255,255,.06);color:var(--pri);border-radius:var(--radius-sm);padding:.55rem .9rem;font-size:.95rem;transition:.2s ease}
    .btn:hover{box-shadow:var(--glow-pri);transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--pri),#00aaff);color:#081018;border-color:transparent}
    .input,textarea.input{width:100%;background:rgba(0,0,0,.4);color:var(--text);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:.65rem .8rem;font-size:.95rem}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-12{grid-column:span 12}
    @media (max-width:960px){.col-6,.col-4{grid-column:span 12}}
    header.header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:var(--space)}
    .nav{display:flex;gap:.8rem;flex-wrap:wrap}
    .nav a{color:var(--muted);text-decoration:none;padding:.4rem .6rem;border-radius:8px}
    .nav a.active,.nav a:hover{background:rgba(0,255,255,.08);color:var(--text)}

    .kb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    @media (max-width:1200px){.kb-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:720px){.kb-grid{grid-template-columns:1fr}}
    .kb-card{overflow:hidden;border-radius:16px;border:1px solid var(--glass-border);background:rgba(255,255,255,.02)}
    .kb-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
    .kb-card .content{padding:.8rem .9rem}
    .kb-card h4{margin:0 0 .25rem 0;font-size:1.05rem}
    .filters{display:flex;gap:.6rem;flex-wrap:wrap}
    .filter{padding:.35rem .6rem;border:1px solid var(--glass-border);border-radius:999px;color:var(--muted);cursor:pointer}
    .filter.active{border-color:var(--pri);color:var(--text);box-shadow:var(--glow-pri)}

    .chat{display:flex;flex-direction:column;gap:.6rem;height:clamp(220px,35vh,360px);overflow:auto;background:rgba(255,255,255,.02);border-radius:12px;padding:.8rem;border:1px solid var(--glass-border)}
    .bubble{max-width:88%;padding:.6rem .8rem;border-radius:14px}
    .bubble.ai{background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.2)}
    .bubble.user{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);margin-left:auto}
    .chat-input{display:flex;gap:.5rem;margin-top:.6rem}
    .chat-input .mic{width:2.25rem}
    .status{display:inline-flex;align-items:center;gap:.4rem;font-size:.92rem;color:var(--muted)}
    .dot{width:.55rem;height:.55rem;border-radius:50%;background:#666;box-shadow:inset 0 0 0 2px rgba(0,0,0,.3)}
    .dot.ok{background:var(--ok)}

    .xp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
    @media (max-width:960px){.xp-grid{grid-template-columns:1fr}}
    .xp-card{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--glass-border)}
    .xp-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
    .xp-overlay{position:absolute;inset:auto 0 0 0;padding:.9rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65))}
    .tag{display:inline-block;padding:.3rem .5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;margin-bottom:.4rem}

    .ar-card model-viewer{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15)}
    .hotspot{--size:14px;width:var(--size);height:var(--size);border-radius:999px;border:2px solid rgba(255,255,255,.9);background:rgba(0,255,255,.9);box-shadow:var(--glow-pri)}
    .annotation{position:absolute;transform:translate(-50%,calc(-100% - 10px));padding:.35rem .55rem;background:rgba(0,0,0,.75);border:1px solid var(--glass-border);border-radius:8px;color:#e6f7ff;font-size:.85rem;white-space:nowrap;pointer-events:none}

    .vr-card .vr-wrap{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden}
    .vr-card .vr-wrap canvas{display:block}

    .collapsible{cursor:pointer;position:relative}
    .collapsible .caret{margin-left:auto;font-size:.9rem;opacity:.9}
    .section-body{margin-top:.6rem;display:block}
    .section-body[hidden]{display:none}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.82);backdrop-filter:blur(5px);z-index:1000}
    .modal[open]{display:grid}
    .modal-card{width:min(600px,92vw);background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:1.1rem;box-shadow:var(--glow-pri)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding-bottom:.6rem;border-bottom:2px solid var(--sec)}
    .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) translateY(120%);background:rgba(0,0,0,.85);color:#fff;padding:.6rem .9rem;border-radius:10px;border:1px solid var(--glass-border);transition:transform .28s ease;z-index:1200;white-space:pre-wrap}
    .toast.show{transform:translateX(-50%) translateY(0)}
    .toast.success{box-shadow:0 0 0 2px rgba(74,255,143,.2)}
    .toast.error{box-shadow:0 0 0 2px rgba(255,74,74,.2)}
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="lang-switch" style="display:flex; gap:.5rem; align-items:center; margin-bottom:.6rem;">
    <span style="color:var(--text); font-size:.9rem" data-key="ui_lang">ä»‹é¢èªè¨€:</span>
    <button class="btn" data-lang="zh-Hant" id="btn-zh">ç¹é«”ä¸­æ–‡</button>
    <button class="btn" data-lang="en" id="btn-en">English</button>
  </div>

  <header class="header" role="banner">
    <h1 id="app-title" data-key="title">æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿</h1>
    <nav class="nav" aria-label="ä¸»è¦å°è¦½">
      <a href="#section-guide" class="active" data-key="nav_guide">å°è¦½</a>
      <a href="#section-kb" data-key="nav_knowledge">çŸ¥è­˜åº«</a>
      <a href="#section-xp" data-key="nav_experience">é«”é©—</a>
      <a href="#section-me" data-key="nav_personal">å€‹äººä¸­å¿ƒ</a>
    </nav>
  </header>

  <main class="grid" role="main" aria-live="polite">
    <section class="panel col-12" aria-labelledby="api-h2">
      <div class="module-header">
        <div class="chip" aria-hidden="true"><span>API</span></div>
        <h2 id="api-h2" data-key="h2_api">API æ•´åˆæœå‹™æ¨¡çµ„</h2>
      </div>
      <p class="module-sub" data-key="p_api">ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š</p>
      <div class="row" style="margin-top:.6rem">
        <div class="col-4">
          <label for="gemini-api" class="sr">Gemini API Key</label>
          <input id="gemini-api" class="input" type="password" placeholder="Gemini API Key" autocomplete="off" />
        </div>
        <div class="col-4">
          <label for="maps-api" class="sr">Maps API</label>
          <input id="maps-api" class="input" type="password" placeholder="Maps API" />
        </div>
        <div class="col-4">
          <label for="ptx-api" class="sr">Data.gov.tw (PTX)</label>
          <input id="ptx-api" class="input" type="password" placeholder="Data.gov.tw (PTX)" />
        </div>
      </div>
      <div style="display:flex; gap:.8rem; align-items:center; justify-content:flex-end; margin-top:.8rem">
        <span class="status"><span id="rag-dot" class="dot" aria-hidden="true"></span><span id="rag-text" data-key="status_rag">RAG æœå‹™ï¼šå°šæœªé€£ç·š</span></span>
        <span class="status"><span class="dot ok" aria-hidden="true"></span><span data-key="status_data">é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­</span></span>
        <button id="btn-save-api" class="btn primary" data-key="btn_save" type="button">å„²å­˜è¨­å®š</button>
      </div>
    </section>

    <section id="section-guide" class="panel col-12" aria-labelledby="guide-h2">
      <div class="module-header">
        <div class="chip" aria-hidden="true"><span>AI</span></div>
        <h2 id="guide-h2" data-key="h2_guide">AI æ™ºèƒ½å°è¦½</h2>
      </div>
      <p class="module-sub" data-key="p_guide">æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°</p>
      <div id="chat" class="chat" aria-live="polite" aria-label="èŠå¤©è¦–çª—">
        <div class="bubble ai" data-key="chat_init">[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚</div>
      </div>
      <div class="chat-input">
        <button class="btn mic" type="button" aria-label="èªéŸ³è¼¸å…¥">ğŸ¤</button>
        <input id="chat-input" class="input" type="text" data-key="placeholder_chat" placeholder="è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚..." />
        <button id="btn-send" class="btn primary" type="button" data-key="btn_send">ç™¼é€</button>
      </div>
    </section>

    <section id="section-kb" class="panel col-12" aria-labelledby="kb-h2">
      <div class="module-header">
        <div class="chip" aria-hidden="true"><span>DB</span></div>
        <h2 id="kb-h2" data-key="h2_db">æ–‡åŒ–çŸ¥è­˜åº«</h2>
        <button id="btn-import" class="btn" type="button" data-key="btn_import">â†“ åŒ¯å…¥æ–°è³‡æ–™</button>
      </div>
      <p class="module-sub" data-key="p_db">æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)</p>
      <div class="row" style="margin:.6rem 0 .8rem 0; align-items:center">
        <div class="col-6"><input id="kb-search" class="input" type="text" data-key="placeholder_search" placeholder="æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶..." /></div>
        <div class="col-6" style="display:flex; justify-content:flex-end"><div class="filters" role="tablist" aria-label="é¡å‹ç¯©é¸">
          <button class="filter active" data-filter="all" data-key="filter_all" role="tab" aria-selected="true">å…¨éƒ¨</button>
          <button class="filter" data-filter="monument" data-key="filter_monument" role="tab">å¤è¹Ÿ</button>
          <button class="filter" data-filter="museum" data-key="filter_museum" role="tab">åšç‰©é¤¨</button>
          <button class="filter" data-filter="intangible" data-key="filter_intangible" role="tab">ç„¡å½¢æ–‡åŒ–</button>
        </div></div>
      </div>
      <div id="kb-grid" class="kb-grid" aria-live="polite"></div>
    </section>

    <section id="section-xp" class="panel col-12" aria-labelledby="xp-h2">
      <div class="module-header">
        <div class="chip" aria-hidden="true"><span>AR</span></div>
        <h2 id="xp-h2" data-key="h2_immersive">æ²‰æµ¸å¼é«”é©—</h2>
      </div>
      <p class="module-sub" data-key="p_immersive">å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ</p>
      <div class="xp-grid">
        <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå®‰å¹³å¤å ¡ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
          <model-viewer id="mv-anping"
            src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
            ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
            alt="å®‰å¹³å¤å ¡ç¤ºæ„ 3D æ¨¡å‹"
            ar ar-modes="webxr scene-viewer quick-look"
            ar-scale="auto" ar-placement="floor"
            camera-controls camera-orbit="0deg 75deg 2.2m" field-of-view="30deg"
            environment-image="neutral" shadow-intensity="1" exposure="1"
            interaction-prompt="auto"
            poster="https://via.placeholder.com/800x520/331144/cccccc?text=Tap+to+Load+AR"
            aria-label="å•Ÿå‹• AR æª¢è¦–">
            <button class="hotspot" slot="hotspot-gate" data-position="0.15m 1.2m 0.2m" data-normal="0 1 0" data-anno="åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰"></button>
            <div class="annotation" slot="annotation-gate">åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰</div>
            <button class="hotspot" slot="hotspot-battery" data-position="-0.25m 0.9m 0.1m" data-normal="0 1 0" data-anno="ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½"></button>
            <div class="annotation" slot="annotation-battery">ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½</div>
            <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
          </model-viewer>
          <div class="xp-overlay">
            <span class="tag" data-key="tag_ar">AR å¯¦æ™¯é‚„åŸ</span>
            <h4 style="margin:.2rem 0" data-key="h4_anping">å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632ï¼ˆAR ç¤ºæ„ï¼‰</h4>
          </div>
        </article>

        <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå°åŒ—åŸç‰†ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
          <model-viewer
            src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
            ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
            alt="å°åŒ—åŸç‰†ç¤ºæ„ 3D æ¨¡å‹"
            ar ar-modes="webxr scene-viewer quick-look"
            camera-controls environment-image="neutral" shadow-intensity="1"
            poster="https://via.placeholder.com/800x520/113333/cccccc?text=Tap+to+Load+AR"
            aria-label="å•Ÿå‹• AR æª¢è¦–">
            <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
          </model-viewer>
          <div class="xp-overlay">
            <span class="tag" data-key="tag_vr">VR / AR é«”é©—</span>
            <h4 style="margin:.2rem 0" data-key="h4_taipei">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆAR ç¤ºæ„ï¼‰</h4>
          </div>
        </article>

        <article class="xp-card vr-card" aria-label="VR è™›æ“¬å±•é¤¨ï¼š360 å…¨æ™¯ç¤ºæ„">
          <div class="vr-wrap">
            <a-scene embedded background="color: #000">
              <a-assets>
                <img id="pano" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" />
              </a-assets>
              <a-sky src="#pano"></a-sky>
              <a-entity position="0 1.6 0">
                <a-camera wasd-controls-enabled="false"></a-camera>
              </a-entity>
            </a-scene>
          </div>
          <div class="xp-overlay">
            <span class="tag">VR è™›æ“¬å±•é¤¨</span>
            <h4 style="margin:.2rem 0">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆ360Â° è™›æ“¬å±•é¤¨ç¤ºæ„ï¼‰</h4>
          </div>
        </article>
      </div>
    </section>

    <section class="panel col-12" aria-labelledby="local-h2">
      <div id="local-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
        <div class="chip" aria-hidden="true"><span>GPS</span></div>
        <h2 id="local-h2" data-key="h2_local">åœ¨åœ°å³æ™‚è³‡è¨Š</h2>
        <span class="module-sub" data-key="p_local">æ•´åˆé–‹æ”¾è³‡æ–™</span>
        <span class="caret" aria-hidden="true">â–¼</span>
      </div>
      <div id="local-body" class="section-body">
        <div role="region" aria-label="äº’å‹•åœ°åœ–" style="border:1px dashed rgba(255,255,255,.18); border-radius:12px; padding:.9rem; text-align:center; margin-bottom:.8rem" data-key="map_placeholder">--- äº’å‹•åœ°åœ–è¼‰å…¥å€åŸŸ ---</div>
        <ul style="list-style:none; padding:0; margin:0; display:grid; gap:.6rem">
          <li class="kb-card" style="display:flex; gap:.7rem; align-items:center; padding:.7rem;">
            <div class="chip" aria-hidden="true">BUS</div>
            <div>
              <h5 style="margin:.1rem 0" data-key="bus_route">[å¸‚å€å…¬è»Š] 77è·¯</h5>
              <p style="margin:0; color:var(--muted)" data-key="bus_status">å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™ (3 åˆ†é˜)</p>
            </div>
          </li>
          <li class="kb-card" style="display:flex; gap:.7rem; align-items:center; padding:.7rem;">
            <div class="chip" aria-hidden="true">EVT</div>
            <div>
              <h5 style="margin:.1rem 0" data-key="event_name">[ç¯€æ…¶æ´»å‹•] åºœåŸæ–‡åŒ–ç¯€</h5>
              <p style="margin:0; color:var(--muted)" data-key="event_status">é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€ (è·é›¢ 1.2km)</p>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <section id="section-me" class="panel col-12" aria-labelledby="me-h2">
      <div id="me-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
        <div class="chip" aria-hidden="true"><span>USR</span></div>
        <h2 id="me-h2" data-key="h2_personal">å€‹äººåŒ–ä¸­å¿ƒ</h2>
        <span class="module-sub" data-key="p_personal">æ‚¨çš„æ–‡åŒ–è¶³è·¡</span>
        <span class="caret" aria-hidden="true">â–¼</span>
      </div>
      <div id="me-body" class="section-body">
        <div class="kb-grid">
          <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
            <div class="chip" aria-hidden="true">â™¥</div>
            <div><h4 data-key="card_fav">æˆ‘çš„æ”¶è—</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_fav_p">æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½</p></div>
          </div></div>
          <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
            <div class="chip" aria-hidden="true">âœˆ</div>
            <div><h4 data-key="card_trip">æˆ‘çš„è¡Œç¨‹</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_trip_p">æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)</p></div>
          </div></div>
          <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
            <div class="chip" aria-hidden="true">â˜†</div>
            <div><h4 data-key="card_ach">æˆ‘çš„æˆå°±</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_ach_p">å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« </p></div>
          </div></div>
        </div>
      </div>
    </section>
  </main>

  <dialog id="import-modal" class="modal" aria-labelledby="import-title" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="import-title" data-key="modal_title">åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢</h3>
        <button id="btn-close-modal" class="btn" type="button" aria-label="é—œé–‰">âœ•</button>
      </div>
      <form id="import-form" method="dialog">
        <div class="row" style="margin-top:.6rem">
          <div class="col-12"><label for="asset-name" data-key="modal_label_name">è³‡ç”¢åç¨± (å¿…å¡«)</label><input id="asset-name" class="input" required /></div>
          <div class="col-6"><label for="asset-location" data-key="modal_label_location">åœ°é» / ç¸£å¸‚ (å¿…å¡«)</label><input id="asset-location" class="input" required /></div>
          <div class="col-6"><label for="asset-type" data-key="modal_label_type">é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)</label><input id="asset-type" class="input" /></div>
          <div class="col-12"><label for="asset-img-url" data-key="modal_label_img">åœ–ç‰‡ URL (é¸å¡«)</label><input id="asset-img-url" class="input" type="url" placeholder="https://..." /></div>
          <div class="col-12">
            <label for="asset-desc" data-key="modal_label_desc">ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)</label>
            <textarea id="asset-desc" class="input" rows="4"></textarea>
            <button id="btn-ai-summarize" class="btn" type="button" style="margin-top:.5rem;" data-key="btn_ai_summarize">ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)</button>
          </div>
          <div class="col-12" style="margin-top:1rem; border-top: 1px dashed var(--glass-border); padding-top: 1rem;">
            <h4 style="margin:0 0 .5rem 0; color:var(--pri)" data-key="modal_h4_csv">æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™</h4>
            <input id="asset-csv-file" type="file" accept=".csv" class="input" style="padding: .5rem;" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn" type="button" id="btn-cancel" data-key="btn_cancel">å–æ¶ˆ</button>
          <button class="btn primary" type="submit" id="btn-submit" data-key="btn_submit">å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨</button>
          <button class="btn" type="button" id="btn-import-csv" data-key="btn_import_csv">æ‰¹æ¬¡åŒ¯å…¥ CSV</button>
        </div>
      </form>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <template id="kb-card-tpl">
    <article class="kb-card" data-id="">
      <img src="" alt="" />
      <div class="content">
        <h4 class="title"></h4>
        <p class="meta" style="margin:.2rem 0; color:var(--muted)"></p>
      </div>
    </article>
  </template>

  <script>
  (function(){
    'use strict';
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const i18n = {
      'zh-Hant': {
        ui_lang: 'ä»‹é¢èªè¨€:', title: 'æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿', nav_guide: 'å°è¦½', nav_knowledge: 'çŸ¥è­˜åº«', nav_experience: 'é«”é©—', nav_personal: 'å€‹äººä¸­å¿ƒ',
        h2_api: 'API æ•´åˆæœå‹™æ¨¡çµ„', p_api: 'ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š', status_rag: 'RAG æœå‹™ï¼šå°šæœªé€£ç·š', status_data: 'é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­', btn_save: 'å„²å­˜è¨­å®š',
        h2_guide: 'AI æ™ºèƒ½å°è¦½', p_guide: 'æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°', chat_init: '[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚', placeholder_chat: 'è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...', btn_send: 'ç™¼é€',
        h2_db: 'æ–‡åŒ–çŸ¥è­˜åº«', p_db: 'æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)', btn_import: 'â†“ åŒ¯å…¥æ–°è³‡æ–™', placeholder_search: 'æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...',
        filter_all: 'å…¨éƒ¨', filter_monument: 'å¤è¹Ÿ', filter_museum: 'åšç‰©é¤¨', filter_intangible: 'ç„¡å½¢æ–‡åŒ–',
        h2_immersive: 'æ²‰æµ¸å¼é«”é©—', p_immersive: 'å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ', tag_ar: 'AR å¯¦æ™¯é‚„åŸ', h4_anping: 'å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632', tag_vr: 'VR è™›æ“¬å±•é¤¨', h4_taipei: 'å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)',
        h2_local: 'åœ¨åœ°å³æ™‚è³‡è¨Š', p_local: 'æ•´åˆé–‹æ”¾è³‡æ–™', map_placeholder: '--- äº’å‹•åœ°åœ–è¼‰å…¥å€åŸŸ ---', bus_route: '[å¸‚å€å…¬è»Š] 77è·¯', bus_status: 'å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™ (3 åˆ†é˜)', event_name: '[ç¯€æ…¶æ´»å‹•] åºœåŸæ–‡åŒ–ç¯€', event_status: 'é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€ (è·é›¢ 1.2km)',
        h2_personal: 'å€‹äººåŒ–ä¸­å¿ƒ', p_personal: 'æ‚¨çš„æ–‡åŒ–è¶³è·¡', card_fav: 'æˆ‘çš„æ”¶è—', card_fav_p: 'æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½', card_trip: 'æˆ‘çš„è¡Œç¨‹', card_trip_p: 'æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)', card_ach: 'æˆ‘çš„æˆå°±', card_ach_p: 'å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« ',
        modal_title: 'åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', modal_label_name: 'è³‡ç”¢åç¨± (å¿…å¡«)', modal_label_location: 'åœ°é» / ç¸£å¸‚ (å¿…å¡«)', modal_label_type: 'é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)', modal_label_img: 'åœ–ç‰‡ URL (é¸å¡«)', modal_label_desc: 'ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)', modal_h4_csv: 'æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™', btn_ai_summarize: 'ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)', btn_cancel: 'å–æ¶ˆ', btn_submit: 'å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨', btn_import_csv: 'æ‰¹æ¬¡åŒ¯å…¥ CSV',
        toast_lang_switched: (isZh) => `ä»‹é¢å·²åˆ‡æ›ç‚º ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'}ï¼ˆå·²å„²å­˜ï¼‰`, toast_key_ok: 'Gemini API Key å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼æœå‹™æ ¸å¿ƒå•Ÿå‹•ã€‚', toast_key_bad: 'Gemini API Key æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚', toast_need_key: 'è«‹å…ˆåœ¨ API è¨­å®šæ¨¡çµ„ä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini Keyã€‚', toast_import_error: 'è«‹å¡«å¯«ã€Œè³‡ç”¢åç¨±ã€èˆ‡ã€Œåœ°é»ã€ã€‚', toast_import_ok: (name) => `æˆåŠŸåŒ¯å…¥è³‡ç”¢ï¼šã€Œ${name}ã€ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`, toast_ai_summarizing: 'AI æ‘˜è¦è™•ç†ä¸­...', toast_ai_summarize_ok: 'æ‘˜è¦å®Œæˆï¼å·²å›å¡«è‡³æè¿°æ¬„ä½ã€‚', toast_import_csv_error: 'CSV åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå’Œæ ¼å¼ (éœ€åŒ…å« title, location æ¬„ä½)ã€‚', toast_import_csv_ok: (count) => `æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡ç”¢ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`,
      },
      en: {
        ui_lang: 'Language:', title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
        h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
        h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
        h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: 'â†“ Import New Data', placeholder_search: 'Search: Monuments, artifacts, history...',
        filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
        h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
        h2_local: 'Local Real-Time Info', p_local: 'Open Data Integration', map_placeholder: '--- Interactive Map Loading Area ---', bus_route: '[TRANSIT] Route 77', bus_status: 'Arriving: Chikan Tower (3 min)', event_name: '[EVENT] Fucheng Culture Fest', event_status: 'Active: Confucius Temple (1.2km)',
        h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
        modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type (Monument/Museum/Intangible...)', modal_label_img: 'Image URL (Optional)', modal_label_desc: 'Brief Description (for RAG)', modal_h4_csv: 'OR: Batch Import CSV Data', btn_ai_summarize: 'ğŸ¤– AI Auto Summarize (Simulated)', btn_cancel: 'Cancel', btn_submit: 'Import Single Asset', btn_import_csv: 'Import CSV Batch',
        toast_lang_switched: (isZh) => `Language switched to ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'} (saved)`, toast_key_ok: 'Gemini API Key validated! Service core started.', toast_key_bad: 'Gemini API Key error or invalid.', toast_need_key: 'Please enter a valid Gemini Key in API settings first.', toast_import_error: 'Please fill Asset Name & Location.', toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`, toast_ai_summarizing: 'AI summarizing in progress...', toast_ai_summarize_ok: 'Summarization complete! Result filled into description.', toast_import_csv_error: 'CSV import failed. Check file and format (requires title, location columns).', toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`,
      }
    };

    const state = { lang: localStorage.getItem('lang') || 'zh-Hant', ragReady: localStorage.getItem('ragReady') === 'true', geminiKey: localStorage.getItem('geminiKey') || '', knowledge: [], filter: 'all', search: '' };

    const DEFAULT_KB = [
      { id: '1', type: 'monument', title_zh: 'èµ¤å´æ¨“', info_zh: 'å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Chikan+Tower', desc: 'èµ¤å´æ¨“å§‹å»ºæ–¼ 1653 å¹´ï¼Œç‚ºè·è˜­äººæ‰€å»ºï¼Œæ­·ç¶“æ¸…æœé‡å»ºèˆ‡æ—¥æ²»æ™‚æœŸä¿®ç¹•ï¼Œæ˜¯å°å—æœ€å…·ä»£è¡¨æ€§çš„å¤è¹Ÿä¹‹ä¸€ã€‚' },
      { id: '2', type: 'museum', title_zh: 'è¥¿é–€ç´…æ¨“', info_zh: 'å°åŒ—å¸‚ / æ­·å²å»ºç¯‰', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Red+House', desc: 'è¥¿é–€ç´…æ¨“æ˜¯ä¸€åº§å…©å±¤é«˜çš„ç´…ç£šæ´‹æ¨“ï¼Œè¦‹è­‰äº†è¥¿é–€ç”ºçš„æ­·å²ç™¼å±•ã€‚' },
      { id: '3', type: 'intangible', title_zh: 'åª½ç¥–ç¹å¢ƒ', info_zh: 'ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Mazu+Pilgrimage', desc: 'ä¸­å…ƒæ™®æ¸¡æ°‘ä¿—èˆ‡å®—æ•™æ–‡åŒ–çš„ä»£è¡¨æ´»å‹•ä¹‹ä¸€ï¼Œå¼·èª¿å°å…ˆäººæ•¬æ„èˆ‡ç¤¾ç¾¤é€£çµã€‚' }
    ];

    const ragDot = $('#rag-dot'); const ragText = $('#rag-text'); const btnSaveAPI = $('#btn-save-api'); const inputGemini = $('#gemini-api');
    const btnZh = $('#btn-zh'); const btnEn = $('#btn-en');
    const kbGrid = $('#kb-grid'); const kbTpl = $('#kb-card-tpl'); const kbSearch = $('#kb-search'); const filterButtons = $$('.filter');
    const chatBox = $('#chat'); const chatInput = $('#chat-input'); const btnSend = $('#btn-send');
    const localToggle = $('#local-toggle'); const localBody = $('#local-body'); const meToggle = $('#me-toggle'); const meBody = $('#me-body');
    const modal = $('#import-modal'); const btnImport = $('#btn-import'); const btnCloseModal = $('#btn-close-modal'); const btnCancel = $('#btn-cancel'); const importForm = $('#import-form');
    const inputName = $('#asset-name'); const inputLoc = $('#asset-location'); const inputType = $('#asset-type'); const inputImgUrl = $('#asset-img-url'); const inputDesc = $('#asset-desc'); const btnAiSummarize = $('#btn-ai-summarize'); const inputFileCsv = $('#asset-csv-file'); const btnImportCsv = $('#btn-import-csv');
    const toaster = $('#toast');

    function init(){ inputGemini.value = state.geminiKey; setRagUI(state.ragReady); applyLang(state.lang); loadKnowledge(); renderKB(); bindEvents(); if (state.ragReady){ chatBox.innerHTML=''; addBubble('ai', t('chat_init').replace('æœªå•Ÿå‹•','å·²æ–¼ä¸Šæ¬¡é€£ç·šæ™‚å•Ÿå‹•')); } arInit(); vrGuard(); }

    function t(key){ const lang = state.lang in i18n ? state.lang : 'zh-Hant'; const val = i18n[lang][key]; return (typeof val === 'function') ? key : (val ?? key); }

    function applyLang(lang){ state.lang = lang; const dict = i18n[lang] || i18n['zh-Hant'];
      $$('[data-key]').forEach(el=>{ const key = el.getAttribute('data-key'); let val = dict[key]; if (typeof val === 'function') { val = key; } if (!val) return; if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) { el.placeholder = val; } else { el.textContent = val; } });
      localStorage.setItem('lang', lang); toast(dict.toast_lang_switched(lang === 'zh-Hant'), 'success'); renderKB(); setRagUI(state.ragReady); $('#app-title').textContent = t('title'); }

    function setRagUI(ready){ if (ready){ ragDot.classList.add('ok'); ragText.textContent = (state.lang === 'zh-Hant') ? 'RAG æœå‹™ï¼šå·²é€£ç·š' : 'RAG Service: Connected'; } else { ragDot.classList.remove('ok'); ragText.textContent = t('status_rag'); } }

    function loadKnowledge(){ let custom = []; try { custom = JSON.parse(localStorage.getItem('customKnowledge') || '[]'); } catch{} custom = custom.map(a=>({ type: (a.type||'custom').toLowerCase(), ...a })); state.knowledge = [...DEFAULT_KB, ...custom]; }
    function addCustomAsset(asset){ const stored = JSON.parse(localStorage.getItem('customKnowledge') || '[]'); stored.push(asset); localStorage.setItem('customKnowledge', JSON.stringify(stored)); loadKnowledge(); renderKB(); }

    function parseCsv(csvText){
      const lines = csvText.trim().split('\n').filter(line=>line.trim()!==''); if (lines.length<=1) return null;
      const headers = lines[0].toLowerCase().split(',');
      const titleIndex = headers.indexOf('title'); const locIndex = headers.indexOf('location'); const typeIndex = headers.indexOf('type'); const descIndex = headers.indexOf('desc'); const imgIndex = headers.indexOf('img_url');
      if (titleIndex===-1 || locIndex===-1){ console.error('CSV ç¼ºå°‘å¿…éœ€çš„æ¨™é¡Œæ¬„ä½ï¼štitle, location'); return null; }
      const results=[]; for (let i=1;i<lines.length;i++){ const cols = lines[i].split(','); if (cols.length<2) continue; const asset = { id:'custom-csv-'+Date.now()+'-'+i, type:(cols[typeIndex]||'custom').trim().toLowerCase(), title_zh:(cols[titleIndex]||'').trim(), info_zh:(cols[locIndex]||'').trim(), title_en:(cols[titleIndex]||'').trim(), info_en:(cols[locIndex]||'').trim(), desc:(cols[descIndex]||'').trim(), img_url:(cols[imgIndex]||'').trim() }; if (asset.title_zh && asset.info_zh) results.push(asset); }
      return results;
    }

    function matchFilter(a){ if (state.filter==='all') return true; return (a.type||'').toLowerCase().includes(state.filter); }
    function matchSearch(a){ const q = state.search.trim().toLowerCase(); if (!q) return true; return ((a.title_zh||'').toLowerCase().includes(q) || (a.title_en||'').toLowerCase().includes(q) || (a.desc||'').toLowerCase().includes(q) || (a.info_zh||'').toLowerCase().includes(q) || (a.info_en||'').toLowerCase().includes(q)); }
    function renderKB(){ kbGrid.innerHTML=''; const lang = state.lang; const list = state.knowledge.filter(matchFilter).filter(matchSearch); const frag = document.createDocumentFragment(); list.forEach(a=>{ const node = kbTpl.content.firstElementChild.cloneNode(true); node.dataset.id=a.id; const img=$('img',node); const title=$('.title',node); const meta=$('.meta',node); const label=(lang==='zh-Hant'? (a.title_zh||a.title_en||'') : (a.title_en||a.title_zh||'')); img.loading='lazy'; img.decoding='async'; img.src = a.img_url || `https://via.placeholder.com/600x340/4a4a5a/ffffff?text=${encodeURIComponent(label.slice(0,12))}`; img.alt = label || 'asset image'; title.textContent = label; meta.textContent = (lang==='zh-Hant' ? (a.info_zh||a.info_en) : (a.info_en||a.info_zh)) || ''; frag.appendChild(node); }); kbGrid.appendChild(frag); }

    function addBubble(role,text){ const b=document.createElement('div'); b.className='bubble '+(role==='ai'?'ai':'user'); b.textContent=text; chatBox.appendChild(b); chatBox.scrollTop=chatBox.scrollHeight; }

    function simulateRAG(query){ const isZh = state.lang==='zh-Hant'; const data = state.knowledge; let found=null; const q=query.toLowerCase(); for(const a of data){ const zh = `${a.title_zh||''} ${a.info_zh||''} ${a.desc||''}`.toLowerCase(); const en = `${a.title_en||''} ${a.info_en||''} ${a.desc||''}`.toLowerCase(); if (zh.includes(q) || en.includes(q)) { found=a; break; } }
      const placeholder=document.createElement('div'); placeholder.className='bubble ai'; placeholder.textContent=isZh?'ï¼ˆRAG æª¢ç´¢ä¸­...ï¼‰':'(RAG retrieving...)'; chatBox.appendChild(placeholder); chatBox.scrollTop=chatBox.scrollHeight;
      setTimeout(()=>{ let reply; if (!state.ragReady){ reply = isZh ? 'åµæ¸¬åˆ° RAG æ ¸å¿ƒå°šæœªé€£ç·šã€‚è«‹æª¢æŸ¥æ‚¨çš„ Gemini Keyã€‚' : 'RAG core disconnected. Please check your Gemini Key.'; }
        else if (found){ const title=isZh?(found.title_zh||found.title_en):(found.title_en||found.title_zh); const info=isZh?(found.info_zh||found.info_en):(found.info_en||found.info_zh); const desc=found.desc || (isZh ? 'æ­¤è³‡ç”¢ç¼ºä¹è©³ç´°æè¿°ã€‚' : 'This asset lacks detailed description.'); reply = isZh ? `å¥½çš„ï¼Œé—œæ–¼ã€Œ${title}ã€ï¼ˆ${info}ï¼‰ï¼Œæˆ‘å€‘çš„çŸ¥è­˜åº«æœ‰ä»¥ä¸‹è³‡è¨Šï¼š\n\n${desc}` : `Yes, I found information on "${title}" (${info}):\n\n${desc}`; }
        else { reply = isZh ? 'çŸ¥è­˜åº«ä¸­æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Šã€‚æˆ–è¨±æ‚¨å¯ä»¥å˜—è©¦åŒ¯å…¥æ›´å¤šè‡ªå®šç¾©è³‡æ–™ï¼Ÿ' : "I couldn't find a match in the knowledge base. Would you like to import more custom data?"; }
        placeholder.textContent=reply; chatBox.scrollTop=chatBox.scrollHeight; }, 800);
    }

    function handleChatSend(){ const query=chatInput.value.trim(); if (!query) return; addBubble('user', query); chatInput.value=''; simulateRAG(query); }

    // ---- Geminiï¼šçœŸæ­£æ‰“ API ä¾†é©—è­‰ Key ----
    async function validateGeminiKey(key) {
      if (!key || key.length < 10) { throw new Error('EMPTY_OR_SHORT_KEY'); }
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(key)}`;
      const body = { contents: [ { role: 'user', parts: [{ text: 'ping' }] } ] };
      let resp;
      try {
        resp = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      } catch (e) {
        const isHttps = (location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1');
        if (!isHttps) throw new Error('NOT_HTTPS');
        throw new Error('NETWORK_ERROR');
      }
      if (!resp.ok) {
        let detail=''; try { detail = (await resp.json())?.error?.message || '';} catch {}
        if (resp.status === 401) throw new Error('INVALID_KEY');
        if (resp.status === 403) throw new Error('FORBIDDEN');
        if (resp.status === 429) throw new Error('RATE_LIMIT');
        throw new Error('API_ERROR:' + (detail || resp.status));
      }
      return true;
    }

    function bindEvents(){
      $('#btn-zh').addEventListener('click',()=>applyLang('zh-Hant'));
      $('#btn-en').addEventListener('click',()=>applyLang('en'));

      btnSaveAPI.addEventListener('click', async () => {
        const key = inputGemini.value.trim();
        state.geminiKey = key; state.ragReady = false;
        localStorage.setItem('geminiKey', state.geminiKey);
        localStorage.setItem('ragReady', String(state.ragReady));
        setRagUI(false);
        toast((state.lang==='zh-Hant') ? 'æ­£åœ¨é©—è­‰ Gemini Keyï¼Œè«‹ç¨å€™â€¦' : 'Validating Gemini Keyâ€¦', 'success');
        try {
          await validateGeminiKey(key);
          state.ragReady = true; localStorage.setItem('ragReady','true'); setRagUI(true);
          toast(i18n[state.lang].toast_key_ok, 'success');
          addBubble('ai', (state.lang==='zh-Hant') ? 'æœå‹™å·²å•Ÿå‹•ã€‚RAG æª¢ç´¢å°±ç·’ï¼Œè«‹é–‹å§‹æå•ï¼' : 'Service initiated. RAG retrieval is ready.');
        } catch (err) {
          let msgZh = 'é©—è­‰å¤±æ•—ï¼šæœªçŸ¥éŒ¯èª¤ã€‚', msgEn='Validation failed: Unknown error.'; const isZh=(state.lang==='zh-Hant');
          switch(String(err.message)){
            case 'EMPTY_OR_SHORT_KEY': msgZh='è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚'; msgEn='Please enter a valid Gemini API Key.'; break;
            case 'NOT_HTTPS': msgZh='éœ€è¦åœ¨ HTTPS æˆ– localhost ç’°å¢ƒä¸‹åŸ·è¡Œï¼Œè«‹æ”¹ç”¨ https:// æˆ–æœ¬æ©Ÿä¼ºæœå™¨ã€‚'; msgEn='This page must run on HTTPS or localhost.'; break;
            case 'NETWORK_ERROR': msgZh='ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç€è¦½å™¨å°é–ã€‚'; msgEn='Network request failed. Check your connection or browser blocking.'; break;
            case 'INVALID_KEY': msgZh='Gemini API Key ç„¡æ•ˆæˆ–æœªæˆæ¬Šï¼Œè«‹æ–¼ Google AI Studio é‡æ–°ç”¢ç”Ÿã€‚'; msgEn='Invalid/unauthorized Gemini API Key.'; break;
            case 'FORBIDDEN': msgZh='è¢«æ‹’çµ•å­˜å–ï¼šè«‹ç¢ºèª API Key çš„ã€ŒHTTP åƒç…§ä¾†æºï¼ˆreferrerï¼‰ã€é™åˆ¶èˆ‡ç¶²åŸŸç›¸ç¬¦ï¼Œæˆ–æª¢æŸ¥é…é¡/æ¬Šé™ã€‚'; msgEn='Access forbidden: check key referrer restrictions and quotas.'; break;
            case 'RATE_LIMIT': msgZh='å·²è¶…å‡ºé€Ÿç‡æˆ–é…é¡é™åˆ¶ï¼Œç¨å¾Œå†è©¦æˆ–èª¿æ•´é…é¡ã€‚'; msgEn='Rate limit or quota exceeded.'; break;
            default:
              if (String(err.message).startsWith('API_ERROR:')){
                const detail = String(err.message).replace('API_ERROR:','');
                msgZh = `API å›æ‡‰éŒ¯èª¤ï¼š${detail}`; msgEn = `API error: ${detail}`;
              }
          }
          state.ragReady=false; localStorage.setItem('ragReady','false'); setRagUI(false);
          toast(isZh?msgZh:msgEn,'error');
        }
      });

      btnSend.addEventListener('click', handleChatSend);
      chatInput.addEventListener('keypress', e=>{ if (e.key==='Enter') handleChatSend(); });
      kbSearch.addEventListener('input', e=>{ state.search=e.target.value; renderKB(); });
      filterButtons.forEach(btn=>{ btn.addEventListener('click', e=>{ $$('.filter').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); state.filter = e.target.dataset.filter; renderKB(); }); });
      btnImport.addEventListener('click', ()=> modal.showModal()); [btnCloseModal, btnCancel].forEach(btn=>btn.addEventListener('click', ()=> modal.close()));
      importForm.addEventListener('submit', handleSingleImport);
      btnAiSummarize.addEventListener('click', ()=>{ if (!state.ragReady){ toast(i18n[state.lang].toast_need_key, 'error'); return; } const longText=inputDesc.value.trim(); if (longText.length<50){ toast(state.lang==='zh-Hant' ? 'è«‹è¼¸å…¥æ›´å¤šæ–‡æœ¬ä»¥ä¾› AI æ‘˜è¦ã€‚' : 'Please input more text for AI to summarize.', 'error'); return; } toast(i18n[state.lang].toast_ai_summarizing, 'success'); setTimeout(()=>{ const isZh=state.lang==='zh-Hant'; const summaryLoc=inputLoc.value.trim() || (isZh ? 'è©²åœ°é»' : 'the location'); const summaryType=inputType.value.trim() || (isZh ? 'æ–‡åŒ–è³‡ç”¢' : 'cultural asset'); const simulatedSummary = isZh ? `[AI æ‘˜è¦æ¨¡æ“¬] æ­¤æ–‡ç‰©çš„æ ¸å¿ƒåƒ¹å€¼å·²æ¿ƒç¸®ï¼šå®ƒåè½æ–¼${summaryLoc}ï¼Œå±¬æ–¼${summaryType}é¡å‹ï¼Œæ­·å²æ„ç¾©é‡å¤§ï¼Œæ˜¯ç•¶åœ°ç¤¾å€çš„æ–‡åŒ–ç„¦é»ã€‚` : `[AI Summary] The core value of this asset is summarized: Located in ${summaryLoc}, this ${summaryType} holds great historical significance and serves as a cultural focal point for the local community.`; inputDesc.value=simulatedSummary; toast(i18n[state.lang].toast_ai_summarize_ok, 'success'); }, 800); });
      btnImportCsv.addEventListener('click', ()=>{ const file=inputFileCsv.files[0]; if (!file){ toast(state.lang==='zh-Hant' ? 'è«‹é¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆã€‚' : 'Please select a CSV file.', 'error'); return; } const reader=new FileReader(); reader.onload=function(e){ const csvText=e.target.result; const newAssets=parseCsv(csvText); if (!newAssets || newAssets.length===0){ toast(i18n[state.lang].toast_import_csv_error, 'error'); return; } const stored=JSON.parse(localStorage.getItem('customKnowledge')||'[]'); stored.push(...newAssets); localStorage.setItem('customKnowledge', JSON.stringify(stored)); loadKnowledge(); renderKB(); toast(i18n[state.lang].toast_import_csv_ok(newAssets.length), 'success'); inputFileCsv.value=null; modal.close(); }; reader.onerror=()=>{ toast(state.lang==='zh-Hant' ? 'è®€å–æª”æ¡ˆå¤±æ•—ã€‚' : 'Failed to read file.', 'error'); }; reader.readAsText(file); });
      localToggle.addEventListener('click', ()=>toggleCollapsible(localBody, localToggle)); meToggle.addEventListener('click', ()=>toggleCollapsible(meBody, meToggle));
    }

    function handleSingleImport(e){ e.preventDefault(); const name=inputName.value.trim(); const loc=inputLoc.value.trim(); if (!name || !loc){ toast(i18n[state.lang].toast_import_error, 'error'); return; } const imgUrl=inputImgUrl.value.trim(); const asset={ id:'custom-'+Date.now(), type:(inputType.value.trim()||'custom').toLowerCase(), title_zh:name, info_zh:loc, title_en:name, info_en:loc, desc:inputDesc.value.trim(), img_url:imgUrl }; addCustomAsset(asset); toast(i18n[state.lang].toast_import_ok(name), 'success'); inputName.value=''; inputLoc.value=''; inputType.value=''; inputDesc.value=''; inputImgUrl.value=''; inputFileCsv.value=null; modal.close(); }

    function toggleCollapsible(body, header){ const isHidden=body.hidden; body.hidden=!isHidden; header.setAttribute('aria-expanded', isHidden); const caret=$('.caret', header); if (caret) caret.textContent = isHidden ? 'â–¼' : 'â–²'; }
    function toast(message, type='default'){ toaster.textContent=message; toaster.className='toast show '+type; clearTimeout(toaster.timer); toaster.timer=setTimeout(()=>{ toaster.classList.remove('show'); }, 3000); }

    function arInit(){ const mv = document.getElementById('mv-anping'); if (!mv) return; mv.addEventListener('load', ()=> toast('3D æ¨¡å‹å·²è¼‰å…¥ï¼Œå¯æ—‹è½‰ç¸®æ”¾é è¦½ã€‚','success')); mv.addEventListener('ar-status', (e)=>{ const s=e.detail && e.detail.status; if (s==='session-started') toast('AR å·²å•Ÿå‹•ï¼Œè«‹åœ¨åœ°é¢ä¸Šç§»å‹•è£ç½®ä»¥åµæ¸¬å¹³é¢ã€‚','success'); if (s==='not-presenting') toast('å·²é€€å‡º AR æ¨¡å¼ã€‚','default'); }); mv.addEventListener('ar-tracking',(e)=>{ if (e.detail && e.detail.status==='not-tracking') toast('è¿½è¹¤ä¸ç©©ï¼Œè«‹ç§»è‡³å…‰ç·šå……è¶³å€åŸŸã€‚','error'); }); mv.addEventListener('error', (e)=> toast('AR/3D éŒ¯èª¤ï¼š'+(e.message||'æœªçŸ¥'), 'error')); mv.addEventListener('click', ev=>{ const btn=ev.composedPath && ev.composedPath().find(n=>n && n.classList && n.classList.contains('hotspot')); if (btn && btn.dataset.anno) toast(btn.dataset.anno,'success'); }); }

    function vrGuard(){ const vrCard=document.querySelector('.vr-card'); if (!vrCard) return; const wrap=vrCard.querySelector('.vr-wrap'); const isSecure= location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1'; if (!isSecure){ return vrFallback('éœ€è¦åœ¨ HTTPS æˆ– localhost åŸ·è¡Œï¼ˆç›®å‰ç‚º '+location.protocol+'ï¼‰ã€‚'); } if (!window.AFRAME){ return vrFallback('A-Frame è¼‰å…¥å¤±æ•—æˆ–è¢«é˜»æ“‹ã€‚'); }
      try { const scene=vrCard.querySelector('a-scene'); if (!scene) throw new Error('æ‰¾ä¸åˆ° a-scene'); scene.addEventListener('error', e=> vrFallback('æ¸²æŸ“å™¨éŒ¯èª¤')); } catch(err){ vrFallback(err.message||String(err)); }
      function vrFallback(reason){ if (!wrap) return; wrap.innerHTML = `<div style="display:grid;place-items:center;height:100%;padding:1rem;text-align:center">
          <img src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" alt="360 éœæ…‹é è¦½" style="max-width:100%;max-height:100%;object-fit:cover;border-radius:12px"/>
          <p style="color:#9ab;line-height:1.4;margin:.6rem 0 0">VR æ¨¡çµ„æœªå•Ÿå‹•ï¼š${reason}<br/>è«‹æ”¹ç”¨ HTTPS ç’°å¢ƒã€æˆ–ä»¥æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿã€‚</p>
        </div>`; toast('VR è™›æ“¬å±•é¤¨æœªå•Ÿå‹•ï¼š'+reason,'error'); }
    }

    init();
  })();
  </script>
</body>
</html>
