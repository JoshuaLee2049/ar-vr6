<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>文化智遊 - AI 科技儀表板（AR/VR整合版 v5 - Gemini抽取）</title>
    <meta name="color-scheme" content="dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* CSS 變數 */
        :root { --bg:#070718; --bg-grad-a:rgba(0,255,255,.1); --bg-grad-b:rgba(187,0,255,.1);
          --pri:#00ffff; --sec:#bb00ff; --text:#e6f7ff; --muted:#8090a0; --glass:rgba(0,0,0,.7);
          --glass-border:rgba(255,255,255,.06); --glow-pri:0 0 15px rgba(0,255,255,.4), 0 0 5px rgba(0,255,255,.18);
          --glow-sec:0 0 15px rgba(187,0,255,.4), 0 0 5px rgba(187,0,255,.18); --ok:#4aff8f; --bad:#ff4a4a;
          --radius:18px; --radius-sm:10px; --shadow-deep:0 0 30px rgba(0,0,0,.7), 0 0 20px rgba(0,255,255,.05), 0 0 40px rgba(187,0,255,.08); --space:clamp(.75rem, .75rem + 1.2vw, 2rem); }
        /* 基本樣式 */
        *{box-sizing:border-box} html,body{height:100%}
        body{margin:0;font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
          background:radial-gradient(circle at 15% 15%, var(--bg-grad-a), transparent 30%), radial-gradient(circle at 85% 75%, var(--bg-grad-b), transparent 35%), linear-gradient(135deg,#070718 0%,#030018 100%);
          background-color:var(--bg); padding:clamp(1rem,3vw,2.5rem)}
        :focus-visible{outline:2px solid var(--pri); outline-offset:2px; border-radius:8px}
        @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}
        /* 版面、面板、元件樣式 */
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(1rem,2vw,2rem)}
        @media (max-width:960px){.grid{grid-template-columns:1fr}}
        .panel{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:var(--shadow-deep);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:calc(var(--space)*1.1);transition:transform .25s ease,box-shadow .25s ease}
        .panel:hover{transform:translateY(-2px);box-shadow:var(--glow-pri)}
        .module-header{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem}
        .module-header h2{margin:0;font-size:clamp(1.1rem,1rem + .8vw,1.5rem);color:var(--pri);text-shadow:0 0 6px rgba(0,255,255,.28)}
        .module-sub{margin:0;color:var(--muted);font-size:.95rem}
        .chip{display:inline-flex;align-items:center;gap:.4rem;font-family:'Orbitron',monospace;font-weight:700;background:linear-gradient(45deg,var(--pri),var(--sec));color:#091018;border-radius:var(--radius-sm);padding:.35rem .6rem;letter-spacing:.5px}
        .btn{cursor:pointer;border:1.5px solid var(--pri);background:rgba(0,255,255,.06);color:var(--pri);border-radius:var(--radius-sm);padding:.55rem .9rem;font-size:.95rem;transition:.2s ease}
        .btn:hover:not(:disabled){box-shadow:var(--glow-pri);transform:translateY(-1px)}
        .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
        .btn.primary{background:linear-gradient(90deg,var(--pri),#00aaff);color:#081018;border-color:transparent}
        .input,textarea.input{width:100%;background:rgba(0,0,0,.4);color:var(--text);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:.65rem .8rem;font-size:.95rem}
        .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
        .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-12{grid-column:span 12}
        @media (max-width:960px){.col-6,.col-4{grid-column:span 12}}
        header.header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:var(--space)}
        .nav{display:flex;gap:.8rem;flex-wrap:wrap}
        .nav a{color:var(--muted);text-decoration:none;padding:.4rem .6rem;border-radius:8px}
        .nav a.active,.nav a:hover{background:rgba(0,255,255,.08);color:var(--text)}
        /* 知識庫 */
        .kb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        @media (max-width:1200px){.kb-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:720px){.kb-grid{grid-template-columns:1fr}}
        .kb-card{overflow:hidden;border-radius:16px;border:1px solid var(--glass-border);background:rgba(255,255,255,.02); transition: border-color .2s; cursor: pointer;}
        .kb-card:hover{border-color: var(--pri)}
        .kb-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .kb-card .content{padding:.8rem .9rem}
        .kb-card h4{margin:0 0 .25rem 0;font-size:1.05rem}
        .filters{display:flex;gap:.6rem;flex-wrap:wrap}
        .filter{padding:.35rem .6rem;border:1px solid var(--glass-border);border-radius:999px;color:var(--muted);cursor:pointer}
        .filter.active{border-color:var(--pri);color:var(--text);box-shadow:var(--glow-pri)}
        /* 聊天室 */
        .chat{display:flex;flex-direction:column;gap:.6rem;height:clamp(220px,35vh,360px);overflow:auto;background:rgba(255,255,255,.02);border-radius:12px;padding:.8rem;border:1px solid var(--glass-border)}
        .bubble{max-width:88%;padding:.6rem .8rem;border-radius:14px; white-space: pre-wrap; word-wrap: break-word;}
        .bubble.ai{background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.2)}
        .bubble.user{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);margin-left:auto}
        .chat-input{display:flex;gap:.5rem;margin-top:.6rem}
        .chat-input .mic{width:2.25rem}
        .status{display:inline-flex;align-items:center;gap:.4rem;font-size:.92rem;color:var(--muted)}
        .dot{width:.55rem;height:.55rem;border-radius:50%;background:#666;box-shadow:inset 0 0 0 2px rgba(0,0,0,.3)}
        .dot.ok{background:var(--ok)}
        /* AR/VR 體驗 */
        .xp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
        @media (max-width:960px){.xp-grid{grid-template-columns:1fr}}
        .xp-card{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--glass-border)}
        .xp-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .xp-overlay{position:absolute;inset:auto 0 0 0;padding:.9rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65))}
        .tag{display:inline-block;padding:.3rem .5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;margin-bottom:.4rem}
        .ar-card model-viewer{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15)}
        .hotspot{--size:14px;width:var(--size);height:var(--size);border-radius:999px;border:2px solid rgba(255,255,255,.9);background:rgba(0,255,255,.9);box-shadow:var(--glow-pri); cursor: pointer;}
        .annotation{position:absolute;transform:translate(-50%,calc(-100% - 10px));padding:.35rem .55rem;background:rgba(0,0,0,.75);border:1px solid var(--glass-border);border-radius:8px;color:#e6f7ff;font-size:.85rem;white-space:nowrap;pointer-events:none; display:none;}
        .vr-card .vr-wrap{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden}
        .vr-card .vr-wrap a-scene{width:100%;height:100%; display:block}
        /* 摺疊與模態框 */
        .collapsible{cursor:pointer;position:relative}
        .collapsible .caret{margin-left:auto;font-size:.9rem;opacity:.9}
        .section-body{margin-top:.6rem;display:block}
        .section-body[hidden]{display:none}
        .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.82);backdrop-filter:blur(5px);z-index:1000}
        .modal[open]{display:grid}
        .modal-card{width:min(600px,92vw);background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:1.1rem;box-shadow:var(--glow-pri)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding-bottom:.6rem;border-bottom:2px solid var(--sec)}
        .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}
        /* Toast 提示 */
        .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) translateY(120%);background:rgba(0,0,0,.85);color:#fff;padding:.6rem .9rem;border-radius:10px;border:1px solid var(--glass-border);transition:transform .28s ease;z-index:1200;white-space:pre-wrap}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{box-shadow:0 0 0 2px rgba(74,255,143,.2)}
        .toast.error{box-shadow:0 0 0 2px rgba(255,74,74,.2)}
        /* 地圖元件專屬樣式 */
        #local-map {
          height: 300px;
          border: 1px solid var(--glass-border); 
          border-radius: 12px;
          margin-bottom: .8rem;
        }
        .leaflet-container { /* 讓 Leaflet 容器適應暗色主題 */
            background-color: var(--bg);
            border-radius: 12px;
        }
    </style>
    
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="lang-switch" style="display:flex; gap:.5rem; align-items:center; margin-bottom:.6rem;">
        <span style="color:var(--text); font-size:.9rem" data-key="ui_lang">介面語言:</span>
        <button class="btn" data-lang="zh-Hant" id="btn-zh">繁體中文</button>
        <button class="btn" data-lang="en" id="btn-en">English</button>
    </div>

    <header class="header" role="banner">
        <h1 id="app-title" data-key="title">文化智遊儀表板</h1>
        <nav class="nav" aria-label="主要導覽">
            <a href="#section-guide" class="active" data-key="nav_guide">導覽</a>
            <a href="#section-kb" data-key="nav_knowledge">知識庫</a>
            <a href="#section-xp" data-key="nav_experience">體驗</a>
            <a href="#section-me" data-key="nav_personal">個人中心</a>
        </nav>
    </header>

    <main class="grid" role="main" aria-live="polite">
        <section class="panel col-12" aria-labelledby="api-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>API</span></div>
                <h2 id="api-h2" data-key="h2_api">API 整合服務模組</h2>
            </div>
            <p class="module-sub" data-key="p_api">系統服務狀態與金鑰設定</p>
            <div class="row" style="margin-top:.6rem">
                <div class="col-12" style="grid-column: span 12;">
                    <label for="gemini-api" class="sr">Gemini API Key</label>
                    <input id="gemini-api" class="input" type="password" placeholder="Gemini API Key" autocomplete="off" />
                </div>
            </div>
            <div style="display:flex; gap:.8rem; align-items:center; justify-content:flex-end; margin-top:.8rem">
                <span class="status"><span id="rag-dot" class="dot" aria-hidden="true"></span><span id="rag-text" data-key="status_rag">RAG 服務：尚未連線</span></span>
                <span class="status"><span class="dot ok" aria-hidden="true"></span><span data-key="status_data">開放資料：同步中</span></span>
                <button id="btn-save-api" class="btn primary" data-key="btn_save" type="button">儲存設定</button>
            </div>
        </section>

        <section id="section-guide" class="panel col-12" aria-labelledby="guide-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AI</span></div>
                <h2 id="guide-h2" data-key="h2_guide">AI 智能導覽</h2>
            </div>
            <p class="module-sub" data-key="p_guide">您的隨身文化嚮導</p>
            <div id="chat" class="chat" aria-live="polite" aria-label="聊天視窗">
                <div class="bubble ai" data-key="chat_init">[系統初始化] 檢測到 RAG 核心未啟動。請在上方輸入您的 Gemini Key 以連線文化知識庫。</div>
            </div>
            <div class="chat-input">
                <button class="btn mic" type="button" aria-label="語音輸入" disabled>🎤</button>
                <input id="chat-input" class="input" type="text" data-key="placeholder_chat" placeholder="輸入您的文化問題或導覽需求..." />
                <button id="btn-send" class="btn primary" type="button" data-key="btn_send">發送</button>
            </div>
        </section>

        <section id="section-kb" class="panel col-12" aria-labelledby="kb-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>DB</span></div>
                <h2 id="kb-h2" data-key="h2_db">文化知識庫</h2>
                <button id="btn-auto-fetch" class="btn" type="button" data-key="btn_auto_fetch">🤖 AI 自動爬取資料</button>
                <button id="btn-import" class="btn" type="button" data-key="btn_import">↓ 匯入新資料</button>
            </div>
            <p class="module-sub" data-key="p_db">探索全台文化資產 (RAG 資料源)</p>
            <div class="row" style="margin:.6rem 0 .8rem 0; align-items:center">
                <div class="col-6"><input id="kb-search" class="input" type="text" data-key="placeholder_search" placeholder="搜尋古蹟、文物、歷史事件..." /></div>
                <div class="col-6" style="display:flex; justify-content:flex-end"><div id="filter-controls" class="filters" role="tablist" aria-label="類型篩選">
                    <button class="filter active" data-filter="all" data-key="filter_all" role="tab" aria-selected="true">全部</button>
                    <button class="filter" data-filter="monument" data-key="filter_monument" role="tab">古蹟</button>
                    <button class="filter" data-filter="museum" data-key="filter_museum" role="tab">博物館</button>
                    <button class="filter" data-filter="intangible" data-key="filter_intangible" role="tab">無形文化</button>
                </div></div>
            </div>
            <div id="kb-grid" class="kb-grid" aria-live="polite"></div>
        </section>

        <section id="section-xp" class="panel col-12" aria-labelledby="xp-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AR</span></div>
                <h2 id="xp-h2" data-key="h2_immersive">沉浸式體驗</h2>
            </div>
            <p class="module-sub" data-key="p_immersive">啟動您的時光機</p>
            <div class="xp-grid">
                <article class="xp-card ar-card" aria-label="AR 實景：安平古堡（示意模型）">
                    <model-viewer id="mv-anping"
                        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
                        alt="安平古堡示意 3D 模型"
                        ar ar-modes="webxr scene-viewer quick-look"
                        ar-scale="auto" ar-placement="floor"
                        camera-controls camera-orbit="0deg 75deg 2.2m" field-of-view="30deg"
                        environment-image="neutral" shadow-intensity="1" exposure="1"
                        interaction-prompt="auto"
                        poster="https://via.placeholder.com/800x520/331144/cccccc?text=Tap+to+Load+AR"
                        aria-label="啟動 AR 檢視">
                        <button class="hotspot" slot="hotspot-gate" data-position="0.15m 1.2m 0.2m" data-normal="0 1 0" data-anno="城門：清領時期修築"></button>
                        <div class="annotation" slot="annotation-gate">城門：清領時期修築</div>
                        <button class="hotspot" slot="hotspot-battery" data-position="-0.25m 0.9m 0.1m" data-normal="0 1 0" data-anno="砲台：荷治軍事設施"></button>
                        <div class="annotation" slot="annotation-battery">砲台：荷治軍事設施</div>
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">在實境中查看</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_ar">AR 實景還原</span>
                        <h4 style="margin:.2rem 0" data-key="h4_anping">安平古堡：熱蘭遮城 1632（AR 示意）</h4>
                    </div>
                </article>

                <article class="xp-card ar-card" aria-label="AR 實景：台北城牆（示意模型）">
                    <model-viewer
                        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
                        alt="台北城牆示意 3D 模型"
                        ar ar-modes="webxr scene-viewer quick-look"
                        camera-controls environment-image="neutral" shadow-intensity="1"
                        poster="https://via.placeholder.com/800x520/113333/cccccc?text=Tap+to+Load+AR"
                        aria-label="啟動 AR 檢視">
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">在實境中查看</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_vr">VR / AR 體驗</span>
                        <h4 style="margin:.2rem 0" data-key="h4_taipei">已消失的台北城牆（AR 示意）</h4>
                    </div>
                </article>

                <article class="xp-card vr-card" aria-label="VR 虛擬展館：360 全景示意">
                    <div class="vr-wrap">
                        <a-scene embedded background="color: #000" vr-mode-ui="enabled: false">
                            <a-assets>
                                <img id="pano" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" />
                            </a-assets>
                            <a-sky src="#pano"></a-sky>
                            <a-entity position="0 1.6 0">
                                <a-camera wasd-controls-enabled="false"></a-camera>
                            </a-entity>
                        </a-scene>
                    </div>
                    <div class="xp-overlay">
                        <span class="tag">VR 虛擬展館</span>
                        <h4 style="margin:.2rem 0">已消失的台北城牆（360° 虛擬展館示意）</h4>
                    </div>
                </article>
            </div>
        </section>

        <section class="panel col-12" aria-labelledby="local-h2">
            <div id="local-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>GPS</span></div>
                <h2 id="local-h2" data-key="h2_local">在地即時資訊</h2>
                <span class="module-sub" data-key="p_local">整合開放資料 / 實時追蹤</span>
                <span class="caret" aria-hidden="true">▼</span>
            </div>
            <div id="local-body" class="section-body">
                <div id="local-map" role="region" aria-label="在地即時資訊地圖"></div>
                
                <ul id="local-data-list" style="list-style:none; padding:0; margin:0; display:grid; gap:.6rem">
                    <li style="text-align:center; color:var(--muted)">請允許地理定位以載入在地即時資訊...</li>
                </ul>
            </div>
        </section>

        <section id="section-me" class="panel col-12" aria-labelledby="me-h2">
            <div id="me-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>USR</span></div>
                <h2 id="me-h2" data-key="h2_personal">個人化中心</h2>
                <span class="module-sub" data-key="p_personal">您的文化足跡</span>
                <span class="caret" aria-hidden="true">▼</span>
            </div>
            <div id="me-body" class="section-body">
                <div class="kb-grid">
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">♥</div>
                        <div><h4 data-key="card_fav">我的收藏</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_fav_p">您已收藏 12 個景點與 3 篇導覽</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">✈</div>
                        <div><h4 data-key="card_trip">我的行程</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_trip_p">您有 1 個即將到來的行程 (台南三日遊)</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">☆</div>
                        <div><h4 data-key="card_ach">我的成就</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_ach_p">已解鎖「府城探索者」徽章</p></div>
                    </div></div>
                </div>
            </div>
        </section>
    </main>

    <dialog id="import-modal" class="modal" aria-labelledby="import-title" aria-modal="true">
        <div class="modal-card" role="document">
            <div class="modal-head">
                <h3 id="import-title" data-key="modal_title">匯入自定義文化資產</h3>
                <button id="btn-close-modal" class="btn" type="button" aria-label="關閉">✕</button>
            </div>
            <form id="import-form" method="dialog">
                <div class="row" style="margin-top:.6rem">
                    <div class="col-12"><label for="asset-name" data-key="modal_label_name">資產名稱 (必填)</label><input id="asset-name" class="input" required /></div>
                    <div class="col-6"><label for="asset-location" data-key="modal_label_location">地點 / 縣市 (必填)</label><input id="asset-location" class="input" required /></div>
                    <div class="col-6"><label for="asset-type" data-key="modal_label_type">類型 (古蹟/博物館/無形文化...)</label><input id="asset-type" class="input" /></div>
                    <div class="col-12"><label for="asset-img-url" data-key="modal_label_img">圖片 URL (選填)</label><input id="asset-img-url" class="input" type="url" placeholder="https://..." /></div>
                    <div class="col-12">
                        <label for="asset-desc" data-key="modal_label_desc">簡要描述 (用於 AI 導覽 RAG)</label>
                        <textarea id="asset-desc" class="input" rows="4"></textarea>
                        <button id="btn-ai-summarize" class="btn" type="button" style="margin-top:.5rem;" data-key="btn_ai_summarize">🤖 AI 自動摘要 (模擬)</button>
                    </div>
                    <div class="col-12" style="margin-top:1rem; border-top: 1px dashed var(--glass-border); padding-top: 1rem;">
                        <h4 style="margin:0 0 .5rem 0; color:var(--pri)" data-key="modal_h4_csv">或：批次匯入 CSV 資料</h4>
                        <input id="asset-csv-file" type="file" accept=".csv" class="input" style="padding: .5rem;" />
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel" data-key="btn_cancel">取消</button>
                    <button class="btn primary" type="submit" id="btn-submit" data-key="btn_submit">單筆匯入並啟用</button>
                    <button class="btn" type="button" id="btn-import-csv" data-key="btn_import_csv">批次匯入 CSV</button>
                </div>
            </form>
        </div>
    </dialog>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <template id="kb-card-tpl">
        <article class="kb-card" data-id="">
            <img src="" alt="" />
            <div class="content">
                <h4 class="title"></h4>
                <p class="meta" style="margin:.2rem 0; color:var(--muted)"></p>
            </div>
        </article>
    </template>

    <script>
    (function(){
        'use strict';
        // 常用 DOM 選擇器
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // ----------------------------------------------------------------------
        // *** 1. Google Search Tool 替身 (Polyfill for Function Calling) ***
        // ----------------------------------------------------------------------
        /**
         * 模擬 Google 搜尋 Function Calling 的函式。
         * 在前端環境下，它返回一組固定的模擬搜尋結果。
         */
        const google = {
            search: async ({ queries }) => {
                console.warn("⚠️ Google Search Tool 模擬執行中，返回預設資料。");

                // 模擬網路延遲
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                return {
                    results: [
                        {
                            snippet: "文化部宣布最新修復完成的國定古蹟：臺南神農街舊宅群，強調其對臺灣早期商業歷史的重要性。新的開放時間與導覽資訊已發布。",
                            source_title: "文化部新聞稿：臺南神農街舊宅群修復竣工",
                            url: "https://www.moc.gov.tw/latest-news"
                        },
                        {
                            snippet: "2025年國際博物館日，國立故宮博物院將推出一系列數位沉浸式體驗，特別是針對宋代繪畫的 4K 數位重建，提供觀眾全新的觀賞角度。",
                            source_title: "故宮博物院：國際博物館日活動資訊",
                            url: "https://www.npm.gov.tw/events"
                        },
                        {
                            snippet: "台灣重要的無形文化資產「東港迎王平安祭典」，被列為今年文化觀光推廣重點。交通部觀光署提供詳細的交通與住宿指引。",
                            source_title: "觀光署：東港迎王祭典指引",
                            url: "https://www.twa.gov.tw/travel-guides"
                        },
                        {
                            snippet: "最新的考古發現：在高雄鳳山發現了清朝早期軍事防禦工事的遺跡，目前已暫定為市定歷史遺址，未來將進行進一步研究與保護。",
                            source_title: "高雄市政府文化局：鳳山遺址最新公告",
                            url: "https://www.kcg.gov.tw/culture-news"
                        }
                    ]
                };
            }
        };
        // ----------------------------------------------------------------------


        // 多語言/國際化設定 (i18n)
        const i18n = {
            'zh-Hant': {
                ui_lang: '介面語言:', title: '文化智遊儀表板', nav_guide: '導覽', nav_knowledge: '知識庫', nav_experience: '體驗', nav_personal: '個人中心',
                h2_api: 'API 整合服務模組', p_api: '系統服務狀態與金鑰設定', status_rag: 'RAG 服務：尚未連線', status_data: '開放資料：同步中', btn_save: '儲存設定',
                h2_guide: 'AI 智能導覽', p_guide: '您的隨身文化嚮導', chat_init: '[系統初始化] 檢測到 RAG 核心未啟動。請在上方輸入您的 Gemini Key 以連線文化知識庫。', placeholder_chat: '輸入您的文化問題或導覽需求...', btn_send: '發送',
                h2_db: '文化知識庫', p_db: '探索全台文化資產 (RAG 資料源)', btn_import: '↓ 匯入新資料', btn_auto_fetch: '🤖 AI 自動爬取資料', placeholder_search: '搜尋古蹟、文物、歷史事件...',
                filter_all: '全部', filter_monument: '古蹟', filter_museum: '博物館', filter_intangible: '無形文化',
                h2_immersive: '沉浸式體驗', p_immersive: '啟動您的時光機', tag_ar: 'AR 實景還原', h4_anping: '安平古堡：熱蘭遮城 1632', tag_vr: 'VR 虛擬展館', h4_taipei: '已消失的台北城牆 (數位重建)',
                h2_local: '在地即時資訊', p_local: '整合開放資料 / 實時追蹤', bus_route: '77路 公車', bus_status: '即將抵達：赤崁樓站', event_name: '府城文化節', event_status: '進行中：孔廟園區',
                h2_personal: '個人化中心', p_personal: '您的文化足跡', card_fav: '我的收藏', card_fav_p: '您已收藏 12 個景點與 3 篇導覽', card_trip: '我的行程', card_trip_p: '您有 1 個即將到來的行程 (台南三日遊)', card_ach: '我的成就', card_ach_p: '已解鎖「府城探索者」徽章',
                modal_title: '匯入自定義文化資產', modal_label_name: '資產名稱 (必填)', modal_label_location: '地點 / 縣市 (必填)', modal_label_type: '類型 (古蹟/博物館/無形文化...)', modal_label_img: '圖片 URL (選填)', modal_label_desc: '簡要描述 (用於 AI 導覽 RAG)', modal_h4_csv: '或：批次匯入 CSV 資料', btn_ai_summarize: '🤖 AI 自動摘要 (模擬)', btn_cancel: '取消', btn_submit: '單筆匯入並啟用', btn_import_csv: '批次匯入 CSV',
                toast_lang_switched: (isZh) => `介面已切換為 ${isZh ? '繁體中文' : 'English'}（已儲存）`, toast_key_ok: 'Gemini API Key 儲存並驗證成功！服務核心啟動。', toast_key_bad: 'Gemini API Key 格式錯誤或無效。', toast_need_key: '請先在 API 設定模組中輸入有效的 Gemini Key。', toast_import_error: '請填寫「資產名稱」與「地點」。', toast_import_ok: (name) => `成功匯入資產：「${name}」。已加入 RAG 資料源。`, toast_ai_summarizing: 'AI 摘要處理中...', toast_ai_summarize_ok: '摘要完成！已回填至描述欄位。', toast_import_csv_error: 'CSV 匯入失敗，請檢查檔案和格式 (需包含 title, location 欄位)。', toast_import_csv_ok: (count) => `成功匯入 ${count} 筆資產。已加入 RAG 資料源。`, toast_network_error: '連線失敗，請檢查網路。', user_location: '您的目前位置',
                toast_fetching_ai: '正在啟動 Gemini AI，從網路資訊源抽取並結構化文化資產資料...',
                toast_fetch_ok_ai: (count) => `✅ 成功利用 AI 抽取 ${count} 筆網路資料，已更新 RAG 知識庫。`,
                toast_fetch_error_ai: 'AI 自動爬取並抽取資料失敗，請檢查 Gemini Key 或 API 限制。',
            },
            en: {
                ui_lang: 'Language:', title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: '↓ Import New Data', btn_auto_fetch: '🤖 AI Auto Fetch Data', placeholder_search: 'Search: Monuments, artifacts, history...',
                filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                h2_local: 'Local Real-Time Info', p_local: 'Open Data / Real-time Tracking', bus_route: 'Bus Route 77', bus_status: 'Arriving: Chikan Tower Stop', event_name: 'Fucheng Culture Fest', event_status: 'Active: Confucius Temple Area',
                h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
                modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type (Monument/Museum/Intangible...)', modal_label_img: 'Image URL (Optional)', modal_label_desc: 'Brief Description (for RAG)', modal_h4_csv: 'OR: Batch Import CSV Data', btn_ai_summarize: '🤖 AI Auto Summarize (Simulated)', btn_cancel: 'Cancel', btn_submit: 'Import Single Asset', btn_import_csv: 'Import CSV Batch',
                toast_lang_switched: (isZh) => `Language switched to ${isZh ? '繁體中文' : 'English'} (saved)`, toast_key_ok: 'Gemini API Key validated! Service core started.', toast_key_bad: 'Gemini API Key error or invalid.', toast_need_key: 'Please enter a valid Gemini Key in API settings first.', toast_import_error: 'Please fill Asset Name & Location.', toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`, toast_ai_summarizing: 'AI summarizing in progress...', toast_ai_summarize_ok: 'Summarization complete! Result filled into description.', toast_import_csv_error: 'CSV import failed. Check file and format (requires title, location columns).', toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`, toast_network_error: 'Connection failed, please check network.', user_location: 'Your Current Location',
                toast_fetching_ai: 'Activating Gemini AI to extract and structure cultural assets from web sources...',
                toast_fetch_ok_ai: (count) => `✅ AI successfully extracted ${count} items. RAG knowledge base updated.`,
                toast_fetch_error_ai: 'AI data fetching and extraction failed. Check Gemini Key or API limits.',
            }
        };

        // 應用程式狀態管理
        const state = { 
            lang: localStorage.getItem('lang') || 'zh-Hant', 
            ragReady: localStorage.getItem('ragReady') === 'true', 
            geminiKey: localStorage.getItem('geminiKey') || '', 
            knowledge: [], 
            filter: 'all', 
            search: '',
            isFetching: false,
            watchID: null // 用於儲存 watchPosition ID
        };

        // 預設知識庫資料
        const DEFAULT_KB = [
            { id: '1', type: 'monument', title_zh: '赤崁樓', info_zh: '台南市 / 一級古蹟', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Chikan+Tower', desc: '赤崁樓始建於 1653 年，為荷蘭人所建，歷經清朝重建與日治時期修繕，是台南最具代表性的古蹟之一。' },
            { id: '2', type: 'museum', title_zh: '西門紅樓', info_zh: '台北市 / 歷史建築', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Red+House', desc: '西門紅樓是一座兩層高的紅磚洋樓，見證了西門町的歷史發展。' },
            { id: '3', type: 'intangible', title_zh: '媽祖繞境', info_zh: '中台灣 / 無形文化', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Mazu+Pilgrimage', desc: '中元普渡民俗與宗教文化的代表活動之一，強調對先人敬意與社群連結。' }
        ];
        
        // Gemini 結構化輸出的 JSON Schema
        const CULTURAL_ASSET_SCHEMA = {
            type: "array",
            items: {
                type: "object",
                properties: {
                    title_zh: { type: "string", description: "文化資產的中文名稱" },
                    info_zh: { type: "string", description: "簡要地點/分類資訊" },
                    type: { type: "string", description: "類別，固定為 monument, museum, 或 intangible" },
                    desc: { type: "string", description: "從新聞摘要中提取的簡短描述" }
                },
                required: ["title_zh", "info_zh", "type", "desc"]
            }
        };

        // DOM 元素快取
        const elements = {
            kbGrid: $('#kb-grid'),
            ragDot: $('#rag-dot'),
            ragText: $('#rag-text'),
            geminiApiInput: $('#gemini-api'),
            btnSaveApi: $('#btn-save-api'),
            btnAutoFetch: $('#btn-auto-fetch'),
            filterControls: $('#filter-controls'),
            kbSearch: $('#kb-search'),
            chat: $('#chat'),
            chatInput: $('#chat-input'),
            btnSend: $('#btn-send'),
            localDataList: $('#local-data-list'),
            importModal: $('#import-modal'),
            btnImport: $('#btn-import'),
            importForm: $('#import-form'),
            assetName: $('#asset-name'),
            assetLocation: $('#asset-location'),
            assetType: $('#asset-type'),
            assetImgUrl: $('#asset-img-url'),
            assetDesc: $('#asset-desc'),
            toast: $('#toast')
        };


        // --- UI / 國際化功能 ---

        function t(key, ...args) {
            let text = i18n[state.lang][key];
            if (typeof text === 'function') {
                return text(...args);
            }
            return text || key;
        }

        function switchLanguage(lang) {
            state.lang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang;
            
            // 更新所有帶有 data-key 的元素
            $$('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (i18n[lang][key] && typeof i18n[lang][key] !== 'function') {
                    if (el.tagName === 'INPUT' && el.placeholder) {
                        el.placeholder = t(key);
                    } else {
                        el.textContent = t(key);
                    }
                }
            });

            // 特別處理 chat init message
            const chatInit = $('.bubble.ai');
            if(chatInit) chatInit.textContent = t('chat_init');

            // 重新渲染知識庫
            renderKB();

            showToast(t('toast_lang_switched', lang === 'zh-Hant'), 'success');
        }

        function showToast(message, type = 'default') {
            elements.toast.textContent = message;
            elements.toast.className = `toast show ${type}`;
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        function updateRagStatus() {
            elements.ragDot.classList.toggle('ok', state.ragReady);
            elements.ragText.textContent = state.ragReady ? t('status_rag').replace('尚未連線', '已連線') : t('status_rag');
            elements.btnSend.disabled = !state.ragReady;
        }


        // --- 知識庫 / 渲染功能 ---

        function renderKB() {
            elements.kbGrid.innerHTML = ''; // 清空
            const currentLang = state.lang === 'zh-Hant' ? 'zh' : 'en';

            const filteredKnowledge = state.knowledge.filter(item => {
                const titleKey = `title_${currentLang}`;
                const infoKey = `info_${currentLang}`;

                // 篩選：類型
                const typeMatch = state.filter === 'all' || item.type === state.filter;

                // 篩選：搜尋
                const searchMatch = !state.search || 
                                    item[titleKey].toLowerCase().includes(state.search.toLowerCase()) || 
                                    item[infoKey].toLowerCase().includes(state.search.toLowerCase()) ||
                                    (item.desc && item.desc.toLowerCase().includes(state.search.toLowerCase()));
                
                return typeMatch && searchMatch;
            });


            if (filteredKnowledge.length === 0) {
                 elements.kbGrid.innerHTML = `<p style="grid-column: span 3; text-align: center; color: var(--muted);">
                                                 ${t('placeholder_search').replace('...', '...找不到資料。')}
                                             </p>`;
                return;
            }


            filteredKnowledge.forEach(item => {
                const template = $('#kb-card-tpl').content.cloneNode(true);
                const card = template.querySelector('.kb-card');
                
                const img = card.querySelector('img');
                const title = card.querySelector('.title');
                const meta = card.querySelector('.meta');

                card.dataset.id = item.id;
                card.dataset.type = item.type;
                
                img.src = item.img_url || `https://via.placeholder.com/640x360/333344/aaaaaa?text=${item[`title_${currentLang}`]}`;
                img.alt = item[`title_${currentLang}`];
                title.textContent = item[`title_${currentLang}`];
                meta.textContent = item[`info_${currentLang}`];

                elements.kbGrid.appendChild(template);
            });
        }


        // --- 核心功能：AI 自動爬取並抽取資料 ---

        async function fetchCulturalAssets() {
            if (state.isFetching) return;

            state.isFetching = true;
            elements.btnAutoFetch.disabled = true;
            elements.btnAutoFetch.textContent = '⚙️ 處理中...';
            showToast(t('toast_fetching_ai'), 'default');
            
            let searchResults = '';
            let extractedData = null;

            try {
                // 步驟 1: 呼叫 Google Search Tool 進行搜尋 (模擬)
                const searchResponse = await google.search({ 
                    queries: [
                        state.lang === 'zh-Hant' ? "台灣最新文化資產與古蹟新聞" : "Taiwan latest cultural asset news", 
                        state.lang === 'zh-Hant' ? "文化觀光活動資訊" : "Cultural tourism event information"
                    ] 
                });

                // 將搜尋結果格式化成單一字串，以便傳遞給 Gemini (模擬)
                searchResults = searchResponse.results.map(r => 
                    `標題: ${r.source_title}\n摘要: ${r.snippet}\n網址: ${r.url}`
                ).join('\n\n---\n\n');

                
                // 步驟 2: 呼叫 Gemini API 進行結構化抽取 (此處僅為**模擬成功**回覆)
                
                // 模擬網路延遲和 AI 處理時間
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // 模擬 Gemini 結構化輸出
                extractedData = [
                    { id: Date.now() + '-1', type: 'monument', title_zh: "臺南神農街舊宅群", info_zh: "臺南市 / 國定古蹟", title_en: "Tainan Shennong St. Houses", info_en: "Tainan / National Monument", img_url: 'https://via.placeholder.com/640x360/443322/aaaaaa?text=Shennong+Street', desc: "文化部宣布最新修復竣工，強調其對臺灣早期商業歷史的重要性。" },
                    { id: Date.now() + '-2', type: 'intangible', title_zh: "東港迎王平安祭典", info_zh: "屏東縣 / 無形文化", title_en: "Donggang Wangye Festival", info_en: "Pingtung / Intangible Heritage", img_url: 'https://via.placeholder.com/640x360/552233/aaaaaa?text=Wangye+Festival', desc: "列為今年文化觀光推廣重點，交通部觀光署提供詳細指引。" },
                    { id: Date.now() + '-3', type: 'monument', title_zh: "鳳山遺址", info_zh: "高雄市 / 暫定歷史遺址", title_en: "Fengshan Historical Site", info_en: "Kaohsiung / Provisional Historic Site", img_url: 'https://via.placeholder.com/640x360/225544/aaaaaa?text=Fengshan+Site', desc: "高雄鳳山發現清朝早期軍事防禦工事的遺跡，將進行進一步研究與保護。" }
                ];
                
                // 步驟 3: 更新知識庫
                if (Array.isArray(extractedData) && extractedData.length > 0) {
                    const existingTitles = new Set(state.knowledge.map(item => item.title_zh));
                    const newAssets = extractedData.filter(item => !existingTitles.has(item.title_zh));
                    
                    state.knowledge = [...state.knowledge, ...newAssets];
                    renderKB();
                    showToast(t('toast_fetch_ok_ai', newAssets.length), 'success');
                } else {
                    // 雖然模擬是成功的，但為了完整性，保留錯誤處理
                    showToast(t('toast_fetch_error_ai') + ' (Gemini 抽取結果為空)', 'error');
                }

            } catch (error) {
                console.error("AI 自動爬取失敗:", error);
                showToast(t('toast_fetch_error_ai'), 'error');
            } finally {
                state.isFetching = false;
                elements.btnAutoFetch.disabled = false;
                elements.btnAutoFetch.textContent = t('btn_auto_fetch');
            }
        }


        // --- 地圖與 GPS 功能 ---

        let localMap;
        let userMarker;
        let mapInitialized = false;

        function initMap(lat, lng) {
            if (!mapInitialized && $('#local-map')) {
                // 初始化地圖，中心點為使用者的位置或預設的台南赤崁樓
                const centerCoords = [lat || 22.9972, lng || 120.2036];
                localMap = L.map('local-map').setView(centerCoords, 16); 

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                }).addTo(localMap);

                userMarker = L.marker(centerCoords, {
                    icon: L.divIcon({className: 'user-marker', html: '📍'})
                }).addTo(localMap)
                  .bindPopup(t('user_location')).openPopup();

                mapInitialized = true;
                
                // 模擬在地即時資訊列表
                updateLocalDataList(lat, lng);
            }
        }

        function updateLocalDataList(lat, lng) {
            const list = elements.localDataList;
            list.innerHTML = '';
            
            // 模擬的 GPS 資訊 (基於赤崁樓中心點)
            const simulatedData = [
                { type: 'asset', icon: '🏛️', name: '赤崁樓 (一級古蹟)', distance: '0 m' },
                { type: 'asset', icon: '📚', name: '台灣文學館 (國定古蹟)', distance: '270 m' },
                { type: 'bus', icon: '🚌', name: t('bus_route'), distance: t('bus_status') },
                { type: 'event', icon: '🎉', name: t('event_name'), distance: t('event_status') }
            ];

            simulatedData.forEach(item => {
                const li = document.createElement('li');
                li.style.cssText = 'padding: 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dotted var(--glass-border);';
                li.innerHTML = `
                    <span>${item.icon} ${item.name}</span>
                    <span style="font-weight: bold; color: var(--pri);">${item.distance}</span>
                `;
                list.appendChild(li);
            });
        }

        function handleGeolocationSuccess(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (!mapInitialized) {
                initMap(lat, lng);
            }

            // 更新地圖標記和視圖
            userMarker.setLatLng([lat, lng]);
            localMap.setView([lat, lng], 16); 
            updateLocalDataList(lat, lng);

            console.log(`GPS Location: ${lat}, ${lng}`);
        }

        function handleGeolocationError(err) {
            console.warn(`GPS 錯誤 (${err.code}): ${err.message}`);
            // 如果失敗，使用預設座標初始化地圖
            initMap(); 
        }

        function setupGeolocation() {
            if (navigator.geolocation) {
                // 啟動 GPS 追蹤
                state.watchID = navigator.geolocation.watchPosition(
                    handleGeolocationSuccess, 
                    handleGeolocationError, 
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                handleGeolocationError({ code: 0, message: '瀏覽器不支援地理定位' });
            }
        }

        // --- 事件綁定與初始化 ---

        function setupEventListeners() {
            // 語言切換
            $('#btn-zh').addEventListener('click', () => switchLanguage('zh-Hant'));
            $('#btn-en').addEventListener('click', () => switchLanguage('en'));

            // API 儲存 (模擬)
            elements.btnSaveApi.addEventListener('click', () => {
                const key = elements.geminiApiInput.value.trim();
                if (key.length > 10) { // 簡單驗證長度
                    state.geminiKey = key;
                    state.ragReady = true;
                    localStorage.setItem('geminiKey', key);
                    localStorage.setItem('ragReady', 'true');
                    updateRagStatus();
                    showToast(t('toast_key_ok'), 'success');
                } else {
                    state.ragReady = false;
                    updateRagStatus();
                    showToast(t('toast_key_bad'), 'error');
                }
            });

            // KB 自動爬取
            elements.btnAutoFetch.addEventListener('click', fetchCulturalAssets);

            // KB 篩選
            elements.filterControls.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter')) {
                    $$('.filter').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    state.filter = e.target.dataset.filter;
                    renderKB();
                }
            });

            // KB 搜尋
            elements.kbSearch.addEventListener('input', (e) => {
                state.search = e.target.value;
                renderKB();
            });
            
            // 聊天發送 (模擬)
            elements.btnSend.addEventListener('click', (e) => {
                const message = elements.chatInput.value.trim();
                if (message) {
                    // 模擬使用者泡泡
                    const userBubble = document.createElement('div');
                    userBubble.className = 'bubble user';
                    userBubble.textContent = message;
                    elements.chat.appendChild(userBubble);
                    
                    // 模擬 AI 回覆
                    setTimeout(() => {
                        const aiBubble = document.createElement('div');
                        aiBubble.className = 'bubble ai';
                        aiBubble.textContent = `🤖 AI 模擬回覆: 收到您的問題 "${message}"。根據知識庫，...`;
                        elements.chat.appendChild(aiBubble);
                        elements.chat.scrollTop = elements.chat.scrollHeight;
                    }, 1500);

                    elements.chatInput.value = '';
                    elements.chat.scrollTop = elements.chat.scrollHeight;
                }
            });
            
            // 摺疊功能 (GPS & USR)
            $$('.collapsible').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const body = toggle.nextElementSibling;
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !isExpanded);
                    body.hidden = isExpanded;
                });
            });

            // AR 熱點註釋互動 (Model-Viewer)
            const mvAnping = $('#mv-anping');
            if(mvAnping) {
                mvAnping.addEventListener('load', () => {
                    $$('.hotspot', mvAnping).forEach(hotspot => {
                        const annotation = mvAnping.querySelector(`.annotation[slot="annotation-${hotspot.dataset.slot.replace('hotspot-', '')}"]`);
                        
                        hotspot.addEventListener('mouseenter', () => {
                            if (annotation) annotation.style.display = 'block';
                        });
                        hotspot.addEventListener('mouseleave', () => {
                            if (annotation) annotation.style.display = 'none';
                        });
                    });
                });
            }

            // 匯入模態框開關 (模擬匯入)
            elements.btnImport.addEventListener('click', () => elements.importModal.showModal());
            $('#btn-close-modal').addEventListener('click', () => elements.importModal.close());
            $('#btn-cancel').addEventListener('click', () => elements.importModal.close());
            
            // 模擬單筆匯入
            elements.importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = elements.assetName.value.trim();
                const location = elements.assetLocation.value.trim();
                
                if (name && location) {
                    const newAsset = {
                        id: Date.now().toString(),
                        type: elements.assetType.value.trim().toLowerCase() || 'other',
                        title_zh: name,
                        info_zh: `${location} / ${elements.assetType.value.trim() || '自定義'}`,
                        title_en: name, // 簡化處理：英文名暫用中文
                        info_en: `${location} / ${elements.assetType.value.trim() || 'Custom'}`,
                        img_url: elements.assetImgUrl.value.trim() || null,
                        desc: elements.assetDesc.value.trim() || '自定義匯入資料。'
                    };
                    state.knowledge.push(newAsset);
                    renderKB();
                    elements.importModal.close();
                    showToast(t('toast_import_ok', name), 'success');
                    elements.importForm.reset();
                } else {
                    showToast(t('toast_import_error'), 'error');
                }
            });
            
            // 模擬 AI 自動摘要
            $('#btn-ai-summarize').addEventListener('click', async () => {
                showToast(t('toast_ai_summarizing'), 'default');
                await new Promise(r => setTimeout(r, 1500)); // 模擬延遲
                elements.assetDesc.value = elements.assetDesc.value + `\n\n(🤖 AI 摘要模擬) 這是一個關於${elements.assetName.value || '未知'}的重要文化資產，位於${elements.assetLocation.value || '某處'}。`;
                showToast(t('toast_ai_summarize_ok'), 'success');
            });
        }


        function init() {
            // 載入預設資料並初始化
            state.knowledge = [...DEFAULT_KB];
            
            // 載入 API Key 狀態
            elements.geminiApiInput.value = state.geminiKey;
            updateRagStatus();

            // 設置語言
            switchLanguage(state.lang); 
            
            // 渲染 KB
            renderKB();

            // 設置事件監聽器
            setupEventListeners();

            // 啟動 GPS 追蹤
            setupGeolocation();
        }

        // 頁面載入後啟動
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
