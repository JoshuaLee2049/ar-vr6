// ... (前略： i18n, state, DEFAULT_KB, DOM 元素變數宣告) ...

// **新增 RAG 核心狀態切換函式**
function setRagReady(ready) {
    state.ragReady = ready;
    localStorage.setItem('ragReady', ready);
    setRagUI(ready);
    
    // 初始化聊天室內容
    chatBox.innerHTML = '';
    const messageKey = ready ? 
        'chat_init'.replace('未啟動', '已於上次連線時啟動') : // 模擬成功後的訊息
        'chat_init'; 
    addBubble('ai', t(messageKey));

    if (ready) {
        toast(t('toast_key_ok'), 'success');
    } else {
        toast(t('toast_key_bad'), 'error');
    }
}

// **完善 setRagUI 函式**
function setRagUI(ready) { 
    if (ready) { 
        ragDot.classList.add('ok'); 
        ragText.textContent = (state.lang === 'zh-Hant') ? 'RAG 服務：已連線' : 'RAG Service: Connected'; 
    } else { 
        ragDot.classList.remove('ok'); 
        ragText.textContent = t('status_rag'); 
    } 
}

// **新增儲存 API 金鑰的處理函式 (模擬驗證)**
function saveApiKeys() {
    const newGeminiKey = inputGemini.value.trim();
    
    // 檢查金鑰格式，這裡用模擬的方式判斷長度 (實際應呼叫API驗證)
    if (newGeminiKey && newGeminiKey.length > 20) { 
        // 模擬驗證成功
        state.geminiKey = newGeminiKey;
        localStorage.setItem('geminiKey', newGeminiKey);
        setRagReady(true);
    } else if (newGeminiKey === '') {
        // 如果清空金鑰
        state.geminiKey = '';
        localStorage.removeItem('geminiKey');
        setRagReady(false);
        toast(t('toast_key_bad'), 'error'); // 顯示金鑰無效的提示
    } else {
        // 模擬驗證失敗
        setRagReady(false);
    }
}

// ... (中略： loadKnowledge, addCustomAsset, parseCsv 函式) ...

// **完善 bindEvents 函式**
function bindEvents(){
    // ... (其他事件：語言切換, 知識庫篩選, 匯入模組開關) ...
    
    // **API 服務模組事件**
    btnSaveAPI.addEventListener('click', saveApiKeys);
    
    // **聊天室發送事件 (模擬)**
    btnSend.addEventListener('click', () => handleChat(chatInput.value));
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleChat(chatInput.value);
        }
    });

    // ... (後略： 摺疊功能, 模態框事件) ...
}

// **新增聊天處理函式 (模擬回覆)**
function handleChat(message) {
    const msg = message.trim();
    if (!msg) return;

    if (!state.ragReady) {
        toast(t('toast_need_key'), 'error');
        return;
    }
    
    // 1. 顯示使用者訊息
    addBubble('user', msg);
    chatInput.value = '';
    
    // 2. 模擬 AI 思考
    addBubble('ai', '...');
    
    // 3. 模擬 API 呼叫與回覆
    setTimeout(() => {
        const lastBubble = chatBox.lastElementChild;
        if (lastBubble && lastBubble.textContent === '...') {
            lastBubble.remove();
        }

        const replyKey = (state.lang === 'zh-Hant') ? 
            `[AI 導覽回覆] 關於「${msg}」的問題，RAG 知識庫已提供相關資料。建議您前往赤崁樓體驗 AR 實景還原。` :
            `[AI Guide Reply] Regarding "${msg}", RAG has provided relevant data. I suggest checking the AR experience for Chikan Tower.`;
        
        addBubble('ai', replyKey);

    }, 1500); // 模擬 1.5 秒延遲
}

function addBubble(type, text) {
    const div = document.createElement('div');
    div.className = `bubble ${type}`;
    div.textContent = text;
    chatBox.appendChild(div);
    // 捲動到底部
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ... (後續的 renderKB, handleFilterClick, toast 函式等) ...

// **請確保在 init() 函式中呼叫 bindEvents()**
// ...
// function init(){ 
//    // ... 
//    bindEvents(); 
//    // ...
// }
// ...
    let userLat = 22.9934; // 預設中心點 (台南)
    let userLon = 120.2
