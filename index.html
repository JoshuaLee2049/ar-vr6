<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文化智遊 - AI 科技儀表板</title>
  <meta name="color-scheme" content="dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* 原樣保留樣式，省略以節省篇幅 */
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- 原始結構保持不變，包括語言切換、API 模組、AI 導覽、知識庫、沉浸式體驗、在地資訊、個人中心、modal 等區塊 -->
  <!-- 此處省略 HTML 主體以重點展示新增的 Gemini 驗證部分 -->

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  /* === Gemini 驗證：自動偵測 v1 / v1beta 與可用模型變體 === */
  async function listModelsDetect(key) {
    const bases = [
      "https://generativelanguage.googleapis.com/v1",
      "https://generativelanguage.googleapis.com/v1beta"
    ];
    let lastErr;
    for (const base of bases) {
      try {
        const r = await fetch(`${base}/models?key=${encodeURIComponent(key)}`);
        if (!r.ok) {
          lastErr = await r.text();
          continue;
        }
        const data = await r.json();
        return { base, models: data.models || [] };
      } catch (e) {
        lastErr = String(e);
      }
    }
    throw new Error(`ListModels 失敗：${lastErr || "未知錯誤"}`);
  }

  function pickFlashModel(models) {
    const supportsGen = (m) => (m.supportedGenerationMethods || []).includes("generateContent");
    const order = [
      "gemini-1.5-flash-latest",
      "gemini-1.5-flash-001",
      "gemini-1.5-flash-8b-latest",
      "gemini-1.5-flash-8b-001"
    ];
    for (const name of order) {
      const hit = models.find(m => m.name?.endsWith(`/models/${name}`) && supportsGen(m));
      if (hit) return { ok: true, name };
    }
    const family = models
      .filter(m => /\/models\/gemini-1\.5-flash/.test(m.name || "") && supportsGen(m))
      .map(m => m.name.split("/models/")[1]);
    if (family.length) return { ok: true, name: family[0] };
    return { ok: false, reason: "找不到支援 generateContent 的 gemini-1.5-flash 變體" };
  }

  async function tryGenerateContent(base, key, modelName) {
    const url = `${base}/models/${encodeURIComponent(modelName)}:generateContent?key=${encodeURIComponent(key)}`;
    const body = { contents: [{ role: "user", parts: [{ text: "ping" }] }] };
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const text = await r.text();
      throw new Error(`generateContent 失敗：${text}`);
    }
    return r.json();
  }

  document.getElementById("btn-save-api")?.addEventListener("click", async () => {
    const key = (document.getElementById("gemini-api")?.value || "").trim();
    const toast = (msg, type="default") => {
      const t = document.getElementById("toast");
      if (!t) return alert(msg);
      t.textContent = msg;
      t.className = "toast show " + type;
      clearTimeout(t.timer);
      t.timer = setTimeout(() => t.classList.remove("show"), 3000);
    };
    const setRag = (ok) => {
      const dot = document.getElementById("rag-dot");
      const text = document.getElementById("rag-text");
      if (ok) {
        dot?.classList.add("ok");
        if (text) text.textContent = "RAG 服務：已連線";
      } else {
        dot?.classList.remove("ok");
        if (text) text.textContent = "RAG 服務：尚未連線";
      }
    };

    if (!key) {
      toast("請先輸入 Gemini API Key。", "error");
      return;
    }

    const isHttps = location.protocol === "https:" || ["localhost","127.0.0.1"].includes(location.hostname);
    if (!isHttps) {
      toast("需要在 HTTPS 或 localhost 環境執行，否則可能被瀏覽器阻擋。", "error");
      return;
    }

    try {
      toast("正在檢查可用模型…", "success");
      const { base, models } = await listModelsDetect(key);
      const pick = pickFlashModel(models);

      if (!pick.ok) {
        toast("ListModels 成功，但找不到支援 generateContent 的 gemini-1.5-flash。", "error");
        return;
      }

      await tryGenerateContent(base, key, pick.name);

      localStorage.setItem("geminiKey", key);
      localStorage.setItem("ragReady", "true");
      localStorage.setItem("geminiApiBase", base);
      localStorage.setItem("geminiModel", pick.name);

      setRag(true);
      toast("✅ Gemini API Key 儲存並驗證成功！服務核心啟動。", "success");

      const chat = document.getElementById("chat");
      if (chat) {
        const b = document.createElement("div");
        b.className = "bubble ai";
        b.textContent = "服務已啟動。RAG 檢索就緒，請開始提問！";
        chat.appendChild(b);
        chat.scrollTop = chat.scrollHeight;
      }
    } catch (err) {
      const msg = String(err);
      if (/API key not valid/i.test(msg) || /permission/i.test(msg)) {
        toast("API Key 無效或沒有啟用 Generative Language API 權限。請到 Google AI Studio 檢查專案金鑰與 API 啟用。", "error");
      } else if (/quota/i.test(msg) || /429/.test(msg)) {
        toast("已達到配額或速率限制（429）。請稍後再試或在 AI Studio 提升配額。", "error");
      } else if (/not found/i.test(msg) || /is not supported/.test(msg)) {
        toast("模型在此 API 版本不可用，或模型名稱不支援 generateContent。已自動偵測仍失敗，請改用 gemini-1.5-flash-001 或 -latest。", "error");
      } else {
        toast("連線失敗：" + msg, "error");
      }
      localStorage.setItem("ragReady", "false");
      setRag(false);
    }
  });
  </script>
</body>
</html>
