<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ–‡åŒ–æ™ºéŠ - AI ç§‘æŠ€å„€è¡¨æ¿ï¼ˆAR/VRæ•´åˆç‰ˆ v5 - GeminiæŠ½å–ï¼‰</title>
    <meta name="color-scheme" content="dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* CSS è®Šæ•¸ */
        :root { --bg:#070718; --bg-grad-a:rgba(0,255,255,.1); --bg-grad-b:rgba(187,0,255,.1);
          --pri:#00ffff; --sec:#bb00ff; --text:#e6f7ff; --muted:#8090a0; --glass:rgba(0,0,0,.7);
          --glass-border:rgba(255,255,255,.06); --glow-pri:0 0 15px rgba(0,255,255,.4), 0 0 5px rgba(0,255,255,.18);
          --glow-sec:0 0 15px rgba(187,0,255,.4), 0 0 5px rgba(187,0,255,.18); --ok:#4aff8f; --bad:#ff4a4a;
          --radius:18px; --radius-sm:10px; --shadow-deep:0 0 30px rgba(0,0,0,.7), 0 0 20px rgba(0,255,255,.05), 0 0 40px rgba(187,0,255,.08); --space:clamp(.75rem, .75rem + 1.2vw, 2rem); }
        /* åŸºæœ¬æ¨£å¼ */
        *{box-sizing:border-box} html,body{height:100%}
        body{margin:0;font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
          background:radial-gradient(circle at 15% 15%, var(--bg-grad-a), transparent 30%), radial-gradient(circle at 85% 75%, var(--bg-grad-b), transparent 35%), linear-gradient(135deg,#070718 0%,#030018 100%);
          background-color:var(--bg); padding:clamp(1rem,3vw,2.5rem)}
        :focus-visible{outline:2px solid var(--pri); outline-offset:2px; border-radius:8px}
        @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}
        /* ç‰ˆé¢ã€é¢æ¿ã€å…ƒä»¶æ¨£å¼ */
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(1rem,2vw,2rem)}
        @media (max-width:960px){.grid{grid-template-columns:1fr}}
        .panel{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:var(--shadow-deep);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:calc(var(--space)*1.1);transition:transform .25s ease,box-shadow .25s ease}
        .panel:hover{transform:translateY(-2px);box-shadow:var(--glow-pri)}
        .module-header{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem}
        .module-header h2{margin:0;font-size:clamp(1.1rem,1rem + .8vw,1.5rem);color:var(--pri);text-shadow:0 0 6px rgba(0,255,255,.28)}
        .module-sub{margin:0;color:var(--muted);font-size:.95rem}
        .chip{display:inline-flex;align-items:center;gap:.4rem;font-family:'Orbitron',monospace;font-weight:700;background:linear-gradient(45deg,var(--pri),var(--sec));color:#091018;border-radius:var(--radius-sm);padding:.35rem .6rem;letter-spacing:.5px}
        .btn{cursor:pointer;border:1.5px solid var(--pri);background:rgba(0,255,255,.06);color:var(--pri);border-radius:var(--radius-sm);padding:.55rem .9rem;font-size:.95rem;transition:.2s ease}
        .btn:hover:not(:disabled){box-shadow:var(--glow-pri);transform:translateY(-1px)}
        .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
        .btn.primary{background:linear-gradient(90deg,var(--pri),#00aaff);color:#081018;border-color:transparent}
        .input,textarea.input{width:100%;background:rgba(0,0,0,.4);color:var(--text);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:.65rem .8rem;font-size:.95rem}
        .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
        .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-12{grid-column:span 12}
        @media (max-width:960px){.col-6,.col-4{grid-column:span 12}}
        header.header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:var(--space)}
        .nav{display:flex;gap:.8rem;flex-wrap:wrap}
        .nav a{color:var(--muted);text-decoration:none;padding:.4rem .6rem;border-radius:8px}
        .nav a.active,.nav a:hover{background:rgba(0,255,255,.08);color:var(--text)}
        /* çŸ¥è­˜åº« */
        .kb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        @media (max-width:1200px){.kb-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:720px){.kb-grid{grid-template-columns:1fr}}
        .kb-card{overflow:hidden;border-radius:16px;border:1px solid var(--glass-border);background:rgba(255,255,255,.02); transition: border-color .2s}
        .kb-card:hover{border-color: var(--pri)}
        .kb-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .kb-card .content{padding:.8rem .9rem}
        .kb-card h4{margin:0 0 .25rem 0;font-size:1.05rem}
        .filters{display:flex;gap:.6rem;flex-wrap:wrap}
        .filter{padding:.35rem .6rem;border:1px solid var(--glass-border);border-radius:999px;color:var(--muted);cursor:pointer}
        .filter.active{border-color:var(--pri);color:var(--text);box-shadow:var(--glow-pri)}
        /* èŠå¤©å®¤ */
        .chat{display:flex;flex-direction:column;gap:.6rem;height:clamp(220px,35vh,360px);overflow:auto;background:rgba(255,255,255,.02);border-radius:12px;padding:.8rem;border:1px solid var(--glass-border)}
        .bubble{max-width:88%;padding:.6rem .8rem;border-radius:14px; white-space: pre-wrap; word-wrap: break-word;}
        .bubble.ai{background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.2)}
        .bubble.user{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);margin-left:auto}
        .chat-input{display:flex;gap:.5rem;margin-top:.6rem}
        .chat-input .mic{width:2.25rem}
        .status{display:inline-flex;align-items:center;gap:.4rem;font-size:.92rem;color:var(--muted)}
        .dot{width:.55rem;height:.55rem;border-radius:50%;background:#666;box-shadow:inset 0 0 0 2px rgba(0,0,0,.3)}
        .dot.ok{background:var(--ok)}
        /* AR/VR é«”é©— */
        .xp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
        @media (max-width:960px){.xp-grid{grid-template-columns:1fr}}
        .xp-card{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--glass-border)}
        .xp-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .xp-overlay{position:absolute;inset:auto 0 0 0;padding:.9rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65))}
        .tag{display:inline-block;padding:.3rem .5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;margin-bottom:.4rem}
        .ar-card model-viewer{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15)}
        .hotspot{--size:14px;width:var(--size);height:var(--size);border-radius:999px;border:2px solid rgba(255,255,255,.9);background:rgba(0,255,255,.9);box-shadow:var(--glow-pri)}
        .annotation{position:absolute;transform:translate(-50%,calc(-100% - 10px));padding:.35rem .55rem;background:rgba(0,0,0,.75);border:1px solid var(--glass-border);border-radius:8px;color:#e6f7ff;font-size:.85rem;white-space:nowrap;pointer-events:none; display:none;}
        .vr-card .vr-wrap{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden}
        .vr-card .vr-wrap a-scene{width:100%;height:100%; display:block}
        /* æ‘ºç–Šèˆ‡æ¨¡æ…‹æ¡† */
        .collapsible{cursor:pointer;position:relative}
        .collapsible .caret{margin-left:auto;font-size:.9rem;opacity:.9}
        .section-body{margin-top:.6rem;display:block}
        .section-body[hidden]{display:none}
        .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.82);backdrop-filter:blur(5px);z-index:1000}
        .modal[open]{display:grid}
        .modal-card{width:min(600px,92vw);background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:1.1rem;box-shadow:var(--glow-pri)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding-bottom:.6rem;border-bottom:2px solid var(--sec)}
        .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}
        /* Toast æç¤º */
        .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) translateY(120%);background:rgba(0,0,0,.85);color:#fff;padding:.6rem .9rem;border-radius:10px;border:1px solid var(--glass-border);transition:transform .28s ease;z-index:1200;white-space:pre-wrap}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{box-shadow:0 0 0 2px rgba(74,255,143,.2)}
        .toast.error{box-shadow:0 0 0 2px rgba(255,74,74,.2)}
        /* åœ°åœ–å…ƒä»¶å°ˆå±¬æ¨£å¼ */
        #local-map {
          height: 300px;
          border: 1px solid var(--glass-border); 
          border-radius: 12px;
          margin-bottom: .8rem;
        }
        .leaflet-container { /* è®“ Leaflet å®¹å™¨é©æ‡‰æš—è‰²ä¸»é¡Œ */
            background-color: var(--bg);
            border-radius: 12px;
        }
    </style>
    
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="lang-switch" style="display:flex; gap:.5rem; align-items:center; margin-bottom:.6rem;">
        <span style="color:var(--text); font-size:.9rem" data-key="ui_lang">ä»‹é¢èªè¨€:</span>
        <button class="btn" data-lang="zh-Hant" id="btn-zh">ç¹é«”ä¸­æ–‡</button>
        <button class="btn" data-lang="en" id="btn-en">English</button>
    </div>

    <header class="header" role="banner">
        <h1 id="app-title" data-key="title">æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿</h1>
        <nav class="nav" aria-label="ä¸»è¦å°è¦½">
            <a href="#section-guide" class="active" data-key="nav_guide">å°è¦½</a>
            <a href="#section-kb" data-key="nav_knowledge">çŸ¥è­˜åº«</a>
            <a href="#section-xp" data-key="nav_experience">é«”é©—</a>
            <a href="#section-me" data-key="nav_personal">å€‹äººä¸­å¿ƒ</a>
        </nav>
    </header>

    <main class="grid" role="main" aria-live="polite">
        <section class="panel col-12" aria-labelledby="api-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>API</span></div>
                <h2 id="api-h2" data-key="h2_api">API æ•´åˆæœå‹™æ¨¡çµ„</h2>
            </div>
            <p class="module-sub" data-key="p_api">ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š</p>
            <div class="row" style="margin-top:.6rem">
                <div class="col-12" style="grid-column: span 12;">
                    <label for="gemini-api" class="sr">Gemini API Key</label>
                    <input id="gemini-api" class="input" type="password" placeholder="Gemini API Key" autocomplete="off" />
                </div>
            </div>
            <div style="display:flex; gap:.8rem; align-items:center; justify-content:flex-end; margin-top:.8rem">
                <span class="status"><span id="rag-dot" class="dot" aria-hidden="true"></span><span id="rag-text" data-key="status_rag">RAG æœå‹™ï¼šå°šæœªé€£ç·š</span></span>
                <span class="status"><span class="dot ok" aria-hidden="true"></span><span data-key="status_data">é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­</span></span>
                <button id="btn-save-api" class="btn primary" data-key="btn_save" type="button">å„²å­˜è¨­å®š</button>
            </div>
        </section>

        <section id="section-guide" class="panel col-12" aria-labelledby="guide-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AI</span></div>
                <h2 id="guide-h2" data-key="h2_guide">AI æ™ºèƒ½å°è¦½</h2>
            </div>
            <p class="module-sub" data-key="p_guide">æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°</p>
            <div id="chat" class="chat" aria-live="polite" aria-label="èŠå¤©è¦–çª—">
                <div class="bubble ai" data-key="chat_init">[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚</div>
            </div>
            <div class="chat-input">
                <button class="btn mic" type="button" aria-label="èªéŸ³è¼¸å…¥" disabled>ğŸ¤</button>
                <input id="chat-input" class="input" type="text" data-key="placeholder_chat" placeholder="è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚..." />
                <button id="btn-send" class="btn primary" type="button" data-key="btn_send">ç™¼é€</button>
            </div>
        </section>

        <section id="section-kb" class="panel col-12" aria-labelledby="kb-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>DB</span></div>
                <h2 id="kb-h2" data-key="h2_db">æ–‡åŒ–çŸ¥è­˜åº«</h2>
                <button id="btn-auto-fetch" class="btn" type="button" data-key="btn_auto_fetch">ğŸ¤– AI è‡ªå‹•çˆ¬å–è³‡æ–™</button>
                <button id="btn-import" class="btn" type="button" data-key="btn_import">â†“ åŒ¯å…¥æ–°è³‡æ–™</button>
            </div>
            <p class="module-sub" data-key="p_db">æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)</p>
            <div class="row" style="margin:.6rem 0 .8rem 0; align-items:center">
                <div class="col-6"><input id="kb-search" class="input" type="text" data-key="placeholder_search" placeholder="æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶..." /></div>
                <div class="col-6" style="display:flex; justify-content:flex-end"><div class="filters" role="tablist" aria-label="é¡å‹ç¯©é¸">
                    <button class="filter active" data-filter="all" data-key="filter_all" role="tab" aria-selected="true">å…¨éƒ¨</button>
                    <button class="filter" data-filter="monument" data-key="filter_monument" role="tab">å¤è¹Ÿ</button>
                    <button class="filter" data-filter="museum" data-key="filter_museum" role="tab">åšç‰©é¤¨</button>
                    <button class="filter" data-filter="intangible" data-key="filter_intangible" role="tab">ç„¡å½¢æ–‡åŒ–</button>
                </div></div>
            </div>
            <div id="kb-grid" class="kb-grid" aria-live="polite"></div>
        </section>

        <section id="section-xp" class="panel col-12" aria-labelledby="xp-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AR</span></div>
                <h2 id="xp-h2" data-key="h2_immersive">æ²‰æµ¸å¼é«”é©—</h2>
            </div>
            <p class="module-sub" data-key="p_immersive">å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ</p>
            <div class="xp-grid">
                <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå®‰å¹³å¤å ¡ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
                    <model-viewer id="mv-anping"
                        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
                        alt="å®‰å¹³å¤å ¡ç¤ºæ„ 3D æ¨¡å‹"
                        ar ar-modes="webxr scene-viewer quick-look"
                        ar-scale="auto" ar-placement="floor"
                        camera-controls camera-orbit="0deg 75deg 2.2m" field-of-view="30deg"
                        environment-image="neutral" shadow-intensity="1" exposure="1"
                        interaction-prompt="auto"
                        poster="https://via.placeholder.com/800x520/331144/cccccc?text=Tap+to+Load+AR"
                        aria-label="å•Ÿå‹• AR æª¢è¦–">
                        <button class="hotspot" slot="hotspot-gate" data-position="0.15m 1.2m 0.2m" data-normal="0 1 0" data-anno="åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰"></button>
                        <div class="annotation" slot="annotation-gate">åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰</div>
                        <button class="hotspot" slot="hotspot-battery" data-position="-0.25m 0.9m 0.1m" data-normal="0 1 0" data-anno="ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½"></button>
                        <div class="annotation" slot="annotation-battery">ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½</div>
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_ar">AR å¯¦æ™¯é‚„åŸ</span>
                        <h4 style="margin:.2rem 0" data-key="h4_anping">å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632ï¼ˆAR ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>

                <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå°åŒ—åŸç‰†ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
                    <model-viewer
                        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
                        alt="å°åŒ—åŸç‰†ç¤ºæ„ 3D æ¨¡å‹"
                        ar ar-modes="webxr scene-viewer quick-look"
                        camera-controls environment-image="neutral" shadow-intensity="1"
                        poster="https://via.placeholder.com/800x520/113333/cccccc?text=Tap+to+Load+AR"
                        aria-label="å•Ÿå‹• AR æª¢è¦–">
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_vr">VR / AR é«”é©—</span>
                        <h4 style="margin:.2rem 0" data-key="h4_taipei">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆAR ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>

                <article class="xp-card vr-card" aria-label="VR è™›æ“¬å±•é¤¨ï¼š360 å…¨æ™¯ç¤ºæ„">
                    <div class="vr-wrap">
                        <a-scene embedded background="color: #000" vr-mode-ui="enabled: false">
                            <a-assets>
                                <img id="pano" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" />
                            </a-assets>
                            <a-sky src="#pano"></a-sky>
                            <a-entity position="0 1.6 0">
                                <a-camera wasd-controls-enabled="false"></a-camera>
                            </a-entity>
                        </a-scene>
                    </div>
                    <div class="xp-overlay">
                        <span class="tag">VR è™›æ“¬å±•é¤¨</span>
                        <h4 style="margin:.2rem 0">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆ360Â° è™›æ“¬å±•é¤¨ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>
            </div>
        </section>

        <section class="panel col-12" aria-labelledby="local-h2">
            <div id="local-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>GPS</span></div>
                <h2 id="local-h2" data-key="h2_local">åœ¨åœ°å³æ™‚è³‡è¨Š</h2>
                <span class="module-sub" data-key="p_local">æ•´åˆé–‹æ”¾è³‡æ–™ / å¯¦æ™‚è¿½è¹¤</span>
                <span class="caret" aria-hidden="true">â–¼</span>
            </div>
            <div id="local-body" class="section-body">
                <div id="local-map" role="region" aria-label="åœ¨åœ°å³æ™‚è³‡è¨Šåœ°åœ–"></div>
                
                <ul id="local-data-list" style="list-style:none; padding:0; margin:0; display:grid; gap:.6rem">
                    <li style="text-align:center; color:var(--muted)">è«‹å…è¨±åœ°ç†å®šä½ä»¥è¼‰å…¥åœ¨åœ°å³æ™‚è³‡è¨Š...</li>
                </ul>
            </div>
        </section>

        <section id="section-me" class="panel col-12" aria-labelledby="me-h2">
            <div id="me-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>USR</span></div>
                <h2 id="me-h2" data-key="h2_personal">å€‹äººåŒ–ä¸­å¿ƒ</h2>
                <span class="module-sub" data-key="p_personal">æ‚¨çš„æ–‡åŒ–è¶³è·¡</span>
                <span class="caret" aria-hidden="true">â–¼</span>
            </div>
            <div id="me-body" class="section-body">
                <div class="kb-grid">
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">â™¥</div>
                        <div><h4 data-key="card_fav">æˆ‘çš„æ”¶è—</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_fav_p">æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">âœˆ</div>
                        <div><h4 data-key="card_trip">æˆ‘çš„è¡Œç¨‹</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_trip_p">æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">â˜†</div>
                        <div><h4 data-key="card_ach">æˆ‘çš„æˆå°±</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_ach_p">å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« </p></div>
                    </div></div>
                </div>
            </div>
        </section>
    </main>

    <dialog id="import-modal" class="modal" aria-labelledby="import-title" aria-modal="true">
        <div class="modal-card" role="document">
            <div class="modal-head">
                <h3 id="import-title" data-key="modal_title">åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢</h3>
                <button id="btn-close-modal" class="btn" type="button" aria-label="é—œé–‰">âœ•</button>
            </div>
            <form id="import-form" method="dialog">
                <div class="row" style="margin-top:.6rem">
                    <div class="col-12"><label for="asset-name" data-key="modal_label_name">è³‡ç”¢åç¨± (å¿…å¡«)</label><input id="asset-name" class="input" required /></div>
                    <div class="col-6"><label for="asset-location" data-key="modal_label_location">åœ°é» / ç¸£å¸‚ (å¿…å¡«)</label><input id="asset-location" class="input" required /></div>
                    <div class="col-6"><label for="asset-type" data-key="modal_label_type">é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)</label><input id="asset-type" class="input" /></div>
                    <div class="col-12"><label for="asset-img-url" data-key="modal_label_img">åœ–ç‰‡ URL (é¸å¡«)</label><input id="asset-img-url" class="input" type="url" placeholder="https://..." /></div>
                    <div class="col-12">
                        <label for="asset-desc" data-key="modal_label_desc">ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)</label>
                        <textarea id="asset-desc" class="input" rows="4"></textarea>
                        <button id="btn-ai-summarize" class="btn" type="button" style="margin-top:.5rem;" data-key="btn_ai_summarize">ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)</button>
                    </div>
                    <div class="col-12" style="margin-top:1rem; border-top: 1px dashed var(--glass-border); padding-top: 1rem;">
                        <h4 style="margin:0 0 .5rem 0; color:var(--pri)" data-key="modal_h4_csv">æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™</h4>
                        <input id="asset-csv-file" type="file" accept=".csv" class="input" style="padding: .5rem;" />
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel" data-key="btn_cancel">å–æ¶ˆ</button>
                    <button class="btn primary" type="submit" id="btn-submit" data-key="btn_submit">å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨</button>
                    <button class="btn" type="button" id="btn-import-csv" data-key="btn_import_csv">æ‰¹æ¬¡åŒ¯å…¥ CSV</button>
                </div>
            </form>
        </div>
    </dialog>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <template id="kb-card-tpl">
        <article class="kb-card" data-id="">
            <img src="" alt="" />
            <div class="content">
                <h4 class="title"></h4>
                <p class="meta" style="margin:.2rem 0; color:var(--muted)"></p>
            </div>
        </article>
    </template>

    <script>
    (function(){
        'use strict';
        // å¸¸ç”¨ DOM é¸æ“‡å™¨
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // å¤šèªè¨€/åœ‹éš›åŒ–è¨­å®š (i18n)
        const i18n = {
            'zh-Hant': {
                ui_lang: 'ä»‹é¢èªè¨€:', title: 'æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿', nav_guide: 'å°è¦½', nav_knowledge: 'çŸ¥è­˜åº«', nav_experience: 'é«”é©—', nav_personal: 'å€‹äººä¸­å¿ƒ',
                h2_api: 'API æ•´åˆæœå‹™æ¨¡çµ„', p_api: 'ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š', status_rag: 'RAG æœå‹™ï¼šå°šæœªé€£ç·š', status_data: 'é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­', btn_save: 'å„²å­˜è¨­å®š',
                h2_guide: 'AI æ™ºèƒ½å°è¦½', p_guide: 'æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°', chat_init: '[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚', placeholder_chat: 'è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...', btn_send: 'ç™¼é€',
                h2_db: 'æ–‡åŒ–çŸ¥è­˜åº«', p_db: 'æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)', btn_import: 'â†“ åŒ¯å…¥æ–°è³‡æ–™', btn_auto_fetch: 'ğŸ¤– AI è‡ªå‹•çˆ¬å–è³‡æ–™', placeholder_search: 'æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...',
                filter_all: 'å…¨éƒ¨', filter_monument: 'å¤è¹Ÿ', filter_museum: 'åšç‰©é¤¨', filter_intangible: 'ç„¡å½¢æ–‡åŒ–',
                h2_immersive: 'æ²‰æµ¸å¼é«”é©—', p_immersive: 'å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ', tag_ar: 'AR å¯¦æ™¯é‚„åŸ', h4_anping: 'å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632', tag_vr: 'VR è™›æ“¬å±•é¤¨', h4_taipei: 'å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)',
                h2_local: 'åœ¨åœ°å³æ™‚è³‡è¨Š', p_local: 'æ•´åˆé–‹æ”¾è³‡æ–™ / å¯¦æ™‚è¿½è¹¤', bus_route: '77è·¯ å…¬è»Š', bus_status: 'å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™', event_name: 'åºœåŸæ–‡åŒ–ç¯€', event_status: 'é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€',
                h2_personal: 'å€‹äººåŒ–ä¸­å¿ƒ', p_personal: 'æ‚¨çš„æ–‡åŒ–è¶³è·¡', card_fav: 'æˆ‘çš„æ”¶è—', card_fav_p: 'æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½', card_trip: 'æˆ‘çš„è¡Œç¨‹', card_trip_p: 'æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)', card_ach: 'æˆ‘çš„æˆå°±', card_ach_p: 'å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« ',
                modal_title: 'åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', modal_label_name: 'è³‡ç”¢åç¨± (å¿…å¡«)', modal_label_location: 'åœ°é» / ç¸£å¸‚ (å¿…å¡«)', modal_label_type: 'é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)', modal_label_img: 'åœ–ç‰‡ URL (é¸å¡«)', modal_label_desc: 'ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)', modal_h4_csv: 'æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™', btn_ai_summarize: 'ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)', btn_cancel: 'å–æ¶ˆ', btn_submit: 'å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨', btn_import_csv: 'æ‰¹æ¬¡åŒ¯å…¥ CSV',
                toast_lang_switched: (isZh) => `ä»‹é¢å·²åˆ‡æ›ç‚º ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'}ï¼ˆå·²å„²å­˜ï¼‰`, toast_key_ok: 'Gemini API Key å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼æœå‹™æ ¸å¿ƒå•Ÿå‹•ã€‚', toast_key_bad: 'Gemini API Key æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚', toast_need_key: 'è«‹å…ˆåœ¨ API è¨­å®šæ¨¡çµ„ä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini Keyã€‚', toast_import_error: 'è«‹å¡«å¯«ã€Œè³‡ç”¢åç¨±ã€èˆ‡ã€Œåœ°é»ã€ã€‚', toast_import_ok: (name) => `æˆåŠŸåŒ¯å…¥è³‡ç”¢ï¼šã€Œ${name}ã€ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`, toast_ai_summarizing: 'AI æ‘˜è¦è™•ç†ä¸­...', toast_ai_summarize_ok: 'æ‘˜è¦å®Œæˆï¼å·²å›å¡«è‡³æè¿°æ¬„ä½ã€‚', toast_import_csv_error: 'CSV åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå’Œæ ¼å¼ (éœ€åŒ…å« title, location æ¬„ä½)ã€‚', toast_import_csv_ok: (count) => `æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡ç”¢ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`, toast_network_error: 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', user_location: 'æ‚¨çš„ç›®å‰ä½ç½®',
                toast_fetching_ai: 'æ­£åœ¨å•Ÿå‹• Gemini AIï¼Œå¾ç¶²è·¯è³‡è¨ŠæºæŠ½å–ä¸¦çµæ§‹åŒ–æ–‡åŒ–è³‡ç”¢è³‡æ–™...',
                toast_fetch_ok_ai: (count) => `âœ… æˆåŠŸåˆ©ç”¨ AI æŠ½å– ${count} ç­†ç¶²è·¯è³‡æ–™ï¼Œå·²æ›´æ–° RAG çŸ¥è­˜åº«ã€‚`,
                toast_fetch_error_ai: 'AI è‡ªå‹•çˆ¬å–ä¸¦æŠ½å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Gemini Key æˆ– API é™åˆ¶ã€‚',
            },
            en: {
                ui_lang: 'Language:', title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: 'â†“ Import New Data', btn_auto_fetch: 'ğŸ¤– AI Auto Fetch Data', placeholder_search: 'Search: Monuments, artifacts, history...',
                filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                h2_local: 'Local Real-Time Info', p_local: 'Open Data / Real-time Tracking', bus_route: 'Bus Route 77', bus_status: 'Arriving: Chikan Tower Stop', event_name: 'Fucheng Culture Fest', event_status: 'Active: Confucius Temple Area',
                h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
                modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type (Monument/Museum/Intangible...)', modal_label_img: 'Image URL (Optional)', modal_label_desc: 'Brief Description (for RAG)', modal_h4_csv: 'OR: Batch Import CSV Data', btn_ai_summarize: 'ğŸ¤– AI Auto Summarize (Simulated)', btn_cancel: 'Cancel', btn_submit: 'Import Single Asset', btn_import_csv: 'Import CSV Batch',
                toast_lang_switched: (isZh) => `Language switched to ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'} (saved)`, toast_key_ok: 'Gemini API Key validated! Service core started.', toast_key_bad: 'Gemini API Key error or invalid.', toast_need_key: 'Please enter a valid Gemini Key in API settings first.', toast_import_error: 'Please fill Asset Name & Location.', toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`, toast_ai_summarizing: 'AI summarizing in progress...', toast_ai_summarize_ok: 'Summarization complete! Result filled into description.', toast_import_csv_error: 'CSV import failed. Check file and format (requires title, location columns).', toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`, toast_network_error: 'Connection failed, please check network.', user_location: 'Your Current Location',
                toast_fetching_ai: 'Activating Gemini AI to extract and structure cultural assets from web sources...',
                toast_fetch_ok_ai: (count) => `âœ… AI successfully extracted ${count} items. RAG knowledge base updated.`,
                toast_fetch_error_ai: 'AI data fetching and extraction failed. Check Gemini Key or API limits.',
            }
        };

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç®¡ç†
        const state = {Â 
            lang: localStorage.getItem('lang') || 'zh-Hant',Â 
            ragReady: localStorage.getItem('ragReady') === 'true',Â 
            geminiKey: localStorage.getItem('geminiKey') || '',Â 
            knowledge: [],Â 
            filter: 'all',Â 
            search: '',
            watchID: null // ç”¨æ–¼å„²å­˜ watchPosition ID
        };

        // é è¨­çŸ¥è­˜åº«è³‡æ–™
        const DEFAULT_KB = [
            { id: '1', type: 'monument', title_zh: 'èµ¤å´æ¨“', info_zh: 'å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Chikan+Tower', desc: 'èµ¤å´æ¨“å§‹å»ºæ–¼ 1653 å¹´ï¼Œç‚ºè·è˜­äººæ‰€å»ºï¼Œæ­·ç¶“æ¸…æœé‡å»ºèˆ‡æ—¥æ²»æ™‚æœŸä¿®ç¹•ï¼Œæ˜¯å°å—æœ€å…·ä»£è¡¨æ€§çš„å¤è¹Ÿä¹‹ä¸€ã€‚' },
            { id: '2', type: 'museum', title_zh: 'è¥¿é–€ç´…æ¨“', info_zh: 'å°åŒ—å¸‚ / æ­·å²å»ºç¯‰', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Red+House', desc: 'è¥¿é–€ç´…æ¨“æ˜¯ä¸€åº§å…©å±¤é«˜çš„ç´…ç£šæ´‹æ¨“ï¼Œè¦‹è­‰äº†è¥¿é–€ç”ºçš„æ­·å²ç™¼å±•ã€‚' },
            { id: '3', type: 'intangible', title_zh: 'åª½ç¥–ç¹å¢ƒ', info_zh: 'ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/640x360/222233/aaaaaa?text=Mazu+Pilgrimage', desc: 'ä¸­å…ƒæ™®æ¸¡æ°‘ä¿—èˆ‡å®—æ•™æ–‡åŒ–çš„ä»£è¡¨æ´»å‹•ä¹‹ä¸€ï¼Œå¼·èª¿å°å…ˆäººæ•¬æ„èˆ‡ç¤¾ç¾¤é€£çµã€‚' }
        ];
        
        // *** æ–°å¢ï¼šGemini çµæ§‹åŒ–è¼¸å‡ºçš„ JSON Schema (å®šç¾©æ–‡åŒ–è³‡ç”¢çš„è³‡æ–™çµæ§‹) ***
        const CULTURAL_ASSET_SCHEMA = {
            type: "array",
            items: {
                type: "object",
                properties: {
                    title_zh: { type: "string", description: "æ–‡åŒ–è³‡ç”¢çš„ä¸­æ–‡åç¨±ï¼Œä¾‹å¦‚: èµ¤å´æ¨“" },
                    info_zh: { type: "string", description: "ç°¡çŸ­è³‡è¨Šï¼Œä¾‹å¦‚: å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ" },
                    desc: { type: "string", description: "è©³ç´°æè¿° (100å­—å…§)ï¼Œç”¨æ–¼ RAG çŸ¥è­˜åº«" },
                    type: { type: "string", enum: ["monument", "museum", "intangible", "historic_site", "other"], description: "è³‡ç”¢é¡å‹" },
                },
                required: ["title_zh", "info_zh", "desc", "type"],
            }
        };

        // DOM å…ƒç´ è®Šæ•¸
        const ragDot = $('#rag-dot'); const ragText = $('#rag-text'); const btnSaveAPI = $('#btn-save-api'); const inputGemini = $('#gemini-api');
        const btnZh = $('#btn-zh'); const btnEn = $('#btn-en');
        const kbGrid = $('#kb-grid'); const kbTpl = $('#kb-card-tpl'); const kbSearch = $('#kb-search'); const filterButtons = $$('.filter');
        const btnAutoFetch = $('#btn-auto-fetch'); // æ–°å¢
        const chatBox = $('#chat'); const chatInput = $('#chat-input'); const btnSend = $('#btn-send');
        const localToggle = $('#local-toggle'); const localBody = $('#local-body'); const meToggle = $('#me-toggle'); const meBody = $('#me-body');
        const modal = $('#import-modal'); const btnImport = $('#btn-import'); const btnCloseModal = $('#btn-close-modal'); const btnCancel = $('#btn-cancel'); const importForm = $('#import-form');
        const inputName = $('#asset-name'); const inputLoc = $('#asset-location'); const inputType = $('#asset-type'); const inputImgUrl = $('#asset-img-url'); const inputDesc = $('#asset-desc'); const btnAiSummarize = $('#btn-ai-summarize'); const inputFileCsv = $('#asset-csv-file'); const btnImportCsv = $('#btn-import-csv');
        const toaster = $('#toast');
        
        // åœ°åœ–ç›¸é—œè®Šæ•¸
        const localMapContainer = $('#local-map');
        const localDataList = $('#local-data-list');
        let localMap = null;Â 
        let markers = null;

        // ----------------------------------------------------------------------
        // I. é€šç”¨å·¥å…·èˆ‡ I18N
        // ----------------------------------------------------------------------

        function t(key, arg){Â 
            const lang = state.lang in i18n ? state.lang : 'zh-Hant';Â 
            let val = i18n[lang][key];Â 
            
            if (typeof val === 'function') {
                return val(arg);
            }
            return val ?? key;Â 
        }

        function toast(message, type='info', duration=3000) {
            if (!toaster) return;
            toaster.textContent = message;
            toaster.className = `toast show ${type}`;
            setTimeout(() => {
                toaster.className = 'toast';
            }, duration);
        }
        
        function toggleSection(body, header) {
            const isExpanded = body.hidden;
            body.hidden = !isExpanded;
            header.setAttribute('aria-expanded', isExpanded);
            header.querySelector('.caret').textContent = isExpanded ? 'â–¼' : 'â–²';
        }

        // ----------------------------------------------------------------------
        // II. API & RAG æœå‹™æ¨¡çµ„é‚è¼¯
        // ----------------------------------------------------------------------

        function setRagReady(ready) {
            state.ragReady = ready;
            localStorage.setItem('ragReady', ready);
            setRagUI(ready);
            
            chatBox.innerHTML = '';
            const messageKey = ready ?Â 
                t('chat_init').replace('æœªå•Ÿå‹•', 'å·²æ–¼ä¸Šæ¬¡é€£ç·šæ™‚å•Ÿå‹•') :Â 
                t('chat_init');Â 
            addBubble('ai', messageKey);

            if (ready) {
                toast(t('toast_key_ok'), 'success');
            } else {
                if(inputGemini.value.trim().length > 0) {
                    toast(t('toast_key_bad'), 'error');
                }
            }
        }

        function setRagUI(ready) {Â 
            if (ready) {Â 
                ragDot.classList.add('ok');Â 
                ragText.textContent = (state.lang === 'zh-Hant') ? 'RAG æœå‹™ï¼šå·²é€£ç·š' : 'RAG Service: Connected';Â 
            } else {Â 
                ragDot.classList.remove('ok');Â 
                ragText.textContent = t('status_rag');Â 
            }Â 
        }
        
        function saveApiKeys() {
            const newGeminiKey = inputGemini.value.trim();

            if (newGeminiKey && newGeminiKey.length > 20) {
                state.geminiKey = newGeminiKey;
                localStorage.setItem('geminiKey', newGeminiKey);
                setRagReady(true);
            } else if (newGeminiKey === '') {
                state.geminiKey = '';
                localStorage.removeItem('geminiKey');
                setRagReady(false);
            } else {
                setRagReady(false);
            }
        }

        // ----------------------------------------------------------------------
        // III. AI èŠå¤©æ¨¡çµ„é‚è¼¯
        // ----------------------------------------------------------------------

        async function handleChat(message) {
            const msg = message.trim();
            if (!msg) return;

            if (!state.ragReady) {
                toast(t('toast_need_key'), 'error', 3000);
                return;
            }

            addBubble('user', msg);
            chatInput.value = '';

            addBubble('ai', '... (ğŸ¤– AI æ€è€ƒä¸­)');
            const thinkingBubble = chatBox.lastElementChild;

            try {
                const kbContext = state.knowledge.map(k =>
                    `ID: ${k.id}, æ¨™é¡Œ: ${k.title_zh}, åœ°é»: ${k.info_zh}, æè¿°: ${k.desc}`
                ).join('\n---\n');

                const systemInstruction = (state.lang === 'zh-Hant') ?
                    "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ–‡åŒ–å°è¦½å“¡ã€‚è«‹æ ¹æ“šä»¥ä¸‹ã€Œæ–‡åŒ–çŸ¥è­˜åº«ã€çš„è³‡æ–™ï¼Œä»¥è¦ªåˆ‡ã€å°ˆæ¥­çš„èªæ°£å›ç­”ç”¨æˆ¶çš„å•é¡Œã€‚å¦‚æœè³‡æ–™ä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹ç¦®è²Œåœ°èªªæ˜ä¸¦æä¾›å…¶ä»–å»ºè­°ï¼Œä½†ä¸è¦è‡†æ¸¬ç­”æ¡ˆã€‚" :
                    "You are an expert cultural tour guide. Use the following 'Cultural Knowledge Base' to answer the user's questions in a friendly and professional tone. If the information is not available in the provided data, politely state that you cannot find the relevant information, but do not hallucinate answers.";

                const prompt = `${systemInstruction}\n\næ–‡åŒ–çŸ¥è­˜åº«:\n${kbContext}\n\nç”¨æˆ¶å•é¡Œ: ${msg}`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + state.geminiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        config: { temperature: 0.7 }
                    })
                });

                const data = await response.json();

                if (thinkingBubble) thinkingBubble.remove();

                if (response.ok && data.candidates && data.candidates[0].content) {
                    const aiReply = data.candidates[0].content.parts[0].text;
                    addBubble('ai', aiReply);
                } else if (data.error) {
                    console.error('Gemini API éŒ¯èª¤:', data.error);
                    addBubble('ai', (state.lang === 'zh-Hant') ?
                        `[ç³»çµ±éŒ¯èª¤] æŠ±æ­‰ï¼ŒAPI å‘¼å«å¤±æ•—ï¼ŒéŒ¯èª¤ä»£ç¢¼: ${data.error.code}ã€‚è«‹æª¢æŸ¥æ‚¨çš„é‡‘é‘°æ¬Šé™æˆ–é¡åº¦ã€‚` :
                        `[System Error] Sorry, API call failed with code: ${data.error.code}. Please check your key permissions or quota.`
                    );
                    toast(t('toast_key_bad') + ` (API Error: ${data.error.code})`, 'error', 5000);
                } else {
                     addBubble('ai', (state.lang === 'zh-Hant') ?
                        `[ç³»çµ±è¨Šæ¯] æŠ±æ­‰ï¼ŒAI æœªèƒ½ç”¢ç”Ÿæœ‰æ•ˆå›è¦†ã€‚è«‹å˜—è©¦å…¶ä»–å•é¡Œã€‚` :
                        `[System Message] Sorry, the AI failed to generate a valid response. Please try another question.`
                    );
                }

            } catch (error) {
                console.error('ç¶²è·¯æˆ– API å‘¼å«éŒ¯èª¤:', error);
                if (thinkingBubble) thinkingBubble.remove();
                addBubble('ai', (state.lang === 'zh-Hant') ? 
                    `[ç¶²è·¯éŒ¯èª¤] ${t('toast_network_error')}` :
                    `[Network Error] ${t('toast_network_error')}`
                );
                toast(t('toast_network_error'), 'error', 4000);
            }
        }

        function addBubble(type, text) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.textContent = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ----------------------------------------------------------------------
        // IV. åœ°ç†å®šä½èˆ‡åœ°åœ–æ¨¡çµ„é‚è¼¯ (å¯¦æ™‚ GPS è¿½è¹¤)
        // ----------------------------------------------------------------------

        function initMap() {
            if (localMapContainer && !localMapContainer.querySelector('.leaflet-container')) {
                localMap = L.map('local-map', {
                    center: [23.00, 120.21], 
                    zoom: 13,
                    zoomControl: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(localMap);
                
                markers = L.layerGroup().addTo(localMap);
            }
        }

        /**
         * åˆå§‹åŒ–åœ°ç†å®šä½ï¼Œä¸¦å•Ÿå‹•å¯¦æ™‚ä½ç½®è¿½è¹¤ (watchPosition)
         */
        function getGeolocation() {
            if (!navigator.geolocation) {
                localDataList.innerHTML = `<li style="color:var(--bad)">[ç³»çµ±è¨Šæ¯] æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½ã€‚</li>`;
                return;
            }

            // æ¸…é™¤èˆŠçš„è¿½è¹¤ï¼Œç¢ºä¿åªé‹è¡Œä¸€å€‹ watchPosition
            if (state.watchID !== null) {
                navigator.geolocation.clearWatch(state.watchID);
                state.watchID = null;
            }

            localDataList.innerHTML = `<li style="text-align:center; color:var(--pri)">æ­£åœ¨è«‹æ±‚åœ°ç†å®šä½ä¸¦å•Ÿå‹•å¯¦æ™‚è¿½è¹¤...</li>`;

            const geoOptions = { 
                enableHighAccuracy: true, 
                timeout: 10000,           // æ¯æ¬¡å®šä½å˜—è©¦çš„æœ€å¤§ç­‰å¾…æ™‚é–“
                maximumAge: 0,            // ä¸ä½¿ç”¨å¿«å–ä½ç½®
            };

            // æˆåŠŸå›å‘¼å‡½å¼ (ç•¶ä½ç½®æ›´æ–°æ™‚åŸ·è¡Œ)
            const successCallback = (position) => {
                const { latitude, longitude } = position.coords;
                // æ¯æ¬¡ä½ç½®æ›´æ–°æ™‚ï¼Œåªå‘¼å« updateLocalInfo ä¾†æ›´æ–° UI
                updateLocalInfo(latitude, longitude); 
                toast((state.lang === 'zh-Hant') ? `GPS å¯¦æ™‚æ›´æ–°ï¼šå–å¾—æ–°ä½ç½® (${latitude.toFixed(2)}, ${longitude.toFixed(2)})` : `GPS updated: New position (${latitude.toFixed(2)}, ${longitude.toFixed(2)})`, 'info', 1500);
            };

            // éŒ¯èª¤å›å‘¼å‡½å¼
            const errorCallback = (error) => {
                console.error("Geolocation Watch Error:", error);
                if (state.watchID !== null) {
                    navigator.geolocation.clearWatch(state.watchID);
                    state.watchID = null;
                }

                localDataList.innerHTML = `<li style="color:var(--bad)">[è¿½è¹¤å¤±æ•—] è«‹å…è¨±åœ°ç†å®šä½æˆ–æª¢æŸ¥ GPS è¨Šè™Ÿã€‚</li>`;
                
                // è¿½è¹¤å¤±æ•—æ™‚ï¼Œä»ä»¥å°å—èµ¤å´æ¨“ç‚ºä¸­å¿ƒé»ä½œç‚ºå‚™ç”¨
                updateLocalInfo(22.99723, 120.20336);
            };

            // å•Ÿå‹•å¯¦æ™‚ä½ç½®è¿½è¹¤
            state.watchID = navigator.geolocation.watchPosition(
                successCallback,
                errorCallback,
                geoOptions
            );
        }

        function updateLocalInfo(lat, lng) {
            if (!localMap) return;

            const userLocation = L.latLng(lat, lng);
            localMap.setView(userLocation, 14); 

            markers.clearLayers();
            L.circleMarker(userLocation, {
                radius: 8,
                fillColor: "#3399ff",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(markers).bindPopup(t('user_location'));
            
            // æ¨¡æ“¬é–‹æ”¾è³‡æ–™ (é€™è£¡çš„æ•¸æ“šæ˜¯éœæ…‹çš„ï¼Œä½†åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œæœƒæ˜¯å¾ PTX ç­‰ API æŠ“å–ä¸¦éš¨å®šä½æ›´æ–°)
            const mockData = [
                { type: 'KB', lat: 22.99723, lng: 120.20336, name_key: 'èµ¤å´æ¨“', info_key: (state.lang === 'zh-Hant' ? 'ä¸€ç´šå¤è¹Ÿ' : 'Grade 1 Monument'), icon: 'ğŸ›ï¸' },
                { type: 'KB', lat: 22.9961, lng: 120.2057, name_key: 'å°ç£æ–‡å­¸é¤¨', info_key: (state.lang === 'zh-Hant' ? 'åœ‹å®šå¤è¹Ÿ' : 'National Monument'), icon: 'ğŸ“š' },
                { type: 'BUS', lat: 22.9975, lng: 120.2028, name_key: t('bus_route'), info_key: t('bus_status'), icon: 'ğŸšŒ' },
                { type: 'EVENT', lat: 22.9958, lng: 120.2031, name_key: t('event_name'), info_key: t('event_status'), icon: 'ğŸ‰' }
            ];

            let listHTML = '';

            mockData.forEach(item => {
                const itemLocation = L.latLng(item.lat, item.lng);
                const distance = userLocation.distanceTo(itemLocation).toFixed(0); 
                const name = item.name_key;
                const info = item.info_key || '';

                L.marker(itemLocation, {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="chip" style="font-size:1.5rem; padding: 0.2rem; background: rgba(0,255,100,.15); border: 1px solid var(--ok);">${item.icon}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(markers).bindPopup(`<b>${name}</b><br>${info}<br>è·é›¢: ${distance} m`);

                listHTML += `
                    <li style="display:flex; justify-content:space-between; padding:.5rem; border-bottom:1px dashed var(--glass-border); align-items:center;">
                        <span style="display:flex; gap:.6rem; align-items:center;">
                            <span class="chip" style="font-size:1.1rem; padding:.25rem">${item.icon}</span>
                            <span style="flex-grow:1;">
                                <span style="font-weight:700">${name}</span><br>
                                <span style="color:var(--pri); font-size:.9rem">${info}</span>
                            </span>
                        </span>
                        <span style="font-family:'Orbitron', monospace; color:var(--sec); font-size:.9rem">${distance} m</span>
                    </li>
                `;
            });

            localDataList.innerHTML = listHTML;
        }


        // ----------------------------------------------------------------------
        // V. çŸ¥è­˜åº«èˆ‡è³‡æ–™ç®¡ç†é‚è¼¯
        // ----------------------------------------------------------------------

        function loadKnowledge() {
            state.knowledge = [...DEFAULT_KB];
            const customKB = JSON.parse(localStorage.getItem('customKnowledge') || '[]');
            state.knowledge.push(...customKB);
        }

        function renderKB() {
            const currentLang = state.lang;
            const searchTerm = kbSearch.value.trim().toLowerCase();

            const filteredKB = state.knowledge.filter(item => {
                const typeMatch = state.filter === 'all' || item.type === state.filter;
                // æœå°‹åŒæ™‚åŒ¹é…ä¸­æ–‡å’Œè‹±æ–‡æ¨™é¡Œ/è³‡è¨Š
                const searchMatch = !searchTerm || 
                    item.title_zh.toLowerCase().includes(searchTerm) || 
                    item.info_zh.toLowerCase().includes(searchTerm) ||
                    (item.title_en && item.title_en.toLowerCase().includes(searchTerm)) ||
                    (item.info_en && item.info_en.toLowerCase().includes(searchTerm)) ||
                    item.desc.toLowerCase().includes(searchTerm);
                return typeMatch && searchMatch;
            });

            kbGrid.innerHTML = filteredKB.map(item => {
                const tpl = kbTpl.content.cloneNode(true);
                const card = tpl.querySelector('.kb-card');
                const titleEl = tpl.querySelector('.title');
                const metaEl = tpl.querySelector('.meta');
                const imgEl = tpl.querySelector('img');

                card.setAttribute('data-id', item.id);
                titleEl.textContent = currentLang === 'zh-Hant' ? item.title_zh : item.title_en;
                metaEl.textContent = currentLang === 'zh-Hant' ? item.info_zh : item.info_en;
                imgEl.src = item.img_url;
                imgEl.alt = titleEl.textContent;

                return tpl.firstElementChild.outerHTML;
            }).join('');
        }
        
        // --- çŸ¥è­˜åº«ç¯©é¸èˆ‡å¤šèªè¨€ ---

        function handleFilterClick(e) {
            const filterValue = e.target.dataset.filter;
            if (filterValue) {
                state.filter = filterValue;
                filterButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderKB();
            }
        }

        function switchLang(e) {
            const newLang = e.target.dataset.lang;
            if (newLang !== state.lang) {
                applyLang(newLang);
                setRagUI(state.ragReady);
                toast(t('toast_lang_switched', newLang === 'zh-Hant'), 'info');
            }
        }
        
        function applyLang(lang) {
            state.lang = lang;
            localStorage.setItem('lang', lang);
            $$('[data-key]').forEach(el => {
                const key = el.dataset.key;
                let text = i18n[lang] && i18n[lang][key] ? i18n[lang][key] : key;

                if (typeof text === 'function') {
                    // å¿½ç•¥å‡½æ•¸å‹ç¿»è­¯
                    return;
                }

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = text;
                } else {
                    if (key === 'chat_init') {
                        if (state.ragReady) {
                             text = text.replace('æœªå•Ÿå‹•', 'å·²æ–¼ä¸Šæ¬¡é€£ç·šæ™‚å•Ÿå‹•').replace('Offline', 'Online');
                        }
                    }
                    el.textContent = text;
                }
            });
            // é‡æ–°æ¸²æŸ“çŸ¥è­˜åº«ï¼Œç¢ºä¿å¡ç‰‡å…§å®¹èªè¨€æ­£ç¢º
            renderKB();
        }

        // --- è‡ªå‹•çˆ¬å–è³‡æ–™ (Gemini æŠ½å–) ---

        /**
         * æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ©ç”¨ Google Search ç²å–æœ€æ–°çš„æ–‡åŒ–è³‡ç”¢è³‡è¨Šï¼Œ
         * ä¸¦ä½¿ç”¨ Gemini çµæ§‹åŒ–è¼¸å‡ºåŠŸèƒ½ï¼Œå°‡è³‡è¨ŠæŠ½å–ä¸¦æ ¼å¼åŒ–æˆçŸ¥è­˜åº« JSONã€‚
         */
        async function fetchCulturalAssets() {
            if (!state.ragReady) {
                toast(t('toast_need_key'), 'error', 3000);
                return;
            }
            
            toast(t('toast_fetching_ai'), 'info', 5000); // æ›´æ”¹ toast è¨Šæ¯
            btnAutoFetch.disabled = true;

            try {
                // æ­¥é©Ÿ 1: ä½¿ç”¨ Google Search ç²å–æœ€æ–°çš„æ–‡åŒ–è³‡ç”¢ç›¸é—œç¶²é æ‘˜è¦
                const searchQuery = (state.lang === 'zh-Hant') ? 
                    'æœ€æ–°è‡ºç£æ–‡åŒ–è³‡ç”¢å…¬å‘Š' : 
                    'latest Taiwan cultural heritage news';

                const searchResults = await google.search({ queries: [searchQuery] });
                
                if (!searchResults.results || searchResults.results.length === 0) {
                    throw new Error("No search results found.");
                }

                // çµ„åˆå‰ 5 å€‹æœç´¢çµæœçš„ Snippet æ–‡æœ¬ï¼Œä½œç‚º Gemini çš„è¼¸å…¥æº
                const combinedContext = searchResults.results.slice(0, 5).map((res, index) => 
                    `ä¾†æº ${index + 1} (${res.source_title}): ${res.snippet}`
                ).join('\n---\n');

                // æ­¥é©Ÿ 2: å‘¼å« Gemini API é€²è¡Œçµæ§‹åŒ–è³‡æ–™æŠ½å– (Gemini 2.5 Flash)
                const geminiPrompt = `
                    ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è³‡æ–™æŠ½å–æ©Ÿå™¨äººã€‚è«‹æ ¹æ“šä»¥ä¸‹ç¶²é å…§å®¹æ‘˜è¦ï¼Œ
                    è­˜åˆ¥ä¸¦æŠ½å– 3 åˆ° 5 å€‹æœ€æ–°çš„æ–‡åŒ–è³‡ç”¢è³‡è¨Šã€‚
                    å¿½ç•¥å»£å‘Šæˆ–ä¸ç›¸é—œçš„å…§å®¹ã€‚è«‹å‹™å¿…éµå¾ªæä¾›çš„ JSON çµæ§‹è¼¸å‡ºã€‚
                `;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + state.geminiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${geminiPrompt}\n\nåŸå§‹è³‡è¨Š:\n${combinedContext}` }] }],
                        config: {
                            temperature: 0.1, // é™ä½æº«åº¦ä»¥ç¢ºä¿è¼¸å‡ºç©©å®šå’Œçµæ§‹åŒ–
                            responseMimeType: "application/json",
                            responseSchema: CULTURAL_ASSET_SCHEMA
                        }
                    })
                });

                const data = await response.json();

                if (response.ok && data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0].text) {
                    const rawJsonText = data.candidates[0].content.parts[0].text;
                    const fetchedAssets = JSON.parse(rawJsonText);

                    if (!Array.isArray(fetchedAssets) || fetchedAssets.length === 0) {
                        throw new Error("Gemini returned empty or invalid JSON array.");
                    }
                    
                    const newAssets = fetchedAssets.map((item, index) => ({
                        id: `ai-fetched-${Date.now()}-${index}`,
                        type: item.type || 'other',
                        title_zh: item.title_zh || 'æœªå‘½å',
                        info_zh: item.info_zh || 'AI æŠ½å–è‡ªç¶²è·¯',
                        title_en: item.title_zh || 'Unnamed Asset', // ç°¡æ˜“è™•ç†ï¼šè‹±æ–‡ä½¿ç”¨ä¸­æ–‡å…§å®¹
                        info_en: item.info_zh || 'AI extracted from web',
                        img_url: `https://via.placeholder.com/640x360/445544/cccccc?text=AI+Fetched+${index+1}`,
                        desc: item.desc || 'AI æŠ½å–è³‡æ–™ï¼Œè«‹é€²ä¸€æ­¥æŸ¥è­‰ã€‚'
                    }));

                    // æ­¥é©Ÿ 3: æ›´æ–°çŸ¥è­˜åº«
                    state.knowledge.push(...newAssets);
                    renderKB();
                    toast(t('toast_fetch_ok_ai', newAssets.length), 'success', 4000);
                } else {
                    console.error("Gemini API Error Response:", data);
                    throw new Error(data.error?.message || "Gemini AI çµæ§‹åŒ–è¼¸å‡ºå¤±æ•—ã€‚");
                }

            } catch (error) {
                console.error('AI è‡ªå‹•çˆ¬å–è³‡æ–™å¤±æ•—:', error);
                toast(`${t('toast_fetch_error_ai')} (${error.message.substring(0, 50)}...)`, 'error', 7000);
            } finally {
                btnAutoFetch.disabled = false;
            }
        }


        // --- CSV åŒ¯å…¥é‚è¼¯ (ä¿æŒä¸è®Š) ---

        function parseCsv(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const csvData = event.target.result;
                    const lines = csvData.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) { return reject(new Error("CSV æª”æ¡ˆå…§å®¹ç‚ºç©ºã€‚")); }
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    const requiredHeaders = ['title', 'location'];
                    if (!requiredHeaders.every(rh => headers.includes(rh))) { return reject(new Error(`CSV æ¨™é ­ç¼ºå¤±ã€‚éœ€è¦ï¼š${requiredHeaders.join(', ')}`)); }
                    const results = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length !== headers.length) continue;
                        const asset = {
                            id: `custom-${Date.now()}-${i}`,
                            type: values[headers.indexOf('type')]?.trim() || 'custom',
                            title_zh: values[headers.indexOf('title')]?.trim() || 'æœªå‘½åè³‡ç”¢',
                            info_zh: values[headers.indexOf('location')]?.trim() || 'æœªçŸ¥åœ°é»',
                            title_en: values[headers.indexOf('title_en')]?.trim() || (values[headers.indexOf('title')]?.trim() || 'Unnamed Asset'),
                            info_en: values[headers.indexOf('location_en')]?.trim() || (values[headers.indexOf('location')]?.trim() || 'Unknown Location'),
                            img_url: values[headers.indexOf('img_url')]?.trim() || 'https://via.placeholder.com/640x360/4a4a4a/cccccc?text=Custom+Asset',
                            desc: values[headers.indexOf('desc')]?.trim() || (state.lang === 'zh-Hant' ? 'ä½¿ç”¨è€…è‡ªå®šç¾©è³‡æ–™' : 'User defined data'),
                        };
                        results.push(asset);
                    }
                    resolve(results);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }

        function addCustomAsset(name, location, type, imgUrl, desc) {
            const newAsset = {
                id: `custom-${Date.now()}`,
                type: type || 'custom',
                title_zh: name,
                info_zh: location,
                title_en: name,
                info_en: location,
                img_url: imgUrl || 'https://via.placeholder.com/640x360/4a4a4a/cccccc?text=Custom+Asset',
                desc: desc || (state.lang === 'zh-Hant' ? 'ä½¿ç”¨è€…è‡ªå®šç¾©è³‡æ–™ï¼Œç„¡æè¿°ã€‚' : 'User defined asset, no description.')
            };
            state.knowledge.push(newAsset);
            const customKB = state.knowledge.filter(k => k.id.startsWith('custom'));
            localStorage.setItem('customKnowledge', JSON.stringify(customKB));
            renderKB();
            toast(t('toast_import_ok', name), 'success');
        }

        async function handleCsvImport() {
            const file = inputFileCsv.files[0];
            if (!file) return;
            modal.close();
            toast(t('toast_ai_summarizing').replace('AI æ‘˜è¦', 'CSV æ‰¹æ¬¡åŒ¯å…¥'), 'info', 5000);
            try {
                const newAssets = await parseCsv(file);
                if (newAssets.length === 0) { throw new Error('è§£ææˆåŠŸï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆè³‡æ–™è¡Œã€‚'); }
                state.knowledge.push(...newAssets);
                const customKB = state.knowledge.filter(k => k.id.startsWith('custom'));
                localStorage.setItem('customKnowledge', JSON.stringify(customKB));
                renderKB();
                toast(t('toast_import_csv_ok', newAssets.length), 'success', 4000);
            } catch (error) {
                console.error('CSV åŒ¯å…¥å¤±æ•—:', error);
                toast(t('toast_import_csv_error') + ' (' + error.message + ')', 'error', 5000);
            }
        }

        // ----------------------------------------------------------------------
        // VI. åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
        // ----------------------------------------------------------------------

        function arInit() {
            const mv = $('#mv-anping');
            if (mv) {
                mv.querySelectorAll('.hotspot').forEach(hotspot => {
                    const anno = mv.querySelector(`.annotation[slot="annotation-${hotspot.slot.split('-')[1]}"]`);
                    if (!anno) return;

                    hotspot.addEventListener('mouseover', () => { anno.style.display = 'block'; });
                    hotspot.addEventListener('mouseout', () => { anno.style.display = 'none'; });
                    // ç‚ºäº†è§¸æ§è£ç½®ï¼Œé»æ“Šä¹Ÿé¡¯ç¤º
                    hotspot.addEventListener('click', (e) => { 
                        e.stopPropagation(); // é˜²æ­¢é»æ“Šæ¨¡å‹æœ¬èº«
                        anno.style.display = (anno.style.display === 'block') ? 'none' : 'block'; 
                    });
                });
            }
        }
        
        function vrGuard() {
             // ç¢ºä¿ a-scene è¨­ç½®æ­£ç¢ºï¼Œé€šå¸¸ A-Frame æœƒè‡ªå‹•è™•ç†
             const aScene = $('a-scene');
             if (aScene) aScene.setAttribute('vr-mode-ui', 'enabled: false');
        }

        function bindEvents(){
            // èªè¨€åˆ‡æ›
            btnZh.addEventListener('click', switchLang);
            btnEn.addEventListener('click', switchLang);
            
            // API æœå‹™æ¨¡çµ„
            btnSaveAPI.addEventListener('click', saveApiKeys);
            
            // èŠå¤©å®¤ç™¼é€
            btnSend.addEventListener('click', () => handleChat(chatInput.value));
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleChat(chatInput.value);
                }
            });
            
            // çŸ¥è­˜åº«ç¯©é¸èˆ‡æœå°‹
            filterButtons.forEach(btn => btn.addEventListener('click', handleFilterClick));
            kbSearch.addEventListener('input', renderKB);
            // çŸ¥è­˜åº«è‡ªå‹•çˆ¬å– (æ–°)
            btnAutoFetch.addEventListener('click', fetchCulturalAssets);
            
            // æ‘ºç–ŠåŠŸèƒ½
            localToggle.addEventListener('click', toggleSection.bind(null, localBody, localToggle));
            meToggle.addEventListener('click', toggleSection.bind(null, meBody, meToggle));
            
            // åŒ¯å…¥æ¨¡çµ„äº‹ä»¶
            btnImport.addEventListener('click', () => modal.showModal());
            btnCloseModal.addEventListener('click', () => modal.close());
            btnCancel.addEventListener('click', () => modal.close());

            // å–®ç­†åŒ¯å…¥
            importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!inputName.value.trim() || !inputLoc.value.trim()) {
                    toast(t('toast_import_error'), 'error');
                    return;
                }
                addCustomAsset(inputName.value, inputLoc.value, inputType.value, inputImgUrl.value, inputDesc.value);
                importForm.reset();
                modal.close();
            });
            
            // æ‰¹æ¬¡åŒ¯å…¥ CSV
            btnImportCsv.addEventListener('click', handleCsvImport);

            // AI æ‘˜è¦ (æ¨¡æ“¬)
            btnAiSummarize.addEventListener('click', () => {
                toast(t('toast_ai_summarizing'), 'info', 1500);
                setTimeout(() => {
                    const summary = (state.lang === 'zh-Hant') ? 
                        `[AI æ‘˜è¦çµæœ] é€™æ˜¯ä¸€å€‹é—œæ–¼ ${inputName.value || 'æœªçŸ¥'} åœ°é»çš„æ–‡åŒ–è³‡ç”¢ï¼Œå±¬æ–¼ ${inputType.value || 'è‡ªå®šç¾©'} é¡åˆ¥ã€‚` : 
                        `[AI Summary] This is about a cultural asset at ${inputLoc.value || 'Unknown'} of type ${inputType.value || 'custom'}.`;
                    inputDesc.value = summary;
                    toast(t('toast_ai_summarize_ok'), 'success');
                }, 1800);
            });
        }

        function init(){Â 
            inputGemini.value = state.geminiKey;Â 
            setRagUI(state.ragReady);Â 
            // åˆå§‹åŒ–èªè¨€
            applyLang(state.lang);Â 
            
            loadKnowledge();Â 
            renderKB();Â 
            bindEvents();Â 
            
            initMap();Â 
            getGeolocation(); // å•Ÿå‹•å¯¦æ™‚ GPS è¿½è¹¤
            
            arInit();Â 
            vrGuard();Â 
        }

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
