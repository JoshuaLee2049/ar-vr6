<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文化智遊 - AI 科技儀表板</title>
    <style>
        /* ============================================== */
        /* --- 科技儀表板 - 全局變量與深色主題優化 (維持不變) --- */
        /* ============================================== */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');
        :root {
            --bg-color-dark: #070718;
            --primary-color: #00ffff; 
            --secondary-color: #bb00ff; 
            --text-color: #e6f7ff; 
            --text-muted: #8090a0;
            --glass-bg: rgba(0, 0, 0, 0.7); 
            --glass-border: rgba(0, 255, 255, 0.2); 
            --glass-border-dark: rgba(255, 255, 255, 0.05);
            --soft-glow-primary: 0 0 15px rgba(0, 255, 255, 0.4), 0 0 5px rgba(0, 255, 255, 0.2);
            --soft-glow-secondary: 0 0 15px rgba(187, 0, 255, 0.4), 0 0 5px rgba(187, 0, 255, 0.2);
            --success-color: #4aff8f; 
            --error-color: #ff4a4a;
            --radius: 18px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color-dark);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(0, 255, 255, 0.1), transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(187, 0, 255, 0.1), transparent 35%),
                linear-gradient(135deg, #070718 0%, #030018 100%);
            color: var(--text-color);
            padding: 2.5rem; 
            min-height: 100vh;
        }

        /* 核心元件樣式 (玻璃面板、按鈕、輸入框等與前版本相同，為節省空間僅列出主要變數，但所有細節仍被保留) */
        .glass-panel {
            background: var(--glass-bg);
            border-radius: var(--radius);
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border-dark);
            border-image: linear-gradient(45deg, rgba(0, 255, 255, 0.3) 0%, rgba(187, 0, 255, 0.3) 50%, rgba(0, 255, 255, 0.3) 100%) 1;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7), 0 0 20px rgba(0, 255, 255, 0.05), 0 0 40px rgba(187, 0, 255, 0.1);
            padding: 2rem; 
            margin-bottom: 2rem;
            transition: all 0.4s ease;
        }
        .glass-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(0, 0, 0, 0.8), var(--soft-glow-primary);
        }
        .module-header-icon {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--bg-color-dark);
            font-family: 'Orbitron', monospace;
            border-radius: 10px;
        }
        .module-header h2 { color: var(--primary-color); text-shadow: 0 0 5px rgba(0, 255, 255, 0.3); }
        .tech-button {
            border: 2px solid var(--primary-color);
            color: var(--primary-color); 
            background: rgba(0, 255, 255, 0.05);
            border-radius: 10px;
            font-family: 'Noto Sans TC', sans-serif; 
            letter-spacing: 1px;
            text-transform: none;
        }
        .tech-button.primary { 
            background: linear-gradient(90deg, var(--primary-color), #00aaff);
            color: var(--bg-color-dark); 
        }
        .tech-input {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border-dark); 
            border-radius: 10px;
            color: var(--text-color); 
        }
        .main-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2rem; }
        
        /* Modal & Lang Switch 樣式 (維持不變) */
        .modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal-content {
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--soft-glow-primary);
            padding: 2.5rem;
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { border-bottom: 2px solid var(--secondary-color); }
        .close-btn { color: var(--text-muted); font-size: 2rem; }

        .lang-switch {
            position: absolute;
            top: 2.5rem;
            right: 2.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            z-index: 100;
        }
        .lang-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border-dark);
            color: var(--text-muted);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .lang-btn.active, .lang-btn:hover {
            background: var(--primary-color);
            color: var(--bg-color-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }

        /* 響應式設計 (維持不變) */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .main-grid { grid-template-columns: 1fr; gap: 1rem; }
            .lang-switch { position: static; justify-content: flex-start; margin-bottom: 1rem; }
        }
    </style>
</head>
<body>

    <div class="lang-switch">
        <span style="color: var(--text-color); font-size: 0.9rem;">介面語言:</span>
        <button class="lang-btn active" data-lang="zh-Hant" id="lang-zh-hant">繁體中文</button>
        <button class="lang-btn" data-lang="en" id="lang-en">English</button>
    </div>

    <header class="header-zone">
        <h1 data-key="title">文化智遊儀表板</h1>
        <nav class="nav-links">
            <a href="#" class="active" data-key="nav_guide">導覽</a>
            <a href="#" data-key="nav_knowledge">知識庫</a>
            <a href="#" data-key="nav_experience">體驗</a>
            <a href="#" data-key="nav_personal">個人中心</a>
        </nav>
    </header>

    <main class="main-grid">

        <section class="glass-panel api-settings">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">API</span></div>
                <h2 data-key="h2_api">API 整合服務模組</h2>
                <p data-key="p_api">系統服務狀態與金鑰設定</p>
            </div>
            <div class="api-settings-grid">
                <div class="api-key-input">
                    <label for="gemini-api-key">Gemini API Key</label>
                    <input type="password" id="gemini-api-key" class="tech-input" value="">
                </div>
                <div class="api-key-input">
                    <label for="map-api">Maps API</label>
                    <input type="password" id="map-api" class="tech-input" value="•••••••••••••••">
                </div>
                <div class="api-key-input">
                    <label for="data-api">Data.gov.tw (PTX)</label>
                    <input type="password" id="data-api" class="tech-input" value="•••••••••••••••">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end; align-items: center;">
                <div class="api-status">
                    <span class="status-dot" id="rag-status-dot"></span>
                    <span id="rag-status-text" data-key="status_rag">RAG 服務：尚未連線</span>
                </div>
                <div class="api-status">
                    <span class="status-dot active" style="background-color: var(--success-color);"></span>
                    <span data-key="status_data">開放資料：同步中</span>
                </div>
                <button class="tech-button primary" id="save-api-settings" data-key="btn_save">儲存設定</button>
            </div>
        </section>

        <section class="glass-panel ai-guide">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">AI</span></div>
                <h2 data-key="h2_guide">AI 智能導覽</h2>
                <p data-key="p_guide">您的隨身文化嚮導</p>
            </div>
            <div class="chat-window" id="chat-window">
                <div class="chat-bubble ai" data-key="chat_init">
                    [系統初始化] 檢測到 RAG 核心未啟動。請在上方輸入您的 Gemini Key 以連線文化知識庫。
                </div>
            </div>
            <div class="chat-input-area">
                <button class="tech-button"><span class="icon-text">🎤</span></button>
                <input type="text" class="tech-input" id="chat-input" data-key="placeholder_chat" placeholder="輸入您的文化問題或導覽需求...">
                <button class="tech-button primary" id="chat-send-btn" data-key="btn_send">發送</button>
            </div>
        </section>

        <section class="glass-panel knowledge-base">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">DB</span></div>
                <h2 data-key="h2_db">文化知識庫</h2>
                <p data-key="p_db">探索全台文化資產 (RAG 資料源)</p>
                <button class="tech-button" id="import-data-btn" data-key="btn_import">
                    <span class="icon-text">↓</span> 匯入新資料
                </button>
            </div>
            <div class="search-bar">
                <input type="text" class="tech-input" data-key="placeholder_search" placeholder="搜尋古蹟、文物、歷史事件...">
            </div>
            <div class="filters">
                <span class="filter-chip active" data-key="filter_all">全部</span>
                <span class="filter-chip" data-key="filter_monument">古蹟</span>
                <span class="filter-chip" data-key="filter_museum">博物館</span>
                <span class="filter-chip" data-key="filter_intangible">無形文化</span>
            </div>
            <div class="knowledge-grid" id="knowledge-grid">
                <div class="knowledge-card" data-card-id="1" data-title-zh="赤崁樓" data-info-zh="台南市 / 一級古蹟" data-title-en="Chikan Tower" data-info-en="Tainan / Grade 1 Monument">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Chikan+Tower" alt="赤崁樓">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">赤崁樓</h4>
                        <p class="card-info">台南市 / 一級古蹟</p>
                    </div>
                </div>
                <div class="knowledge-card" data-card-id="2" data-title-zh="西門紅樓" data-info-zh="台北市 / 歷史建築" data-title-en="Ximen Red House" data-info-en="Taipei / Historical Building">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Red+House" alt="西門紅樓">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">西門紅樓</h4>
                        <p class="card-info">台北市 / 歷史建築</p>
                    </div>
                </div>
                <div class="knowledge-card" data-card-id="3" data-title-zh="媽祖繞境" data-info-zh="中台灣 / 無形文化" data-title-en="Mazu Pilgrimage" data-info-en="Central Taiwan / Intangible Heritage">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Mazu+Pilgrimage" alt="媽祖繞境">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">媽祖繞境</h4>
                        <p class="card-info">中台灣 / 無形文化</p>
                    </div>
                </div>
                </div>
        </section>

        <section class="glass-panel immersive-experience">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">AR</span></div>
                <h2 data-key="h2_immersive">沉浸式體驗</h2>
                <p data-key="p_immersive">啟動您的時光機</p>
            </div>
            <div class="immersive-grid">
                 <div class="experience-card">
                    <img src="https://via.placeholder.com/400x300/331144/cccccc?text=AR+Restore" alt="AR 體驗">
                    <div class="experience-overlay">
                        <span class="ar" data-key="tag_ar">AR 實景還原</span>
                        <h4 data-key="h4_anping">安平古堡：熱蘭遮城 1632</h4>
                    </div>
                </div>
                <div class="experience-card">
                    <img src="https://via.placeholder.com/400x300/113333/cccccc?text=VR+Gallery" alt="VR 體驗">
                    <div class="experience-overlay">
                        <span data-key="tag_vr">VR 虛擬展館</span>
                        <h4 data-key="h4_taipei">已消失的台北城牆 (數位重建)</h4>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass-panel local-info">
             <div class="module-header collapsible" id="local-info-header">
                <div class="module-header-icon"><span class="icon-text">GPS</span></div>
                <h2 data-key="h2_local">在地即時資訊</h2>
                <p data-key="p_local">整合開放資料</p>
                <span class="collapse-icon">▼</span>
            </div>
            <div class="module-content">
                <div class="map-placeholder" data-key="map_placeholder">--- 互動地圖載入區域 ---</div>
                <div class="info-list">
                    <div class="info-list-item">
                        <div class="info-icon"><span class="icon-text">BUS</span></div>
                        <div class="info-text">
                            <h5 data-key="bus_route">[市區公車] 77路</h5>
                            <p data-key="bus_status">即將抵達：赤崁樓站 (3 分鐘)</p>
                        </div>
                    </div>
                    <div class="info-list-item">
                        <div class="info-icon"><span class="icon-text">EVT</span></div>
                        <div class="info-text">
                            <h5 data-key="event_name">[節慶活動] 府城文化節</h5>
                            <p data-key="event_status">進行中：孔廟園區 (距離 1.2km)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass-panel personal-center">
             <div class="module-header collapsible" id="personal-center-header">
                <div class="module-header-icon"><span class="icon-text">USR</span></div>
                <h2 data-key="h2_personal">個人化中心</h2>
                <p data-key="p_personal">您的文化足跡</p>
                <span class="collapse-icon">▼</span>
            </div>
            <div class="module-content">
                <div class="personal-grid">
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">♥</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_fav">我的收藏</h4>
                            <p data-key="card_fav_p">您已收藏 12 個景點與 3 篇導覽</p>
                        </div>
                    </div>
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">✈</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_trip">我的行程</h4>
                            <p data-key="card_trip_p">您有 1 個即將到來的行程 (台南三日遊)</p>
                        </div>
                    </div>
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">☆</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_ach">我的成就</h4>
                            <p data-key="card_ach_p">已解鎖「府城探索者」徽章</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="modal_title">匯入自定義文化資產</h3>
                <span class="close-btn">&times;</span>
            </div>
            <form id="new-data-form">
                <div class="modal-form-group">
                    <label for="asset-name" data-key="modal_label_name">資產名稱 (必填)</label>
                    <input type="text" id="asset-name" class="tech-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="asset-location" data-key="modal_label_location">地點 / 縣市 (必填)</label>
                    <input type="text" id="asset-location" class="tech-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="asset-type" data-key="modal_label_type">類型 (古蹟/博物館/無形文化...)</label>
                    <input type="text" id="asset-type" class="tech-input">
                </div>
                <div class="modal-form-group">
                    <label for="asset-desc" data-key="modal_label_desc">簡要描述 (用於 AI 導覽 RAG)</label>
                    <textarea id="asset-desc" class="tech-input"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="tech-button" data-key="btn_cancel" id="modal-cancel-btn">取消</button>
                <button class="tech-button primary" data-key="btn_submit" id="modal-submit-btn">匯入並啟用</button>
            </div>
        </div>
    </div>

    <div class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 全局狀態與 DOM 節點獲取 (維持不變) ---
            let isApiValid = false;
            let isRAGReady = false;
            let currentLang = 'zh-Hant'; // 預設語言

            const saveApiBtn = document.getElementById('save-api-settings');
            const geminiApiKeyInput = document.getElementById('gemini-api-key');
            const ragStatusDot = document.getElementById('rag-status-dot');
            const ragStatusText = document.getElementById('rag-status-text');
            const importDataBtn = document.getElementById('import-data-btn');
            const knowledgeGrid = document.getElementById('knowledge-grid');
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const collapsibleHeaders = document.querySelectorAll('.module-header.collapsible');
            const modal = document.getElementById('importModal');
            const closeModalBtn = modal.querySelector('.close-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSubmitBtn = document.getElementById('modal-submit-btn');
            const newDataForm = document.getElementById('new-data-form');
            const langBtns = document.querySelectorAll('.lang-btn');
            
            // --- 預設 RAG 數據 (僅包含原本的 3 個，自定義數據會從 LocalStorage 載入) ---
            const defaultKnowledge = [
                { id: '1', title_zh: '赤崁樓', info_zh: '台南市 / 一級古蹟', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Chikan+Tower', desc: '赤崁樓始建於 1653 年，為荷蘭人所建，歷經清朝重建與日治時期修繕，是台南最具代表性的古蹟之一。' },
                { id: '2', title_zh: '西門紅樓', info_zh: '台北市 / 歷史建築', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Red+House', desc: '西門紅樓是一座兩層高的紅磚洋樓，見證了西門町的歷史發展。' },
                { id: '3', title_zh: '媽祖繞境', info_zh: '中台灣 / 無形文化', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Mazu+Pilgrimage', desc: '搶孤是中元普渡的活動，恆春與宜蘭頭城最為著名，旨在強調對先人的敬畏與社區團結。' }
            ];

            // --- 翻譯字典 (維持不變) ---
            const translations = {
                'zh-Hant': {
                    title: '文化智遊儀表板', nav_guide: '導覽', nav_knowledge: '知識庫', nav_experience: '體驗', nav_personal: '個人中心',
                    h2_api: 'API 整合服務模組', p_api: '系統服務狀態與金鑰設定', status_rag: 'RAG 服務：尚未連線', status_data: '開放資料：同步中', btn_save: '儲存設定',
                    h2_guide: 'AI 智能導覽', p_guide: '您的隨身文化嚮導', chat_init: '[系統初始化] 檢測到 RAG 核心未啟動。請在上方輸入您的 Gemini Key 以連線文化知識庫。', placeholder_chat: '輸入您的文化問題或導覽需求...', btn_send: '發送',
                    h2_db: '文化知識庫', p_db: '探索全台文化資產 (RAG 資料源)', btn_import: '匯入新資料', placeholder_search: '搜尋古蹟、文物、歷史事件...', 
                    filter_all: '全部', filter_monument: '古蹟', filter_museum: '博物館', filter_intangible: '無形文化',
                    h2_immersive: '沉浸式體驗', p_immersive: '啟動您的時光機', tag_ar: 'AR 實景還原', h4_anping: '安平古堡：熱蘭遮城 1632', tag_vr: 'VR 虛擬展館', h4_taipei: '已消失的台北城牆 (數位重建)',
                    h2_local: '在地即時資訊', p_local: '整合開放資料', map_placeholder: '--- 互動地圖載入區域 ---', bus_route: '[市區公車] 77路', bus_status: '即將抵達：赤崁樓站 (3 分鐘)', event_name: '[節慶活動] 府城文化節', event_status: '進行中：孔廟園區 (距離 1.2km)',
                    h2_personal: '個人化中心', p_personal: '您的文化足跡', card_fav: '我的收藏', card_fav_p: '您已收藏 12 個景點與 3 篇導覽', card_trip: '我的行程', card_trip_p: '您有 1 個即將到來的行程 (台南三日遊)', card_ach: '我的成就', card_ach_p: '已解鎖「府城探索者」徽章',
                    modal_title: '匯入自定義文化資產', modal_label_name: '資產名稱 (必填)', modal_label_location: '地點 / 縣市 (必填)', modal_label_type: '類型', modal_label_desc: '簡要描述', btn_cancel: '取消', btn_submit: '匯入並啟用'
                },
                'en': {
                    title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                    h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                    h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                    h2_db: 'Cultural Knowledge Base', p_db: 'Explore Taiwan\'s Cultural Assets (RAG Source)', btn_import: 'Import New Data', placeholder_search: 'Search: Monuments, artifacts, history...', 
                    filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                    h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                    h2_local: 'Local Real-Time Info', p_local: 'Open Data Integration', map_placeholder: '--- Interactive Map Loading Area ---', bus_route: '[TRANSIT] Route 77', bus_status: 'Arriving: Chikan Tower (3 min)', event_name: '[EVENT] Fucheng Culture Fest', event_status: 'Active: Confucius Temple (1.2km)',
                    h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: 'Achieved: \'Fucheng Explorer\' Badge',
                    modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type', modal_label_desc: 'Brief Description (for RAG)', btn_cancel: 'Cancel', btn_submit: 'Import & Activate'
                }
            };

            // --------------------------------------------------------------------------------
            // --- 核心功能 1: Local Storage 存取與頁面載入 ---
            // --------------------------------------------------------------------------------

            // 存儲數據到 Local Storage
            function saveState() {
                localStorage.setItem('geminiKey', geminiApiKeyInput.value);
                localStorage.setItem('isRAGReady', isRAGReady);
                localStorage.setItem('currentLang', currentLang);
            }

            // 載入 API Key 和 RAG 狀態
            function loadAPIState() {
                const storedKey = localStorage.getItem('geminiKey');
                const storedRAG = localStorage.getItem('isRAGReady') === 'true';

                if (storedKey) {
                    // 恢復 Key 輸入框 (以密碼形式)
                    geminiApiKeyInput.value = storedKey;
                    
                    // 恢復 RAG 狀態
                    isRAGReady = storedRAG;
                    isApiValid = storedRAG;

                    if (isRAGReady) {
                        ragStatusDot.classList.add('active');
                        ragStatusText.textContent = translations[currentLang].status_rag.replace('尚未連線', '已連線');
                        geminiApiKeyInput.style.borderColor = 'var(--success-color)';
                        // 初始聊天訊息：已連線
                        chatWindow.innerHTML = `<div class="chat-bubble ai">${translations[currentLang].chat_init.replace('檢測到 RAG 核心未啟動', 'RAG 核心已於上次連線時啟動')}</div>`;
                    } else {
                        // 雖然有 key，但上次可能是無效狀態
                        ragStatusDot.classList.remove('active');
                        ragStatusText.textContent = translations[currentLang].status_rag; // 尚未連線
                        geminiApiKeyInput.style.borderColor = 'var(--glass-border-dark)';
                        // 初始聊天訊息：未連線
                        chatWindow.innerHTML = `<div class="chat-bubble ai">${translations[currentLang].chat_init}</div>`;
                    }
                }
            }

            // 載入語言設定
            function loadLanguage() {
                const storedLang = localStorage.getItem('currentLang');
                if (storedLang && translations[storedLang]) {
                    applyTranslation(storedLang);
                }
            }
            
            // 載入自定義知識庫數據
            function loadCustomData() {
                const storedData = localStorage.getItem('customKnowledge');
                const customAssets = storedData ? JSON.parse(storedData) : [];
                
                // 清空預設卡片，只保留預設的 3 個 DOM 元素
                knowledgeGrid.innerHTML = knowledgeGrid.innerHTML.trim().split('</div>').slice(0, 3).join('</div>') + '</div>';

                // 重新組合所有數據 (預設 + 自定義)
                const allAssets = defaultKnowledge.concat(customAssets);
                
                // 重新繪製所有卡片
                knowledgeGrid.innerHTML = '';
                allAssets.forEach(asset => {
                    knowledgeGrid.prepend(createKnowledgeCardDOM(asset));
                });
            }

            // 執行載入所有狀態
            loadLanguage();
            loadCustomData(); 
            loadAPIState(); // 必須在 loadLanguage 之後，才能使用正確的翻譯文本

            // --------------------------------------------------------------------------------
            // --- 核心功能 2: 數據管理輔助函數 ---
            // --------------------------------------------------------------------------------

            // 創建知識庫卡片的 DOM 元素
            function createKnowledgeCardDOM(asset) {
                const newCard = document.createElement('div');
                newCard.className = 'knowledge-card';
                newCard.setAttribute('data-card-id', asset.id);
                newCard.setAttribute('data-title-zh', asset.title_zh);
                newCard.setAttribute('data-info-zh', asset.info_zh);
                newCard.setAttribute('data-title-en', asset.title_en);
                newCard.setAttribute('data-info-en', asset.info_en);

                const imageUrl = asset.img_url || `https://via.placeholder.com/300x200/4a4a5a/ffffff?text=${asset.title_zh.substring(0, 10)}`;

                newCard.innerHTML = `
                    <img src="${imageUrl}" alt="${asset.title_zh}">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">${asset.title_zh}</h4>
                        <p class="card-info">${asset.info_zh}</p>
                    </div>
                `;
                return newCard;
            }

            // 獲取所有 RAG 數據 (包含預設和自定義)
            function getAllRAGData() {
                const storedData = localStorage.getItem('customKnowledge');
                const customAssets = storedData ? JSON.parse(storedData) : [];
                return defaultKnowledge.concat(customAssets);
            }

            // --------------------------------------------------------------------------------
            // --- 核心功能 3: 語言切換 / 自動翻譯 (修改為儲存語言) ---
            // --------------------------------------------------------------------------------
            function applyTranslation(lang) {
                currentLang = lang;
                const dict = translations[lang];

                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    if (dict[key]) {
                        if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                            el.placeholder = dict[key];
                        } else {
                            el.textContent = dict[key];
                        }
                    }
                });

                // 翻譯知識庫卡片
                document.querySelectorAll('.knowledge-card').forEach(card => {
                    const titleEl = card.querySelector('.card-title');
                    const infoEl = card.querySelector('.card-info');
                    if (titleEl && infoEl) {
                        titleEl.textContent = card.getAttribute(`data-title-${lang}`) || card.getAttribute('data-title-zh');
                        infoEl.textContent = card.getAttribute(`data-info-${lang}`) || card.getAttribute('data-info-zh');
                    }
                });

                // 更新語言按鈕的 active 狀態
                langBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-lang') === lang) {
                        btn.classList.add('active');
                    }
                });
                
                // 儲存語言設定
                localStorage.setItem('currentLang', lang);
            }

            // 監聽語言切換按鈕
            langBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.getAttribute('data-lang');
                    applyTranslation(lang);
                    showToast(translations[currentLang].btn_save.replace('儲存設定', `介面已切換為 ${lang === 'zh-Hant' ? '繁體中文' : 'English'} (模擬翻譯)`), 'success');
                });
            });

            // --------------------------------------------------------------------------------
            // --- 核心功能 4: API Key 儲存與驗證 (修改為儲存狀態) ---
            // --------------------------------------------------------------------------------
            saveApiBtn.addEventListener('click', () => {
                const apiKey = geminiApiKeyInput.value;
                const isChinese = currentLang === 'zh-Hant';
                
                if (apiKey && apiKey.length > 10) {
                    isApiValid = true;
                    isRAGReady = true; 
                    ragStatusDot.classList.add('active');
                    ragStatusText.textContent = isChinese ? 'RAG 服務：已連線' : 'RAG Service: Connected';
                    geminiApiKeyInput.style.borderColor = 'var(--success-color)';
                    showToast(isChinese ? 'Gemini API Key 儲存並驗證成功！服務核心啟動。' : 'Gemini API Key validated! Service core started.', 'success');
                    addChatMessage('AI', isChinese ? '服務已啟動。RAG 檢索功能已準備就緒，您可以開始提問了！' : 'Service initiated. RAG retrieval is ready. You may start querying!');
                } else {
                    isApiValid = false;
                    isRAGReady = false;
                    ragStatusDot.classList.remove('active');
                    ragStatusText.textContent = isChinese ? 'RAG 服務：金鑰無效' : 'RAG Service: Invalid Key';
                    geminiApiKeyInput.style.borderColor = 'var(--error-color)';
                    showToast(isChinese ? 'Gemini API Key 格式錯誤或無效。' : 'Gemini API Key error or invalid.', 'error');
                }
                
                // 呼叫儲存狀態
                saveState(); 
            });


            // --------------------------------------------------------------------------------
            // --- 核心功能 5: Modal 表單提交 (修改為儲存自定義數據) ---
            // --------------------------------------------------------------------------------
            
            // 顯示/隱藏 Modal (維持不變)
            importDataBtn.addEventListener('click', () => { modal.classList.add('show'); });
            const hideModal = () => { modal.classList.remove('show'); };
            closeModalBtn.addEventListener('click', hideModal);
            modalCancelBtn.addEventListener('click', hideModal);
            window.addEventListener('click', (event) => { if (event.target === modal) { hideModal(); } });

            // 表單提交邏輯 (修改)
            modalSubmitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('asset-name');
                const locationInput = document.getElementById('asset-location');
                const typeInput = document.getElementById('asset-type');
                const descInput = document.getElementById('asset-desc');

                if (!nameInput.value || !locationInput.value) {
                    showToast(translations[currentLang].modal_title.replace('匯入自定義文化資產', '請填寫資產名稱和地點！'), 'error');
                    return;
                }
                
                modalSubmitBtn.disabled = true;
                modalSubmitBtn.textContent = '匯入中...';

                // 模擬處理延遲
                setTimeout(() => {
                    const newAsset = {
                        id: Date.now().toString(),
                        title_zh: nameInput.value,
                        info_zh: `${locationInput.value} / ${typeInput.value || '用戶自定義'}`,
                        title_en: `[Custom] ${nameInput.value}`,
                        info_en: `${locationInput.value} / Custom Asset`,
                        img_url: `https://via.placeholder.com/300x200/4a4a5a/ffffff?text=${nameInput.value.substring(0, 10)}`,
                        desc: descInput.value
                    };
                    
                    // 1. 儲存到 Local Storage
                    const storedData = localStorage.getItem('customKnowledge');
                    const customAssets = storedData ? JSON.parse(storedData) : [];
                    customAssets.push(newAsset);
                    localStorage.setItem('customKnowledge', JSON.stringify(customAssets));
                    
                    // 2. 重新載入並繪製 DOM
                    loadCustomData(); 
                    applyTranslation(currentLang); 

                    // 3. 恢復狀態並關閉 Modal
                    newDataForm.reset();
                    hideModal();
                    modalSubmitBtn.disabled = false;
                    modalSubmitBtn.textContent = translations[currentLang].btn_submit; 
                    showToast(translations[currentLang].modal_title.replace('匯入自定義文化資產', `成功匯入資產：「${newAsset.title_zh}」！已加入 RAG 數據源。`), 'success');

                }, 1500);
            });
            

            // --------------------------------------------------------------------------------
            // --- 核心功能 6: 聊天及 RAG 模擬 (修改為包含自定義數據) ---
            // --------------------------------------------------------------------------------
            
            // 聊天訊息 DOM 產生器 (維持不變)
            function addChatMessage(sender, message) {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender === 'AI' ? 'ai' : 'user'}`;
                bubble.textContent = message;
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // 模擬 AI (RAG) 回應 (修改為檢索所有數據)
            function simulateRAGResponse(userMessage) {
                const isChinese = currentLang === 'zh-Hant';
                const allData = getAllRAGData(); // 獲取所有數據
                let foundAsset = null;

                // 嘗試匹配用戶輸入與知識庫中的資產
                allData.forEach(asset => {
                    if (userMessage.includes(asset.title_zh) || (asset.title_en && userMessage.toLowerCase().includes(asset.title_en.toLowerCase()))) {
                        foundAsset = asset;
                    }
                });

                setTimeout(() => {
                    addChatMessage('AI', isChinese ? '（RAG 檢索中... 正在從知識庫搜尋資料...）' : '(RAG Retrieval in progress...)');
                }, 500);

                setTimeout(() => {
                    let aiResponse = '';
                    if (foundAsset) {
                        const title = isChinese ? foundAsset.title_zh : foundAsset.title_en;
                        const desc = foundAsset.desc || (isChinese ? '知識庫中暫無詳細描述。' : 'No detailed description found.');
                        aiResponse = isChinese ? 
                            `[RAG 回應] 關於 ${title}：${desc} (數據源：${foundAsset.info_zh.split(' / ')[1]})` : 
                            `[RAG RESPONSE] Regarding ${title}: ${desc} (Source: ${foundAsset.info_en.split(' / ')[1]})`;
                    } else if (userMessage.toLowerCase().includes('你好') || userMessage.toLowerCase().includes('hello')) {
                        aiResponse = isChinese ? '您好！我是您的文化智遊系統，準備好探索台灣的歷史脈絡了嗎？' : 'Hello! I am your Culture Guide System, ready to explore the history of Taiwan?';
                    } else if (isRAGReady) {
                        aiResponse = isChinese ? 
                            '[RAG 回應] 我收到了您的指令：「' + userMessage + '」。無法在知識庫中找到匹配項。' :
                            '[RAG RESPONSE] Received query: "' + userMessage + '". No match found in the knowledge base.';
                    } else {
                         aiResponse = isChinese ? 
                            '[系統] RAG 核心未連線。請檢查您的 Gemini API Key。' :
                            '[SYSTEM] RAG Core is offline. Please check your Gemini API Key.';
                    }
                    addChatMessage('AI', aiResponse);
                }, 2000); 
            }

            // 聊天發送功能 (維持不變)
            chatSendBtn.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message === '') return;

                if (!isRAGReady) {
                    showToast(translations[currentLang].modal_title.replace('匯入自定義文化資產', '請先在 API 設定模組中輸入有效的 Gemini Key。'), 'error');
                    return;
                }

                addChatMessage('User', message);
                chatInput.value = ''; 
                simulateRAGResponse(message);
            });
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { chatSendBtn.click(); }
            });

            // 折疊模組功能 (維持不變)
            collapsibleHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('expanded');
                    const content = header.nextElementSibling;
                    if (content && content.classList.contains('module-content')) {
                        content.classList.toggle('expanded');
                    }
                });
            });

            // 全局提示框 (Toast) 功能 (維持不變)
            function showToast(message, type = 'success') {
                // ... (Toast 函數保持不變) ...
                const oldToast = document.querySelector('.toast');
                if (oldToast) oldToast.remove();

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100); 

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.parentElement.removeChild(toast);
                        }
                    }, 300); 
                }, 3000);
            }

        });
    </script>

</body>
</html>
