<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ–‡åŒ–æ™ºéŠ - AI ç§‘æŠ€å„€è¡¨æ¿ï¼ˆRAG/AR/VRæ•´åˆç‰ˆ v5 - GeminiæŠ½å–ï¼‰</title>
    <meta name="color-scheme" content="dark" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* CSS è®Šæ•¸ */
        :root { --bg:#070718; --bg-grad-a:rgba(0,255,255,.1); --bg-grad-b:rgba(187,0,255,.1);
          --pri:#00ffff; --sec:#bb00ff; --text:#e6f7ff; --muted:#8090a0; --glass:rgba(0,0,0,.7);
          --glass-border:rgba(255,255,255,.06); --glow-pri:0 0 15px rgba(0,255,255,.4), 0 0 5px rgba(0,255,255,.18);
          --glow-sec:0 0 15px rgba(187,0,255,.4), 0 0 5px rgba(187,0,255,.18); --ok:#4aff8f; --bad:#ff4a4a;
          --radius:18px; --radius-sm:10px; --shadow-deep:0 0 30px rgba(0,0,0,.7), 0 0 20px rgba(0,255,255,.05), 0 0 40px rgba(187,0,255,.08); --space:clamp(.75rem, .75rem + 1.2vw, 2rem); }
        /* åŸºæœ¬æ¨£å¼ */
        *{box-sizing:border-box} html,body{height:100%}
        body{margin:0;font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
          background:radial-gradient(circle at 15% 15%, var(--bg-grad-a), transparent 30%), radial-gradient(circle at 85% 75%, var(--bg-grad-b), transparent 35%), linear-gradient(135deg,#070718 0%,#030018 100%);
          background-color:var(--bg); padding:clamp(1rem,3vw,2.5rem)}
        :focus-visible{outline:2px solid var(--pri); outline-offset:2px; border-radius:8px}
        @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}
        /* ç‰ˆé¢ã€é¢æ¿ã€å…ƒä»¶æ¨£å¼ */
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:clamp(1rem,2vw,2rem)}
        @media (max-width:960px){.grid{grid-template-columns:1fr}}
        .panel{background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:var(--shadow-deep);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:calc(var(--space)*1.1);transition:transform .25s ease,box-shadow .25s ease}
        .panel:hover{transform:translateY(-2px);box-shadow:var(--glow-pri)}
        .module-header{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem}
        .module-header h2{margin:0;font-size:clamp(1.1rem,1rem + .8vw,1.5rem);color:var(--pri);text-shadow:0 0 6px rgba(0,255,255,.28)}
        .module-sub{margin:0;color:var(--muted);font-size:.95rem}
        .chip{display:inline-flex;align-items:center;gap:.4rem;font-family:'Orbitron',monospace;font-weight:700;background:linear-gradient(45deg,var(--pri),var(--sec));color:#091018;border-radius:var(--radius-sm);padding:.35rem .6rem;letter-spacing:.5px}
        .btn{cursor:pointer;border:1.5px solid var(--pri);background:rgba(0,255,255,.06);color:var(--pri);border-radius:var(--radius-sm);padding:.55rem .9rem;font-size:.95rem;transition:.2s ease}
        .btn:hover:not(:disabled){box-shadow:var(--glow-pri);transform:translateY(-1px)}
        .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
        .btn.primary{background:linear-gradient(90deg,var(--pri),#00aaff);color:#081018;border-color:transparent}
        .input,textarea.input{width:100%;background:rgba(0,0,0,.4);color:var(--text);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:.65rem .8rem;font-size:.95rem}
        .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
        .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-12{grid-column:span 12}
        @media (max-width:960px){.col-6,.col-4{grid-column:span 12}}
        header.header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:var(--space)}
        .nav{display:flex;gap:.8rem;flex-wrap:wrap}
        .nav a{color:var(--muted);text-decoration:none;padding:.4rem .6rem;border-radius:8px}
        .nav a.active,.nav a:hover{background:rgba(0,255,255,.08);color:var(--text)}
        /* çŸ¥è­˜åº« */
        .kb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        @media (max-width:1200px){.kb-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:720px){.kb-grid{grid-template-columns:1fr}}
        .kb-card{overflow:hidden;border-radius:16px;border:1px solid var(--glass-border);background:rgba(255,255,255,.02); transition: border-color .2s; cursor: pointer;}
        .kb-card:hover{border-color: var(--pri)}
        .kb-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .kb-card .content{padding:.8rem .9rem}
        .kb-card h4{margin:0 0 .25rem 0;font-size:1.05rem}
        .filters{display:flex;gap:.6rem;flex-wrap:wrap}
        .filter{padding:.35rem .6rem;border:1px solid var(--glass-border);border-radius:999px;color:var(--muted);cursor:pointer}
        .filter.active{border-color:var(--pri);color:var(--text);box-shadow:var(--glow-pri)}
        /* èŠå¤©å®¤ */
        .chat{display:flex;flex-direction:column;gap:.6rem;height:clamp(220px,35vh,360px);overflow:auto;background:rgba(255,255,255,.02);border-radius:12px;padding:.8rem;border:1px solid var(--glass-border)}
        .bubble{max-width:88%;padding:.6rem .8rem;border-radius:14px; white-space: pre-wrap; word-wrap: break-word;}
        .bubble.ai{background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.2)}
        .bubble.user{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);margin-left:auto}
        .chat-input{display:flex;gap:.5rem;margin-top:.6rem}
        .chat-input .mic{width:2.25rem}
        .status{display:inline-flex;align-items:center;gap:.4rem;font-size:.92rem;color:var(--muted)}
        .dot{width:.55rem;height:.55rem;border-radius:50%;background:#666;box-shadow:inset 0 0 0 2px rgba(0,0,0,.3)}
        .dot.ok{background:var(--ok)}
        /* AR/VR é«”é©— */
        .xp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
        @media (max-width:960px){.xp-grid{grid-template-columns:1fr}}
        .xp-card{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--glass-border)}
        .xp-card img{width:100%;display:block;object-fit:cover;aspect-ratio:16/9;height:auto}
        .xp-overlay{position:absolute;inset:auto 0 0 0;padding:.9rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.65))}
        .tag{display:inline-block;padding:.3rem .5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;margin-bottom:.4rem}
        .ar-card model-viewer{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15)}
        .hotspot{--size:14px;width:var(--size);height:var(--size);border-radius:999px;border:2px solid rgba(255,255,255,.9);background:rgba(0,255,255,.9);box-shadow:var(--glow-pri); cursor: pointer;}
        .annotation{position:absolute;transform:translate(-50%,calc(-100% - 10px));padding:.35rem .55rem;background:rgba(0,0,0,.75);border:1px solid var(--glass-border);border-radius:8px;color:#e6f7ff;font-size:.85rem;white-space:nowrap;pointer-events:none; display:none;}
        .vr-card .vr-wrap{width:100%;height:min(520px,60vh);background:rgba(0,0,0,.15);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden}
        .vr-card .vr-wrap a-scene{width:100%;height:100%; display:block}
        /* æ‘ºç–Šèˆ‡æ¨¡æ…‹æ¡† */
        .collapsible{cursor:pointer;position:relative}
        .collapsible .caret{margin-left:auto;font-size:.9rem;opacity:.9}
        .section-body{margin-top:.6rem;display:block}
        .section-body[hidden]{display:none}
        .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.82);backdrop-filter:blur(5px);z-index:1000}
        .modal[open]{display:grid}
        .modal-card{width:min(600px,92vw);background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:1.1rem;box-shadow:var(--glow-pri)}
        .modal-head{display:flex;align-items:center;justify-content:space-between;gap:.6rem;padding-bottom:.6rem;border-bottom:2px solid var(--sec)}
        .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}
        /* Toast æç¤º */
        .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) translateY(120%);background:rgba(0,0,0,.85);color:#fff;padding:.6rem .9rem;border-radius:10px;border:1px solid var(--glass-border);transition:transform .28s ease;z-index:1200;white-space:pre-wrap}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{box-shadow:0 0 0 2px rgba(74,255,143,.2)}
        .toast.error{box-shadow:0 0 0 2px rgba(255,74,74,.2)}
        /* åœ°åœ–å…ƒä»¶å°ˆå±¬æ¨£å¼ */
        #local-map {
          height: 300px;
          border: 1px solid var(--glass-border);  
          border-radius: 12px;
          margin-bottom: .8rem;
        }
        .leaflet-container { /* è®“ Leaflet å®¹å™¨é©æ‡‰æš—è‰²ä¸»é¡Œ */
             background-color: var(--bg);
             border-radius: 12px;
        }
    </style>
    
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="lang-switch" style="display:flex; gap:.5rem; align-items:center; margin-bottom:.6rem;">
        <span style="color:var(--text); font-size:.9rem" data-key="ui_lang">ä»‹é¢èªè¨€:</span>
        <button class="btn" data-lang="zh-Hant" id="btn-zh">ç¹é«”ä¸­æ–‡</button>
        <button class="btn" data-lang="en" id="btn-en">English</button>
    </div>

    <header class="header" role="banner">
        <h1 id="app-title" data-key="title">æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿</h1>
        <nav class="nav" aria-label="ä¸»è¦å°è¦½">
            <a href="#section-guide" class="active" data-key="nav_guide">å°è¦½</a>
            <a href="#section-kb" data-key="nav_knowledge">çŸ¥è­˜åº«</a>
            <a href="#section-xp" data-key="nav_experience">é«”é©—</a>
            <a href="#section-me" data-key="nav_personal">å€‹äººä¸­å¿ƒ</a>
        </nav>
    </header>

    <main class="grid" role="main" aria-live="polite">
        <section class="panel col-12" aria-labelledby="api-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>API</span></div>
                <h2 id="api-h2" data-key="h2_api">API æ•´åˆæœå‹™æ¨¡çµ„</h2>
            </div>
            <p class="module-sub" data-key="p_api">ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š</p>
            <div class="row" style="margin-top:.6rem">
                <div class="col-12" style="grid-column: span 12;">
                    <label for="gemini-api" class="sr">Gemini API Key</label>
                    <input id="gemini-api" class="input" type="password" placeholder="Gemini API Key" autocomplete="off" />
                </div>
            </div>
            <div style="display:flex; gap:.8rem; align-items:center; justify-content:flex-end; margin-top:.8rem">
                <span class="status"><span id="rag-dot" class="dot" aria-hidden="true"></span><span id="rag-text" data-key="status_rag">RAG æœå‹™ï¼šå°šæœªé€£ç·š</span></span>
                <span class="status"><span class="dot ok" aria-hidden="true"></span><span data-key="status_data">é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­</span></span>
                <button id="btn-save-api" class="btn primary" data-key="btn_save" type="button">å„²å­˜è¨­å®š</button>
            </div>
        </section>

        <section id="section-guide" class="panel col-12" aria-labelledby="guide-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AI</span></div>
                <h2 id="guide-h2" data-key="h2_guide">AI æ™ºèƒ½å°è¦½</h2>
            </div>
            <p class="module-sub" data-key="p_guide">æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°</p>
            <div id="chat" class="chat" aria-live="polite" aria-label="èŠå¤©è¦–çª—">
                <div class="bubble ai" data-key="chat_init">[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚</div>
            </div>
            <div class="chat-input">
                <button class="btn mic" type="button" aria-label="èªéŸ³è¼¸å…¥" disabled>ğŸ¤</button>
                <input id="chat-input" class="input" type="text" data-key="placeholder_chat" placeholder="è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚..." />
                <button id="btn-send" class="btn primary" type="button" data-key="btn_send">ç™¼é€</button>
            </div>
        </section>

        <section id="section-kb" class="panel col-12" aria-labelledby="kb-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>DB</span></div>
                <h2 id="kb-h2" data-key="h2_db">æ–‡åŒ–çŸ¥è­˜åº«</h2>
                <button id="btn-auto-fetch" class="btn" type="button" data-key="btn_auto_fetch">ğŸ¤– AI è‡ªå‹•çˆ¬å–è³‡æ–™</button>
                <button id="btn-import" class="btn" type="button" data-key="btn_import">â†“ åŒ¯å…¥æ–°è³‡æ–™</button>
            </div>
            <p class="module-sub" data-key="p_db">æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)</p>
            <div class="row" style="margin:.6rem 0 .8rem 0; align-items:center">
                <div class="col-6"><input id="kb-search" class="input" type="text" data-key="placeholder_search" placeholder="æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶..." /></div>
                <div class="col-6" style="display:flex; justify-content:flex-end"><div id="filter-controls" class="filters" role="tablist" aria-label="é¡å‹ç¯©é¸">
                    <button class="filter active" data-filter="all" data-key="filter_all" role="tab" aria-selected="true">å…¨éƒ¨</button>
                    <button class="filter" data-filter="monument" data-key="filter_monument" role="tab">å¤è¹Ÿ</button>
                    <button class="filter" data-filter="museum" data-key="filter_museum" role="tab">åšç‰©é¤¨</button>
                    <button class="filter" data-filter="intangible" data-key="filter_intangible" role="tab">ç„¡å½¢æ–‡åŒ–</button>
                </div></div>
            </div>
            <div id="kb-grid" class="kb-grid" aria-live="polite"></div>
        </section>

        <section id="section-xp" class="panel col-12" aria-labelledby="xp-h2">
            <div class="module-header">
                <div class="chip" aria-hidden="true"><span>AR</span></div>
                <h2 id="xp-h2" data-key="h2_immersive">æ²‰æµ¸å¼é«”é©—</h2>
            </div>
            <p class="module-sub" data-key="p_immersive">å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ</p>
            <div class="xp-grid">
                <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå®‰å¹³å¤å ¡ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
                    <model-viewer id="mv-anping"
                        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
                        alt="å®‰å¹³å¤å ¡ç¤ºæ„ 3D æ¨¡å‹"
                        ar ar-modes="webxr scene-viewer quick-look"
                        ar-scale="auto" ar-placement="floor"
                        camera-controls camera-orbit="0deg 75deg 2.2m" field-of-view="30deg"
                        environment-image="neutral" shadow-intensity="1" exposure="1"
                        interaction-prompt="auto"
                        poster="https://via.placeholder.com/800x520/331144/cccccc?text=Tap+to+Load+AR"
                        aria-label="å•Ÿå‹• AR æª¢è¦–">
                        <button class="hotspot" slot="hotspot-gate" data-position="0.15m 1.2m 0.2m" data-normal="0 1 0" data-anno="åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰"></button>
                        <div class="annotation" slot="annotation-gate">åŸé–€ï¼šæ¸…é ˜æ™‚æœŸä¿®ç¯‰</div>
                        <button class="hotspot" slot="hotspot-battery" data-position="-0.25m 0.9m 0.1m" data-normal="0 1 0" data-anno="ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½"></button>
                        <div class="annotation" slot="annotation-battery">ç ²å°ï¼šè·æ²»è»äº‹è¨­æ–½</div>
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_ar">AR å¯¦æ™¯é‚„åŸ</span>
                        <h4 style="margin:.2rem 0" data-key="h4_anping">å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632ï¼ˆAR ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>

                <article class="xp-card ar-card" aria-label="AR å¯¦æ™¯ï¼šå°åŒ—åŸç‰†ï¼ˆç¤ºæ„æ¨¡å‹ï¼‰">
                    <model-viewer
                        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
                        ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
                        alt="å°åŒ—åŸç‰†ç¤ºæ„ 3D æ¨¡å‹"
                        ar ar-modes="webxr scene-viewer quick-look"
                        camera-controls environment-image="neutral" shadow-intensity="1"
                        poster="https://via.placeholder.com/800x520/113333/cccccc?text=Tap+to+Load+AR"
                        aria-label="å•Ÿå‹• AR æª¢è¦–">
                        <button slot="ar-button" class="btn primary" style="position:absolute; left:1rem; bottom:1rem">åœ¨å¯¦å¢ƒä¸­æŸ¥çœ‹</button>
                    </model-viewer>
                    <div class="xp-overlay">
                        <span class="tag" data-key="tag_vr">VR / AR é«”é©—</span>
                        <h4 style="margin:.2rem 0" data-key="h4_taipei">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆAR ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>

                <article class="xp-card vr-card" aria-label="VR è™›æ“¬å±•é¤¨ï¼š360 å…¨æ™¯ç¤ºæ„">
                    <div class="vr-wrap">
                        <a-scene embedded background="color: #000" vr-mode-ui="enabled: false">
                            <a-assets>
                                <img id="pano" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg" />
                            </a-assets>
                            <a-sky src="#pano"></a-sky>
                            <a-entity position="0 1.6 0">
                                <a-camera wasd-controls-enabled="false"></a-camera>
                            </a-entity>
                        </a-scene>
                    </div>
                    <div class="xp-overlay">
                        <span class="tag">VR è™›æ“¬å±•é¤¨</span>
                        <h4 style="margin:.2rem 0">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰†ï¼ˆ360Â° è™›æ“¬å±•é¤¨ç¤ºæ„ï¼‰</h4>
                    </div>
                </article>
            </div>
        </section>

        <section class="panel col-12" aria-labelledby="local-h2">
            <div id="local-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>GPS</span></div>
                <h2 id="local-h2" data-key="h2_local">åœ¨åœ°å³æ™‚è³‡è¨Š</h2>
                <span class="module-sub" data-key="p_local">æ•´åˆé–‹æ”¾è³‡æ–™ / å¯¦æ™‚è¿½è¹¤</span>
                <span class="caret" aria-hidden="true">â–¼</span>
            </div>
            <div id="local-body" class="section-body">
                <div id="local-map" role="region" aria-label="åœ¨åœ°å³æ™‚è³‡è¨Šåœ°åœ–"></div>
                
                <ul id="local-data-list" style="list-style:none; padding:0; margin:0; display:grid; gap:.6rem">
                    <li style="text-align:center; color:var(--muted)">è«‹å…è¨±åœ°ç†å®šä½ä»¥è¼‰å…¥åœ¨åœ°å³æ™‚è³‡è¨Š...</li>
                </ul>
            </div>
        </section>

        <section id="section-me" class="panel col-12" aria-labelledby="me-h2">
            <div id="me-toggle" class="module-header collapsible" role="button" tabindex="0" aria-expanded="true">
                <div class="chip" aria-hidden="true"><span>USR</span></div>
                <h2 id="me-h2" data-key="h2_personal">å€‹äººåŒ–ä¸­å¿ƒ</h2>
                <span class="module-sub" data-key="p_personal">æ‚¨çš„æ–‡åŒ–è¶³è·¡</span>
                <span class="caret" aria-hidden="true">â–¼</span>
            </div>
            <div id="me-body" class="section-body">
                <div class="kb-grid">
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">â™¥</div>
                        <div><h4 data-key="card_fav">æˆ‘çš„æ”¶è—</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_fav_p">æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">âœˆ</div>
                        <div><h4 data-key="card_trip">æˆ‘çš„è¡Œç¨‹</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_trip_p">æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)</p></div>
                    </div></div>
                    <div class="kb-card"><div class="content" style="display:flex; gap:.7rem; align-items:center">
                        <div class="chip" aria-hidden="true">â˜†</div>
                        <div><h4 data-key="card_ach">æˆ‘çš„æˆå°±</h4><p style="margin:.2rem 0; color:var(--muted)" data-key="card_ach_p">å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« </p></div>
                    </div></div>
                </div>
            </div>
        </section>
    </main>

    <dialog id="import-modal" class="modal" aria-labelledby="import-title" aria-modal="true">
        <div class="modal-card" role="document">
            <div class="modal-head">
                <h3 id="import-title" data-key="modal_title">åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢</h3>
                <button id="btn-close-modal" class="btn" type="button" aria-label="é—œé–‰">âœ•</button>
            </div>
            <form id="import-form" method="dialog">
                <div class="row" style="margin-top:.6rem">
                    <div class="col-12"><label for="asset-name" data-key="modal_label_name">è³‡ç”¢åç¨± (å¿…å¡«)</label><input id="asset-name" class="input" required /></div>
                    <div class="col-6"><label for="asset-location" data-key="modal_label_location">åœ°é» / ç¸£å¸‚ (å¿…å¡«)</label><input id="asset-location" class="input" required /></div>
                    <div class="col-6"><label for="asset-type" data-key="modal_label_type">é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)</label><input id="asset-type" class="input" /></div>
                    <div class="col-12"><label for="asset-img-url" data-key="modal_label_img">åœ–ç‰‡ URL (é¸å¡«)</label><input id="asset-img-url" class="input" type="url" placeholder="https://..." /></div>
                    <div class="col-12">
                        <label for="asset-desc" data-key="modal_label_desc">ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)</label>
                        <textarea id="asset-desc" class="input" rows="4"></textarea>
                        <button id="btn-ai-summarize" class="btn" type="button" style="margin-top:.5rem;" data-key="btn_ai_summarize">ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)</button>
                    </div>
                    <div class="col-12" style="margin-top:1rem; border-top: 1px dashed var(--glass-border); padding-top: 1rem;">
                        <h4 style="margin:0 0 .5rem 0; color:var(--pri)" data-key="modal_h4_csv">æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™</h4>
                        <input id="asset-csv-file" type="file" accept=".csv" class="input" style="padding: .5rem;" />
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" type="button" id="btn-cancel" data-key="btn_cancel">å–æ¶ˆ</button>
                    <button class="btn primary" type="submit" id="btn-submit" data-key="btn_submit">å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨</button>
                    <button class="btn" type="button" id="btn-import-csv" data-key="btn_import_csv">æ‰¹æ¬¡åŒ¯å…¥ CSV</button>
                </div>
            </form>
        </div>
    </dialog>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <template id="kb-card-tpl">
        <article class="kb-card" data-id="">
            <img src="" alt="" />
            <div class="content">
                <h4 class="title"></h4>
                <p class="meta" style="margin:.2rem 0; color:var(--muted)"></p>
            </div>
        </article>
    </template>

    <script>
    (function(){
        'use strict';
        // å¸¸ç”¨ DOM é¸æ“‡å™¨
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // ----------------------------------------------------------------------
        // *** 1. Google Search Tool æ›¿èº« (Polyfill for Function Calling) ***
        // ----------------------------------------------------------------------
        /**
         * æ¨¡æ“¬ Google æœå°‹ Function Calling çš„å‡½å¼ã€‚
         * åœ¨å‰ç«¯ç’°å¢ƒä¸‹ï¼Œå®ƒè¿”å›ä¸€çµ„å›ºå®šçš„æ¨¡æ“¬æœå°‹çµæœã€‚
         */
        const google = {
            search: async ({ queries }) => {
                console.warn("âš ï¸ Google Search Tool æ¨¡æ“¬åŸ·è¡Œä¸­ï¼Œè¿”å›é è¨­è³‡æ–™ã€‚");

                // æ¨¡æ“¬ç¶²è·¯å»¶é²
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                return {
                    results: [
                        {
                            snippet: "æ–‡åŒ–éƒ¨å®£å¸ƒæœ€æ–°ä¿®å¾©å®Œæˆçš„åœ‹å®šå¤è¹Ÿï¼šè‡ºå—ç¥è¾²è¡—èˆŠå®…ç¾¤ï¼Œå¼·èª¿å…¶å°è‡ºç£æ—©æœŸå•†æ¥­æ­·å²çš„é‡è¦æ€§ã€‚æ–°çš„é–‹æ”¾æ™‚é–“èˆ‡å°è¦½è³‡è¨Šå·²ç™¼å¸ƒã€‚",
                            source_title: "æ–‡åŒ–éƒ¨æ–°èç¨¿ï¼šè‡ºå—ç¥è¾²è¡—èˆŠå®…ç¾¤ä¿®å¾©ç«£å·¥",
                            url: "https://www.moc.gov.tw/latest-news"
                        },
                        {
                            snippet: "2025å¹´åœ‹éš›åšç‰©é¤¨æ—¥ï¼Œåœ‹ç«‹æ•…å®®åšç‰©é™¢å°‡æ¨å‡ºä¸€ç³»åˆ—æ•¸ä½æ²‰æµ¸å¼é«”é©—ï¼Œç‰¹åˆ¥æ˜¯é‡å°å®‹ä»£ç¹ªç•«çš„ 4K æ•¸ä½é‡å»ºï¼Œæä¾›è§€çœ¾å…¨æ–°çš„è§€è³è§’åº¦ã€‚",
                            source_title: "æ•…å®®åšç‰©é™¢ï¼šåœ‹éš›åšç‰©é¤¨æ—¥æ´»å‹•è³‡è¨Š",
                            url: "https://www.npm.gov.tw/events"
                        },
                        {
                            snippet: "å°ç£é‡è¦çš„ç„¡å½¢æ–‡åŒ–è³‡ç”¢ã€Œæ±æ¸¯è¿ç‹å¹³å®‰ç¥­å…¸ã€ï¼Œè¢«åˆ—ç‚ºä»Šå¹´æ–‡åŒ–è§€å…‰æ¨å»£é‡é»ã€‚äº¤é€šéƒ¨è§€å…‰ç½²æä¾›è©³ç´°çš„äº¤é€šèˆ‡ä½å®¿æŒ‡å¼•ã€‚",
                            source_title: "è§€å…‰ç½²ï¼šæ±æ¸¯è¿ç‹ç¥­å…¸æŒ‡å¼•",
                            url: "https://www.twa.gov.tw/travel-guides"
                        },
                        {
                            snippet: "æœ€æ–°çš„è€ƒå¤ç™¼ç¾ï¼šåœ¨é«˜é›„é³³å±±ç™¼ç¾äº†æ¸…æœæ—©æœŸè»äº‹é˜²ç¦¦å·¥äº‹çš„éºè·¡ï¼Œç›®å‰å·²æš«å®šç‚ºå¸‚å®šæ­·å²éºå€ï¼Œæœªä¾†å°‡é€²è¡Œé€²ä¸€æ­¥ç ”ç©¶èˆ‡ä¿è­·ã€‚",
                            source_title: "é«˜é›„å¸‚æ”¿åºœæ–‡åŒ–å±€ï¼šé³³å±±éºå€æœ€æ–°å…¬å‘Š",
                            url: "https://www.kcg.gov.tw/culture-news"
                        }
                    ]
                };
            }
        };
        // ----------------------------------------------------------------------


        // å¤šèªè¨€/åœ‹éš›åŒ–è¨­å®š (i18n)
        const i18n = {
            'zh-Hant': {
                ui_lang: 'ä»‹é¢èªè¨€:', title: 'æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿', nav_guide: 'å°è¦½', nav_knowledge: 'çŸ¥è­˜åº«', nav_experience: 'é«”é©—', nav_personal: 'å€‹äººä¸­å¿ƒ',
                h2_api: 'API æ•´åˆæœå‹™æ¨¡çµ„', p_api: 'ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š', status_rag: 'RAG æœå‹™ï¼šå°šæœªé€£ç·š', status_data: 'é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­', btn_save: 'å„²å­˜è¨­å®š',
                h2_guide: 'AI æ™ºèƒ½å°è¦½', p_guide: 'æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°', chat_init: '[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚', placeholder_chat: 'è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...', btn_send: 'ç™¼é€',
                h2_db: 'æ–‡åŒ–çŸ¥è­˜åº«', p_db: 'æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)', btn_import: 'â†“ åŒ¯å…¥æ–°è³‡æ–™', btn_auto_fetch: 'ğŸ¤– AI è‡ªå‹•çˆ¬å–è³‡æ–™', placeholder_search: 'æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...',
                filter_all: 'å…¨éƒ¨', filter_monument: 'å¤è¹Ÿ', filter_museum: 'åšç‰©é¤¨', filter_intangible: 'ç„¡å½¢æ–‡åŒ–',
                h2_immersive: 'æ²‰æµ¸å¼é«”é©—', p_immersive: 'å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ', tag_ar: 'AR å¯¦æ™¯é‚„åŸ', h4_anping: 'å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632', tag_vr: 'VR è™›æ“¬å±•é¤¨', h4_taipei: 'å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)',
                h2_local: 'åœ¨åœ°å³æ™‚è³‡è¨Š', p_local: 'æ•´åˆé–‹æ”¾è³‡æ–™ / å¯¦æ™‚è¿½è¹¤', bus_route: '77è·¯ å…¬è»Š', bus_status: 'å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™', event_name: 'åºœåŸæ–‡åŒ–ç¯€', event_status: 'é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€',
                h2_personal: 'å€‹äººåŒ–ä¸­å¿ƒ', p_personal: 'æ‚¨çš„æ–‡åŒ–è¶³è·¡', card_fav: 'æˆ‘çš„æ”¶è—', card_fav_p: 'æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½', card_trip: 'æˆ‘çš„è¡Œç¨‹', card_trip_p: 'æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)', card_ach: 'æˆ‘çš„æˆå°±', card_ach_p: 'å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« ',
                modal_title: 'åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', modal_label_name: 'è³‡ç”¢åç¨± (å¿…å¡«)', modal_label_location: 'åœ°é» / ç¸£å¸‚ (å¿…å¡«)', modal_label_type: 'é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)', modal_label_img: 'åœ–ç‰‡ URL (é¸å¡«)', modal_label_desc: 'ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)', modal_h4_csv: 'æˆ–ï¼šæ‰¹æ¬¡åŒ¯å…¥ CSV è³‡æ–™', btn_ai_summarize: 'ğŸ¤– AI è‡ªå‹•æ‘˜è¦ (æ¨¡æ“¬)', btn_cancel: 'å–æ¶ˆ', btn_submit: 'å–®ç­†åŒ¯å…¥ä¸¦å•Ÿç”¨', btn_import_csv: 'æ‰¹æ¬¡åŒ¯å…¥ CSV',
                toast_lang_switched: (isZh) => `ä»‹é¢å·²åˆ‡æ›ç‚º ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'}ï¼ˆå·²å„²å­˜ï¼‰`, toast_key_ok: 'Gemini API Key å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼æœå‹™æ ¸å¿ƒå•Ÿå‹•ã€‚', toast_key_bad: 'Gemini API Key æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚', toast_need_key: 'è«‹å…ˆåœ¨ API è¨­å®šæ¨¡çµ„ä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini Keyã€‚', toast_import_error: 'è«‹å¡«å¯«ã€Œè³‡ç”¢åç¨±ã€èˆ‡ã€Œåœ°é»ã€ã€‚', toast_import_ok: (name) => `æˆåŠŸåŒ¯å…¥è³‡ç”¢ï¼šã€Œ${name}ã€ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`, toast_ai_summarizing: 'AI æ‘˜è¦è™•ç†ä¸­...', toast_ai_summarize_ok: 'æ‘˜è¦å®Œæˆï¼å·²å›å¡«è‡³æè¿°æ¬„ä½ã€‚', toast_import_csv_error: 'CSV åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå’Œæ ¼å¼ (éœ€åŒ…å« title, location æ¬„ä½)ã€‚', toast_import_csv_ok: (count) => `æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡ç”¢ã€‚å·²åŠ å…¥ RAG è³‡æ–™æºã€‚`, toast_network_error: 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', user_location: 'æ‚¨çš„ç›®å‰ä½ç½®',
                toast_fetching_ai: 'æ­£åœ¨å•Ÿå‹• Gemini AIï¼Œå¾ç¶²è·¯è³‡è¨ŠæºæŠ½å–ä¸¦çµæ§‹åŒ–æ–‡åŒ–è³‡ç”¢è³‡æ–™...',
                toast_fetch_ok_ai: (count) => `âœ… æˆåŠŸåˆ©ç”¨ AI æŠ½å– ${count} ç­†ç¶²è·¯è³‡æ–™ï¼Œå·²æ›´æ–° RAG çŸ¥è­˜åº«ã€‚`,
                toast_fetch_error_ai: 'AI è‡ªå‹•çˆ¬å–ä¸¦æŠ½å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Gemini Key æˆ– API é™åˆ¶ã€‚',
            },
            en: {
                ui_lang: 'Language:', title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                h2_db: "Cultural Knowledge Base", p_db: "Explore Taiwan's Cultural Assets (RAG Source)", btn_import: 'â†“ Import New Data', btn_auto_fetch: 'ğŸ¤– AI Auto Fetch Data', placeholder_search: 'Search: Monuments, artifacts, history...',
                filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                h2_local: 'Local Real-Time Info', p_local: 'Open Data / Real-time Tracking', bus_route: 'Bus Route 77', bus_status: 'Arriving: Chikan Tower Stop', event_name: 'Fucheng Culture Fest', event_status: 'Active: Confucius Temple Area',
                h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: "Achieved: 'Fucheng Explorer' Badge",
                modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type (Monument/Museum/Intangible...)', modal_label_img: 'Image URL (Optional)', modal_label_desc: 'Brief Description (for RAG)', modal_h4_csv: 'OR: Batch Import CSV Data', btn_ai_summarize: 'ğŸ¤– AI Auto Summarize (Simulated)', btn_cancel: 'Cancel', btn_submit: 'Import Single Asset', btn_import_csv: 'Import CSV Batch',
                toast_lang_switched: (isZh) => `Language switched to ${isZh ? 'ç¹é«”ä¸­æ–‡' : 'English'} (saved)`, toast_key_ok: 'Gemini API Key validated! Service core started.', toast_key_bad: 'Gemini API Key error or invalid.', toast_need_key: 'Please enter a valid Gemini Key in API settings first.', toast_import_error: 'Please fill Asset Name & Location.', toast_import_ok: (name) => `Imported: "${name}". Added to RAG source.`, toast_ai_summarizing: 'AI summarizing in progress...', toast_ai_summarize_ok: 'Summarization complete! Result filled into description.', toast_import_csv_error: 'CSV import failed. Check file and format (requires title, location columns).', toast_import_csv_ok: (count) => `Successfully imported ${count} assets. Added to RAG source.`, toast_network_error: 'Connection failed, please check network.', user_location: 'Your Current Location',
                toast_fetching_ai: 'Starting Gemini AI to extract and structure cultural asset data from web sources...',
                toast_fetch_ok_ai: (count) => `âœ… Successfully extracted ${count} assets using AI. RAG knowledge base updated.`,
                toast_fetch_error_ai: 'AI auto-fetching failed. Check Gemini Key or API limits.',
            },
        };

        // ----------------------------------------------------------------------
        // *** 2. æ¨¡æ“¬ RAG çŸ¥è­˜åº«æ•¸æ“š (RAG Knowledge Base Simulation) ***
        // ----------------------------------------------------------------------
        /**
         * æ¨¡æ“¬ RAG æ ¸å¿ƒçŸ¥è­˜åº«ã€‚å¯¦éš›éƒ¨ç½²æ™‚ï¼Œæ­¤è™•æœƒæ›¿æ›ç‚ºå‘é‡è³‡æ–™åº«çš„æª¢ç´¢çµæœã€‚
         * æ ¼å¼ï¼š{ id, title, location, type, description }
         */
        let ragKnowledgeBase = [
            { id: 'twn001', title: 'è‡ºå—ç¥è¾²è¡—èˆŠå®…ç¾¤', location: 'è‡ºå—å¸‚ä¸­è¥¿å€', type: 'monument', description: 'ç¥è¾²è¡—æ˜¯è‡ºå—ä¿å­˜è¼ƒå®Œæ•´çš„å¤è€è¡—é“ä¹‹ä¸€ï¼Œæ˜”ç¨±åŒ—å‹¢è¡—ã€‚æ¸…æœæ™‚æœŸæ˜¯äº”æ¢æ¸¯å€åŸŸé‡è¦çš„å•†æ¥­èˆ‡èˆ¹é‹è¦é“ã€‚å…¶å»ºç¯‰å¤šç‚ºå…©å±¤æ¨“ï¼Œæœ‰ã€ŒåŠæ¨“ä»”ã€æ§‹é€ ï¼Œè¦‹è­‰äº†è‡ºç£æ—©æœŸç¹æ¦®çš„å•†æ¥­æ­·å²ã€‚æœ€è¿‘å‰›å®Œæˆä¿®å¾©ä¸¦é‡æ–°é–‹æ”¾ï¼Œå¼·èª¿å…¶æ­·å²é‡è¦æ€§ã€‚', imgUrl: 'https://via.placeholder.com/300x180/8B4513/FFFFFF?text=Shennong+Street' },
            { id: 'twn002', title: 'åœ‹ç«‹æ•…å®®åšç‰©é™¢', location: 'è‡ºåŒ—å¸‚å£«æ—å€', type: 'museum', description: 'æ•…å®®åšç‰©é™¢æ”¶è—äº†è¿‘ä¸ƒåè¬ä»¶ä¸­è¯æ–‡åŒ–æ–‡ç‰©ï¼Œæ˜¯ä¸–ç•Œè‘—åçš„åšç‰©é¤¨ä¹‹ä¸€ã€‚å…¶ä¸­åŒ…å«é’éŠ…å™¨ã€ç“·å™¨ã€ç‰å™¨ã€æ›¸ç•«ç­‰ã€‚2025 å¹´å°‡æ¨å‡ºå®‹ä»£ç¹ªç•«çš„ 4K æ•¸ä½æ²‰æµ¸å¼é«”é©—ï¼Œæ¥µå…·æ•¸ä½æ•™è‚²åƒ¹å€¼ã€‚', imgUrl: 'https://via.placeholder.com/300x180/4682B4/FFFFFF?text=National+Palace+Museum' },
            { id: 'twn003', title: 'æ±æ¸¯è¿ç‹å¹³å®‰ç¥­å…¸', location: 'å±æ±ç¸£æ±æ¸¯é®', type: 'intangible', description: 'æ±æ¸¯è¿ç‹æ˜¯è‡ºç£é‡è¦çš„ç„¡å½¢æ–‡åŒ–è³‡ç”¢ï¼Œä¸»è¦åœ¨ä¸‰å¹´ä¸€ç§‘èˆ‰è¡Œã€‚ç¥­å…¸åŒ…å«è«‹ç‹ã€é¶å¢ƒã€å®´ç‹ã€é€ç‹ç­‰å„€å¼ï¼Œå…·æœ‰é«˜åº¦çš„å®—æ•™èˆ‡åœ°æ–¹æ–‡åŒ–æ„ç¾©ã€‚å·²è¢«åˆ—ç‚ºæ–‡åŒ–è§€å…‰æ¨å»£é‡é»ã€‚', imgUrl: 'https://via.placeholder.com/300x180/B0C4DE/000000?text=Donggang+Ritual' },
        ];


        // ----------------------------------------------------------------------
        // *** 3. AI æ ¸å¿ƒé‚è¼¯å‡½å¼èˆ‡ä¸»ç¨‹åº (AI Core Logic & Main Flow) ***
        // ----------------------------------------------------------------------

        const AI_GUIDE_MODEL = 'gemini-2.5-flash'; // æ¨¡æ“¬ä½¿ç”¨çš„æ¨¡å‹åç¨±
        let isRagConnected = false;
        let currentLanguage = localStorage.getItem('appLang') || 'zh-Hant';


        /**
         * åŸ·è¡Œ AI æ™ºèƒ½å°è¦½å•ç­”çš„æ ¸å¿ƒå‡½å¼ã€‚
         * @param {string} userMessage - ä½¿ç”¨è€…è¼¸å…¥çš„è¨Šæ¯ã€‚
         * @returns {Promise<string>} - AI å›ç­”ã€‚
         */
        async function getAIResponse(userMessage) {
            if (!isRagConnected) {
                return i18n[currentLanguage].chat_init;
            }
            
            // 1. æª¢ç´¢æœ¬åœ° RAG çŸ¥è­˜åº« (Simulated RAG Lookup)
            let ragResult = findRelevantKnowledge(userMessage);
            
            // 2. åˆ¤æ–·æ˜¯å¦éœ€è¦ä½¿ç”¨å¤–éƒ¨å·¥å…· (Google Search Tool)
            let isNeedSearch = shouldCallTool(userMessage);
            
            let context = `ä½¿ç”¨è€…å•é¡Œï¼š${userMessage}\n\n`;
            let toolResult = '';
            
            if (ragResult) {
                context += `[æœ¬åœ°çŸ¥è­˜åº«è³‡æ–™ï¼š${ragResult.title}]\næè¿°ï¼š${ragResult.description}\n`;
            }

            if (isNeedSearch) {
                const query = userMessage.includes('æœ€æ–°') || userMessage.includes('æ–°è') ? userMessage : `å°ç£æ–‡åŒ–è³‡ç”¢ ${userMessage}`;
                try {
                    const searchResults = await google.search({ queries: [query] });
                    toolResult = searchResults.results.map(r => `ä¾†æºï¼š${r.source_title}\næ‘˜è¦ï¼š${r.snippet}\nç¶²å€ï¼š${r.url}`).join('\n---\n');
                    context += `[Google æœå°‹çµæœ]\n${toolResult}\n`;
                } catch (error) {
                    console.error('Google Search Tool æ¨¡æ“¬å¤±æ•—:', error);
                    // å³ä½¿æ¨¡æ“¬å¤±æ•—ï¼Œä»ç¹¼çºŒç”¨ç¾æœ‰ context è®“ AI å›ç­”
                }
            }

            // 3. æ¨¡æ“¬ Gemini æ¨¡å‹ç”Ÿæˆå›ç­”
            // å¯¦éš›éƒ¨ç½²æ™‚ï¼Œé€™è£¡æœƒæ›¿æ›ç‚ºï¼š
            // const response = await gemini.generateContent({ model: AI_GUIDE_MODEL, contents: [{ role: 'user', parts: [{ text: context }] }] });
            
            // æ¨¡æ“¬ AI æ ¹æ“š context ç”Ÿæˆçš„å›ç­”
            let aiResponse = "";
            if (ragResult || toolResult) {
                // AI æ ¹æ“š RAG æˆ– Search çµæœç”Ÿæˆå›ç­”
                if (ragResult && userMessage.includes(ragResult.title.substring(0, 3))) {
                     aiResponse = `æ ¹æ“šæˆ‘å€‘çš„æ–‡åŒ–çŸ¥è­˜åº«ï¼Œæ‚¨æåˆ°çš„ã€Œ${ragResult.title}ã€ä½æ–¼ ${ragResult.location}ï¼Œæ˜¯ä¸€è™•é‡è¦çš„ ${ragResult.type === 'monument' ? 'å¤è¹Ÿ' : ragResult.type === 'museum' ? 'åšç‰©é¤¨' : 'æ–‡åŒ–è³‡ç”¢'}ã€‚å®ƒè¢«æè¿°ç‚ºï¼š${ragResult.description.substring(0, 50)}...ã€‚æƒ³äº†è§£æ›´å¤šç´°ç¯€å—ï¼Ÿ`;
                } else if (toolResult) {
                     aiResponse = `æˆ‘ç‚ºæ‚¨æª¢ç´¢äº†æœ€æ–°çš„è³‡è¨Šã€‚çµæœé¡¯ç¤ºï¼š\n\n${toolResult.split('\n---\n')[0]}\n\nå®Œæ•´è³‡è¨Šè«‹åƒè€ƒè³‡è¨Šä¾†æºã€‚`;
                } else {
                     aiResponse = "é€™æ˜¯ä¸€å€‹é—œæ–¼è‡ºç£æ–‡åŒ–è³‡ç”¢çš„è¤‡é›œå•é¡Œã€‚é›–ç„¶æˆ‘å€‘å·²æª¢ç´¢äº†éƒ¨åˆ†è³‡æ–™ï¼Œä½† AI æ­£åœ¨åŠªåŠ›çµ„ç¹”æ›´å®Œå–„çš„ç­”æ¡ˆã€‚è«‹é‡æ–°æå•æ›´å…·é«”çš„å…§å®¹ï¼";
                }
            } else {
                // AI æ‰¾ä¸åˆ°ç›¸é—œè³‡è¨Šï¼Œæˆ–å•é¡Œå¤ªé€šç”¨
                aiResponse = `æŠ±æ­‰ï¼Œæˆ‘ç›®å‰çš„çŸ¥è­˜åº«å’Œå³æ™‚è³‡è¨Šæºä¸­ï¼Œé‚„æ²’æœ‰é—œæ–¼ã€Œ${userMessage}ã€çš„ç›´æ¥ç­”æ¡ˆã€‚æˆ‘æ˜¯ä¸€å€‹å°ˆæ³¨æ–¼è‡ºç£æ–‡åŒ–èˆ‡ AR/VR é«”é©—çš„ AI å°è¦½åŠ©æ‰‹ï¼Œè«‹å•æ‚¨æƒ³äº†è§£è‡ºç£çš„å¤è¹Ÿã€åšç‰©é¤¨æˆ–æ²‰æµ¸å¼é«”é©—å—ï¼Ÿ`;
            }

            // æ¨¡æ“¬å»¶é²
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            return aiResponse;
        }

        /**
         * è¼”åŠ©å‡½å¼ï¼šæ¨¡æ“¬åˆ¤æ–·æ˜¯å¦éœ€è¦å‘¼å«å¤–éƒ¨å·¥å…· (Function Calling)ã€‚
         * å¯¦éš› AI æ¨¡å‹æœƒè‡ªå‹•æ±ºå®šã€‚é€™è£¡ä½¿ç”¨é—œéµå­—æ¨¡æ“¬ã€‚
         */
        function shouldCallTool(message) {
            const keywords = ['æœ€æ–°', 'æ–°è', 'æœ€è¿‘å…¬å‘Š', 'æ´»å‹•æ—¥æœŸ', 'é–‹æ”¾æ™‚é–“'];
            return keywords.some(keyword => message.includes(keyword));
        }

        /**
         * è¼”åŠ©å‡½å¼ï¼šæ¨¡æ“¬å¾æœ¬åœ°çŸ¥è­˜åº«ä¸­æ‰¾åˆ°ç›¸é—œè³‡æ–™ã€‚
         */
        function findRelevantKnowledge(message) {
            const lowerMsg = message.toLowerCase();
            return ragKnowledgeBase.find(item => 
                lowerMsg.includes(item.title.toLowerCase().substring(0, 3)) || 
                lowerMsg.includes(item.location.toLowerCase().substring(0, 2)) ||
                lowerMsg.includes(item.type)
            );
        }

        // ----------------------------------------------------------------------
        // *** 4. UI äº’å‹•èˆ‡äº‹ä»¶ç›£è½ (UI Interactions and Event Listeners) ***
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ å·²è¼‰å…¥
            const chatWindow = $('#chat');
            const chatInput = $('#chat-input');
            const btnSend = $('#btn-send');
            const geminiApiInput = $('#gemini-api');
            const btnSaveApi = $('#btn-save-api');
            const ragDot = $('#rag-dot');
            const ragText = $('#rag-text');

            // è¼‰å…¥çŸ¥è­˜åº«å¡ç‰‡ (KB Cards) çš„å‡½å¼
            function loadKBCards(data) {
                const kbGrid = $('#kb-grid');
                const tpl = $('#kb-card-tpl');
                kbGrid.innerHTML = '';
                data.forEach(item => {
                    const clone = tpl.content.cloneNode(true);
                    const article = clone.querySelector('.kb-card');
                    article.dataset.id = item.id;
                    article.dataset.filter = item.type;
                    clone.querySelector('.title').textContent = item.title;
                    clone.querySelector('.meta').textContent = `${item.location} | ${item.type === 'monument' ? i18n[currentLanguage].filter_monument : item.type === 'museum' ? i18n[currentLanguage].filter_museum : item.type === 'intangible' ? i18n[currentLanguage].filter_intangible : 'è‡ªå®šç¾©'}`;
                    clone.querySelector('img').src = item.imgUrl || 'https://via.placeholder.com/300x180/0d1323/8090a0?text=Culture+Asset';
                    clone.querySelector('img').alt = item.title;
                    kbGrid.appendChild(clone);
                });
            }

            // å°‡æ¨¡æ“¬è³‡æ–™åº«åˆå§‹è¼‰å…¥åˆ° UI ä¸Š
            loadKBCards(ragKnowledgeBase);

            /**
             * ç™¼é€è¨Šæ¯ä¸¦è™•ç†å›æ‡‰
             */
            async function handleSendMessage() {
                const userMessage = chatInput.value.trim();
                if (userMessage === '') return;

                // 1. é¡¯ç¤ºä½¿ç”¨è€…æ°£æ³¡
                appendMessage(userMessage, 'user');
                chatInput.value = '';
                btnSend.disabled = true;

                // 2. é¡¯ç¤º AI æ€è€ƒä¸­ (Loading) æ°£æ³¡
                const loadingBubble = appendMessage('...', 'ai');
                
                try {
                    // 3. å‘¼å« AI æ ¸å¿ƒ
                    const aiResponse = await getAIResponse(userMessage);
                    
                    // 4. æ›´æ–° AI æ°£æ³¡
                    loadingBubble.textContent = aiResponse;
                    
                } catch (error) {
                    loadingBubble.textContent = i18n[currentLanguage].toast_network_error;
                    console.error("Chat Error:", error);
                } finally {
                    btnSend.disabled = false;
                    // ç¢ºä¿æ²å‹•åˆ°æœ€æ–°è¨Šæ¯
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
            
            /**
             * è¼”åŠ©å‡½å¼ï¼šæ–°å¢èŠå¤©æ°£æ³¡åˆ°èŠå¤©è¦–çª—
             */
            function appendMessage(text, type) {
                const bubble = document.createElement('div');
                bubble.className = `bubble ${type}`;
                bubble.textContent = text;
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return bubble;
            }

            // ------------------- äº‹ä»¶ç›£è½å™¨ -------------------

            // é»æ“Šç™¼é€æŒ‰éˆ•
            btnSend.addEventListener('click', handleSendMessage);
            
            // éµç›¤ Enter ç™¼é€è¨Šæ¯
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // å„²å­˜ API Key
            btnSaveApi.addEventListener('click', () => {
                const key = geminiApiInput.value.trim();
                if (key && key.length > 30) { // æ¨¡æ“¬ä¸€å€‹ç°¡å–®çš„ Key æ ¼å¼æª¢æŸ¥
                    localStorage.setItem('geminiApiKey', key);
                    isRagConnected = true;
                    ragDot.className = 'dot ok';
                    ragText.textContent = i18n[currentLanguage].status_rag.replace('å°šæœªé€£ç·š', 'å·²é€£ç·š');
                    // ç§»é™¤åˆå§‹è¨Šæ¯
                    const initBubble = chatWindow.querySelector('[data-key="chat_init"]');
                    if(initBubble) initBubble.remove();

                    // é¡¯ç¤ºæˆåŠŸæç¤º
                    showToast(i18n[currentLanguage].toast_key_ok, 'success');
                } else {
                    isRagConnected = false;
                    ragDot.className = 'dot';
                    ragText.textContent = i18n[currentLanguage].status_rag;
                    showToast(i18n[currentLanguage].toast_key_bad, 'error');
                }
            });

            // æª¢æŸ¥ API Key ç‹€æ…‹ (åˆå§‹åŒ–æ™‚åŸ·è¡Œ)
            if (localStorage.getItem('geminiApiKey')) {
                geminiApiInput.value = '*************************'; // ä¸é¡¯ç¤ºå¯¦éš› Key
                btnSaveApi.click(); // æ¨¡æ“¬é»æ“Šä¾†é©—è­‰ç‹€æ…‹
            }


            // ------------------- çŸ¥è­˜åº«ç¯©é¸ (Filter) -------------------
            $('#filter-controls').addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('filter')) {
                    $$('.filter').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    
                    const filterType = target.dataset.filter;
                    $$('.kb-card').forEach(card => {
                        if (filterType === 'all' || card.dataset.filter === filterType) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
            });

            // ------------------- AI è‡ªå‹•çˆ¬å–è³‡æ–™ (Simulated AI Fetch) -------------------
            $('#btn-auto-fetch').addEventListener('click', async () => {
                if (!isRagConnected) {
                    return showToast(i18n[currentLanguage].toast_need_key, 'error');
                }
                
                showToast(i18n[currentLanguage].toast_fetching_ai, 'success');
                
                try {
                    // æ¨¡æ“¬å‘¼å« Gemini AI + Google Search Tool ä¾†æŠ½å–ç¶²è·¯è³‡æ–™
                    const searchResults = await google.search({ queries: ['å°ç£æœ€æ–°æ–‡åŒ–è³‡ç”¢å…¬å‘Š'] });
                    
                    let newAssetsCount = 0;
                    searchResults.results.forEach((res, index) => {
                        // æ¨¡æ“¬ AI å¾æ‘˜è¦ä¸­çµæ§‹åŒ–è³‡è¨Š
                        const titleMatch = res.snippet.match(/(è‡ºå—ç¥è¾²è¡—èˆŠå®…ç¾¤|åœ‹ç«‹æ•…å®®åšç‰©é™¢|æ±æ¸¯è¿ç‹å¹³å®‰ç¥­å…¸|é«˜é›„é³³å±±éºå€)/);
                        
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé€™è£¡æˆ‘å€‘åƒ…æ¨¡æ“¬æ–°å¢ã€Œé«˜é›„é³³å±±éºå€ã€ä½œç‚ºæ–°çš„è³‡æ–™ï¼Œé¿å…é‡è¤‡
                        if (titleMatch && titleMatch[0].includes('é³³å±±') && !ragKnowledgeBase.some(item => item.title.includes('é³³å±±'))) {
                            const newAsset = {
                                id: `ai${Date.now() + index}`,
                                title: titleMatch[0],
                                location: 'é«˜é›„å¸‚é³³å±±å€',
                                type: 'monument',
                                description: res.snippet,
                                imgUrl: `https://via.placeholder.com/300x180/4d1111/999999?text=AI+Fetched+${++newAssetsCount}`
                            };
                            ragKnowledgeBase.push(newAsset);
                        }
                    });
                    
                    loadKBCards(ragKnowledgeBase); // é‡æ–°è¼‰å…¥çŸ¥è­˜åº«å¡ç‰‡
                    showToast(i18n[currentLanguage].toast_fetch_ok_ai(newAssetsCount), 'success');

                } catch (error) {
                    console.error('AI Auto Fetch Error:', error);
                    showToast(i18n[currentLanguage].toast_fetch_error_ai, 'error');
                }
            });


            // ------------------- æ¨¡æ…‹æ¡† / å½ˆçª—æ§åˆ¶ -------------------
            const importModal = $('#import-modal');
            const btnImport = $('#btn-import');
            const btnCloseModal = $('#btn-close-modal');
            const btnCancel = $('#btn-cancel');
            const btnSubmit = $('#btn-submit');
            const btnAiSummarize = $('#btn-ai-summarize');

            btnImport.addEventListener('click', () => {
                if (!isRagConnected) {
                    return showToast(i18n[currentLanguage].toast_need_key, 'error');
                }
                importModal.showModal();
            });
            
            [btnCloseModal, btnCancel].forEach(btn => {
                btn.addEventListener('click', () => importModal.close());
            });
            
            // å–®ç­†åŒ¯å…¥é‚è¼¯
            $('#import-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = $('#asset-name').value.trim();
                const location = $('#asset-location').value.trim();
                const type = $('#asset-type').value.trim() || 'custom';
                const imgUrl = $('#asset-img-url').value.trim();
                const desc = $('#asset-desc').value.trim();

                if (name === '' || location === '') {
                    return showToast(i18n[currentLanguage].toast_import_error, 'error');
                }

                const newAsset = {
                    id: `usr${Date.now()}`,
                    title: name,
                    location: location,
                    type: type.toLowerCase().replace(/[^a-z0-9]/g, ''), // ç°¡åŒ–é¡å‹ç‚º filter ç”¨
                    description: desc,
                    imgUrl: imgUrl
                };

                ragKnowledgeBase.push(newAsset);
                loadKBCards(ragKnowledgeBase); // é‡æ–°è¼‰å…¥çŸ¥è­˜åº«å¡ç‰‡

                importModal.close();
                showToast(i18n[currentLanguage].toast_import_ok(name), 'success');
                $('#asset-name').value = ''; // æ¸…ç©ºæ¬„ä½
                $('#asset-location').value = '';
                $('#asset-type').value = '';
                $('#asset-img-url').value = '';
                $('#asset-desc').value = '';
            });

            // æ¨¡æ“¬ AI è‡ªå‹•æ‘˜è¦
            btnAiSummarize.addEventListener('click', async () => {
                const descInput = $('#asset-desc');
                const originalText = descInput.value.trim();
                
                if (originalText.length < 50) {
                    descInput.value = 'è«‹è¼¸å…¥è¶³å¤ é•·çš„æ–‡æœ¬ï¼ˆä¾‹å¦‚ä¸€æ®µç¶­åŸºç™¾ç§‘ä»‹ç´¹ï¼‰è®“ AI é€²è¡Œæ‘˜è¦ã€‚';
                    return;
                }

                showToast(i18n[currentLanguage].toast_ai_summarizing, 'success');
                btnAiSummarize.disabled = true;

                // æ¨¡æ“¬ AI å‘¼å«å»¶é²å’Œæ‘˜è¦é‚è¼¯
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // æ¨¡æ“¬æ‘˜è¦çµæœ
                const simulatedSummary = originalText.substring(0, 50) + '... (AI æ‘˜è¦çµæœ: ç²¾ç…‰äº†æ ¸å¿ƒæ¦‚å¿µèˆ‡æ­·å²èƒŒæ™¯)';
                
                descInput.value = simulatedSummary;
                btnAiSummarize.disabled = false;
                showToast(i18n[currentLanguage].toast_ai_summarize_ok, 'success');
            });


            // ------------------- i18n èªè¨€åˆ‡æ› (éƒ¨åˆ†ç°¡åŒ–) -------------------
            function updateLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('appLang', lang);
                document.documentElement.lang = lang;

                $$('[data-key]').forEach(el => {
                    const key = el.dataset.key;
                    if (i18n[lang] && i18n[lang][key] !== undefined) {
                        el.textContent = i18n[lang][key];
                    }
                });

                // ç‰¹åˆ¥æ›´æ–°å‹•æ…‹å…§å®¹
                if (isRagConnected) {
                    ragText.textContent = i18n[currentLanguage].status_rag.replace('å°šæœªé€£ç·š', 'å·²é€£ç·š');
                }

                showToast(i18n[lang].toast_lang_switched(lang === 'zh-Hant'), 'success');
                // é‡æ–°è¼‰å…¥çŸ¥è­˜åº«å¡ç‰‡ä»¥æ›´æ–°å…§éƒ¨æ–‡å­—
                loadKBCards(ragKnowledgeBase);
            }

            $('#btn-zh').addEventListener('click', () => updateLanguage('zh-Hant'));
            $('#btn-en').addEventListener('click', () => updateLanguage('en'));

            // åˆå§‹åŒ–æ™‚æª¢æŸ¥æœ¬åœ°å„²å­˜çš„èªè¨€è¨­å®š
            if (localStorage.getItem('appLang')) {
                // å¿…é ˆç­‰å¾… DOMContentLoaded å¾Œå†åŸ·è¡Œï¼Œå¦å‰‡ i18n å…ƒç´ å¯èƒ½é‚„æ²’åŠ è¼‰
                updateLanguage(localStorage.getItem('appLang'));
            }

            // ------------------- Toast æç¤ºå‡½å¼ -------------------
            function showToast(message, type = 'default') {
                const toast = $('#toast');
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // ------------------- Leaflet åœ°åœ–åˆå§‹åŒ– -------------------
            const localMap = $('#local-map');
            if (localMap && typeof L !== 'undefined') {
                let map;
                
                 map = L.map('local-map', {
                    center: [23.5, 121], // è‡ºç£ä¸­å¿ƒé»
                    zoom: 8,
                    zoomControl: false, // ç§»é™¤é è¨­ç¸®æ”¾æ§åˆ¶
                    scrollWheelZoom: false // ç¦ç”¨æ»¾è¼ªç¸®æ”¾
                });

                // ä½¿ç”¨ CartoDB Dark Matter ä½œç‚ºåº•åœ–
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // æ¨¡æ“¬ä½¿ç”¨è€…ä½ç½®
                const userLat = 22.9904; // è‡ºå—èµ¤å´æ¨“é™„è¿‘
                const userLng = 120.2084;

                L.marker([userLat, userLng]).addTo(map)
                    .bindPopup(`<b style="color:var(--pri)">${i18n[currentLanguage].user_location}</b>`).openPopup();

                map.setView([userLat, userLng], 14); // å®šä½åˆ°ä½¿ç”¨è€…ä½ç½®

                // æ¨¡æ“¬åœ¨åœ°è³‡æ–™
                const localData = [
                    { lat: 22.9972, lng: 120.2016, name: i18n[currentLanguage].bus_route, desc: i18n[currentLanguage].bus_status, color: 'var(--sec)' },
                    { lat: 22.9881, lng: 120.2078, name: i18n[currentLanguage].event_name, desc: i18n[currentLanguage].event_status, color: 'var(--ok)' }
                ];

                const listEl = $('#local-data-list');
                listEl.innerHTML = '';
                
                localData.forEach(item => {
                    L.circleMarker([item.lat, item.lng], { radius: 6, fillColor: item.color, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.8 }).addTo(map)
                        .bindPopup(`<b>${item.name}</b><br>${item.desc}`);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `<div style="display:flex; align-items:center; gap:.6rem"><span style="display:inline-block; width:10px; height:10px; border-radius:50%; background:${item.color}"></span><div><h4 style="margin:0; font-size:1rem">${item.name}</h4><p style="margin:0; color:var(--muted); font-size:.9rem">${item.desc}</p></div></div>`;
                    listEl.appendChild(li);
                });
                
            } else if (localMap) {
                console.error("Leaflet library not loaded, map initialization skipped.");
            }


            // ------------------- AR/VR äº’å‹• (Hotspot Annotation) -------------------
            const mvAnping = $('#mv-anping');
            if (mvAnping) {
                mvAnping.addEventListener('load', () => {
                    mvAnping.querySelectorAll('.hotspot').forEach(hotspot => {
                        const annotationText = hotspot.dataset.anno;
                        // æ ¹æ“š data-position å±¬æ€§æ‰¾åˆ°å°æ‡‰çš„ annotation slot
                        const annotationEl = mvAnping.querySelector(`.annotation[slot="annotation-${hotspot.slot.replace('hotspot-', '')}"]`);
                        
                        if (annotationEl) {
                            // æ»‘é¼ é€²å…¥ï¼šé¡¯ç¤ºè¨»é‡‹
                            hotspot.addEventListener('mouseover', () => {
                                annotationEl.textContent = annotationText;
                                annotationEl.style.display = 'block';
                            });

                            // æ»‘é¼ é›¢é–‹ï¼šéš±è—è¨»é‡‹
                            hotspot.addEventListener('mouseout', () => {
                                annotationEl.style.display = 'none';
                            });
                        }
                    });
                });
            }

            // ------------------- æ‘ºç–ŠåŠŸèƒ½ -------------------
            $$('.collapsible').forEach(header => {
                header.addEventListener('click', () => {
                    const body = header.nextElementSibling;
                    const caret = header.querySelector('.caret');
                    const isExpanded = header.getAttribute('aria-expanded') === 'true';
                    
                    if (isExpanded) {
                        body.setAttribute('hidden', '');
                        header.setAttribute('aria-expanded', 'false');
                        caret.textContent = 'â–º';
                    } else {
                        body.removeAttribute('hidden');
                        header.setAttribute('aria-expanded', 'true');
                        caret.textContent = 'â–¼';
                    }
                });
            });

        });
    })();
    </script>
</body>
</html>
