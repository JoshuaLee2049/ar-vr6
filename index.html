<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡åŒ–æ™ºéŠ - AI ç§‘æŠ€å„€è¡¨æ¿</title>
    <style>
        /* ============================================== */
        /* --- ç§‘æŠ€å„€è¡¨æ¿ - å…¨å±€è®Šé‡èˆ‡æ·±è‰²ä¸»é¡Œå„ªåŒ– (ç¶­æŒä¸è®Š) --- */
        /* ============================================== */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');
        :root {
            --bg-color-dark: #070718;
            --primary-color: #00ffff; 
            --secondary-color: #bb00ff; 
            --text-color: #e6f7ff; 
            --text-muted: #8090a0;
            --glass-bg: rgba(0, 0, 0, 0.7); 
            --glass-border: rgba(0, 255, 255, 0.2); 
            --glass-border-dark: rgba(255, 255, 255, 0.05);
            --soft-glow-primary: 0 0 15px rgba(0, 255, 255, 0.4), 0 0 5px rgba(0, 255, 255, 0.2);
            --soft-glow-secondary: 0 0 15px rgba(187, 0, 255, 0.4), 0 0 5px rgba(187, 0, 255, 0.2);
            --success-color: #4aff8f; 
            --error-color: #ff4a4a;
            --radius: 18px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color-dark);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(0, 255, 255, 0.1), transparent 30%),
                radial-gradient(circle at 85% 75%, rgba(187, 0, 255, 0.1), transparent 35%),
                linear-gradient(135deg, #070718 0%, #030018 100%);
            color: var(--text-color);
            padding: 2.5rem; 
            min-height: 100vh;
        }

        /* æ ¸å¿ƒå…ƒä»¶æ¨£å¼ (ç»ç’ƒé¢æ¿ã€æŒ‰éˆ•ã€è¼¸å…¥æ¡†ç­‰èˆ‡å‰ç‰ˆæœ¬ç›¸åŒï¼Œç‚ºç¯€çœç©ºé–“åƒ…åˆ—å‡ºä¸»è¦è®Šæ•¸ï¼Œä½†æ‰€æœ‰ç´°ç¯€ä»è¢«ä¿ç•™) */
        .glass-panel {
            background: var(--glass-bg);
            border-radius: var(--radius);
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border-dark);
            border-image: linear-gradient(45deg, rgba(0, 255, 255, 0.3) 0%, rgba(187, 0, 255, 0.3) 50%, rgba(0, 255, 255, 0.3) 100%) 1;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7), 0 0 20px rgba(0, 255, 255, 0.05), 0 0 40px rgba(187, 0, 255, 0.1);
            padding: 2rem; 
            margin-bottom: 2rem;
            transition: all 0.4s ease;
        }
        .glass-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 35px rgba(0, 0, 0, 0.8), var(--soft-glow-primary);
        }
        .module-header-icon {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--bg-color-dark);
            font-family: 'Orbitron', monospace;
            border-radius: 10px;
        }
        .module-header h2 { color: var(--primary-color); text-shadow: 0 0 5px rgba(0, 255, 255, 0.3); }
        .tech-button {
            border: 2px solid var(--primary-color);
            color: var(--primary-color); 
            background: rgba(0, 255, 255, 0.05);
            border-radius: 10px;
            font-family: 'Noto Sans TC', sans-serif; 
            letter-spacing: 1px;
            text-transform: none;
        }
        .tech-button.primary { 
            background: linear-gradient(90deg, var(--primary-color), #00aaff);
            color: var(--bg-color-dark); 
        }
        .tech-input {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border-dark); 
            border-radius: 10px;
            color: var(--text-color); 
        }
        .main-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2rem; }
        
        /* Modal & Lang Switch æ¨£å¼ (ç¶­æŒä¸è®Š) */
        .modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal-content {
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--soft-glow-primary);
            padding: 2.5rem;
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { border-bottom: 2px solid var(--secondary-color); }
        .close-btn { color: var(--text-muted); font-size: 2rem; }

        .lang-switch {
            position: absolute;
            top: 2.5rem;
            right: 2.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            z-index: 100;
        }
        .lang-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border-dark);
            color: var(--text-muted);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .lang-btn.active, .lang-btn:hover {
            background: var(--primary-color);
            color: var(--bg-color-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ (ç¶­æŒä¸è®Š) */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .main-grid { grid-template-columns: 1fr; gap: 1rem; }
            .lang-switch { position: static; justify-content: flex-start; margin-bottom: 1rem; }
        }
    </style>
</head>
<body>

    <div class="lang-switch">
        <span style="color: var(--text-color); font-size: 0.9rem;">ä»‹é¢èªè¨€:</span>
        <button class="lang-btn active" data-lang="zh-Hant" id="lang-zh-hant">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="en" id="lang-en">English</button>
    </div>

    <header class="header-zone">
        <h1 data-key="title">æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿</h1>
        <nav class="nav-links">
            <a href="#" class="active" data-key="nav_guide">å°è¦½</a>
            <a href="#" data-key="nav_knowledge">çŸ¥è­˜åº«</a>
            <a href="#" data-key="nav_experience">é«”é©—</a>
            <a href="#" data-key="nav_personal">å€‹äººä¸­å¿ƒ</a>
        </nav>
    </header>

    <main class="main-grid">

        <section class="glass-panel api-settings">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">API</span></div>
                <h2 data-key="h2_api">API æ•´åˆæœå‹™æ¨¡çµ„</h2>
                <p data-key="p_api">ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š</p>
            </div>
            <div class="api-settings-grid">
                <div class="api-key-input">
                    <label for="gemini-api-key">Gemini API Key</label>
                    <input type="password" id="gemini-api-key" class="tech-input" value="">
                </div>
                <div class="api-key-input">
                    <label for="map-api">Maps API</label>
                    <input type="password" id="map-api" class="tech-input" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="api-key-input">
                    <label for="data-api">Data.gov.tw (PTX)</label>
                    <input type="password" id="data-api" class="tech-input" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end; align-items: center;">
                <div class="api-status">
                    <span class="status-dot" id="rag-status-dot"></span>
                    <span id="rag-status-text" data-key="status_rag">RAG æœå‹™ï¼šå°šæœªé€£ç·š</span>
                </div>
                <div class="api-status">
                    <span class="status-dot active" style="background-color: var(--success-color);"></span>
                    <span data-key="status_data">é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­</span>
                </div>
                <button class="tech-button primary" id="save-api-settings" data-key="btn_save">å„²å­˜è¨­å®š</button>
            </div>
        </section>

        <section class="glass-panel ai-guide">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">AI</span></div>
                <h2 data-key="h2_guide">AI æ™ºèƒ½å°è¦½</h2>
                <p data-key="p_guide">æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°</p>
            </div>
            <div class="chat-window" id="chat-window">
                <div class="chat-bubble ai" data-key="chat_init">
                    [ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚
                </div>
            </div>
            <div class="chat-input-area">
                <button class="tech-button"><span class="icon-text">ğŸ¤</span></button>
                <input type="text" class="tech-input" id="chat-input" data-key="placeholder_chat" placeholder="è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...">
                <button class="tech-button primary" id="chat-send-btn" data-key="btn_send">ç™¼é€</button>
            </div>
        </section>

        <section class="glass-panel knowledge-base">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">DB</span></div>
                <h2 data-key="h2_db">æ–‡åŒ–çŸ¥è­˜åº«</h2>
                <p data-key="p_db">æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)</p>
                <button class="tech-button" id="import-data-btn" data-key="btn_import">
                    <span class="icon-text">â†“</span> åŒ¯å…¥æ–°è³‡æ–™
                </button>
            </div>
            <div class="search-bar">
                <input type="text" class="tech-input" data-key="placeholder_search" placeholder="æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...">
            </div>
            <div class="filters">
                <span class="filter-chip active" data-key="filter_all">å…¨éƒ¨</span>
                <span class="filter-chip" data-key="filter_monument">å¤è¹Ÿ</span>
                <span class="filter-chip" data-key="filter_museum">åšç‰©é¤¨</span>
                <span class="filter-chip" data-key="filter_intangible">ç„¡å½¢æ–‡åŒ–</span>
            </div>
            <div class="knowledge-grid" id="knowledge-grid">
                <div class="knowledge-card" data-card-id="1" data-title-zh="èµ¤å´æ¨“" data-info-zh="å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ" data-title-en="Chikan Tower" data-info-en="Tainan / Grade 1 Monument">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Chikan+Tower" alt="èµ¤å´æ¨“">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">èµ¤å´æ¨“</h4>
                        <p class="card-info">å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ</p>
                    </div>
                </div>
                <div class="knowledge-card" data-card-id="2" data-title-zh="è¥¿é–€ç´…æ¨“" data-info-zh="å°åŒ—å¸‚ / æ­·å²å»ºç¯‰" data-title-en="Ximen Red House" data-info-en="Taipei / Historical Building">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Red+House" alt="è¥¿é–€ç´…æ¨“">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">è¥¿é–€ç´…æ¨“</h4>
                        <p class="card-info">å°åŒ—å¸‚ / æ­·å²å»ºç¯‰</p>
                    </div>
                </div>
                <div class="knowledge-card" data-card-id="3" data-title-zh="åª½ç¥–ç¹å¢ƒ" data-info-zh="ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–" data-title-en="Mazu Pilgrimage" data-info-en="Central Taiwan / Intangible Heritage">
                    <img src="https://via.placeholder.com/300x200/222233/aaaaaa?text=Mazu+Pilgrimage" alt="åª½ç¥–ç¹å¢ƒ">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">åª½ç¥–ç¹å¢ƒ</h4>
                        <p class="card-info">ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–</p>
                    </div>
                </div>
                </div>
        </section>

        <section class="glass-panel immersive-experience">
            <div class="module-header">
                <div class="module-header-icon"><span class="icon-text">AR</span></div>
                <h2 data-key="h2_immersive">æ²‰æµ¸å¼é«”é©—</h2>
                <p data-key="p_immersive">å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ</p>
            </div>
            <div class="immersive-grid">
                 <div class="experience-card">
                    <img src="https://via.placeholder.com/400x300/331144/cccccc?text=AR+Restore" alt="AR é«”é©—">
                    <div class="experience-overlay">
                        <span class="ar" data-key="tag_ar">AR å¯¦æ™¯é‚„åŸ</span>
                        <h4 data-key="h4_anping">å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632</h4>
                    </div>
                </div>
                <div class="experience-card">
                    <img src="https://via.placeholder.com/400x300/113333/cccccc?text=VR+Gallery" alt="VR é«”é©—">
                    <div class="experience-overlay">
                        <span data-key="tag_vr">VR è™›æ“¬å±•é¤¨</span>
                        <h4 data-key="h4_taipei">å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)</h4>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass-panel local-info">
             <div class="module-header collapsible" id="local-info-header">
                <div class="module-header-icon"><span class="icon-text">GPS</span></div>
                <h2 data-key="h2_local">åœ¨åœ°å³æ™‚è³‡è¨Š</h2>
                <p data-key="p_local">æ•´åˆé–‹æ”¾è³‡æ–™</p>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="module-content">
                <div class="map-placeholder" data-key="map_placeholder">--- äº’å‹•åœ°åœ–è¼‰å…¥å€åŸŸ ---</div>
                <div class="info-list">
                    <div class="info-list-item">
                        <div class="info-icon"><span class="icon-text">BUS</span></div>
                        <div class="info-text">
                            <h5 data-key="bus_route">[å¸‚å€å…¬è»Š] 77è·¯</h5>
                            <p data-key="bus_status">å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™ (3 åˆ†é˜)</p>
                        </div>
                    </div>
                    <div class="info-list-item">
                        <div class="info-icon"><span class="icon-text">EVT</span></div>
                        <div class="info-text">
                            <h5 data-key="event_name">[ç¯€æ…¶æ´»å‹•] åºœåŸæ–‡åŒ–ç¯€</h5>
                            <p data-key="event_status">é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€ (è·é›¢ 1.2km)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass-panel personal-center">
             <div class="module-header collapsible" id="personal-center-header">
                <div class="module-header-icon"><span class="icon-text">USR</span></div>
                <h2 data-key="h2_personal">å€‹äººåŒ–ä¸­å¿ƒ</h2>
                <p data-key="p_personal">æ‚¨çš„æ–‡åŒ–è¶³è·¡</p>
                <span class="collapse-icon">â–¼</span>
            </div>
            <div class="module-content">
                <div class="personal-grid">
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">â™¥</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_fav">æˆ‘çš„æ”¶è—</h4>
                            <p data-key="card_fav_p">æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½</p>
                        </div>
                    </div>
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">âœˆ</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_trip">æˆ‘çš„è¡Œç¨‹</h4>
                            <p data-key="card_trip_p">æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)</p>
                        </div>
                    </div>
                    <div class="personal-card">
                        <div class="personal-icon"><span class="icon-text">â˜†</span></div>
                        <div class="personal-card-content">
                            <h4 data-key="card_ach">æˆ‘çš„æˆå°±</h4>
                            <p data-key="card_ach_p">å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="modal_title">åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢</h3>
                <span class="close-btn">&times;</span>
            </div>
            <form id="new-data-form">
                <div class="modal-form-group">
                    <label for="asset-name" data-key="modal_label_name">è³‡ç”¢åç¨± (å¿…å¡«)</label>
                    <input type="text" id="asset-name" class="tech-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="asset-location" data-key="modal_label_location">åœ°é» / ç¸£å¸‚ (å¿…å¡«)</label>
                    <input type="text" id="asset-location" class="tech-input" required>
                </div>
                <div class="modal-form-group">
                    <label for="asset-type" data-key="modal_label_type">é¡å‹ (å¤è¹Ÿ/åšç‰©é¤¨/ç„¡å½¢æ–‡åŒ–...)</label>
                    <input type="text" id="asset-type" class="tech-input">
                </div>
                <div class="modal-form-group">
                    <label for="asset-desc" data-key="modal_label_desc">ç°¡è¦æè¿° (ç”¨æ–¼ AI å°è¦½ RAG)</label>
                    <textarea id="asset-desc" class="tech-input"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button class="tech-button" data-key="btn_cancel" id="modal-cancel-btn">å–æ¶ˆ</button>
                <button class="tech-button primary" data-key="btn_submit" id="modal-submit-btn">åŒ¯å…¥ä¸¦å•Ÿç”¨</button>
            </div>
        </div>
    </div>

    <div class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- å…¨å±€ç‹€æ…‹èˆ‡ DOM ç¯€é»ç²å– (ç¶­æŒä¸è®Š) ---
            let isApiValid = false;
            let isRAGReady = false;
            let currentLang = 'zh-Hant'; // é è¨­èªè¨€

            const saveApiBtn = document.getElementById('save-api-settings');
            const geminiApiKeyInput = document.getElementById('gemini-api-key');
            const ragStatusDot = document.getElementById('rag-status-dot');
            const ragStatusText = document.getElementById('rag-status-text');
            const importDataBtn = document.getElementById('import-data-btn');
            const knowledgeGrid = document.getElementById('knowledge-grid');
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const collapsibleHeaders = document.querySelectorAll('.module-header.collapsible');
            const modal = document.getElementById('importModal');
            const closeModalBtn = modal.querySelector('.close-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSubmitBtn = document.getElementById('modal-submit-btn');
            const newDataForm = document.getElementById('new-data-form');
            const langBtns = document.querySelectorAll('.lang-btn');
            
            // --- é è¨­ RAG æ•¸æ“š (åƒ…åŒ…å«åŸæœ¬çš„ 3 å€‹ï¼Œè‡ªå®šç¾©æ•¸æ“šæœƒå¾ LocalStorage è¼‰å…¥) ---
            const defaultKnowledge = [
                { id: '1', title_zh: 'èµ¤å´æ¨“', info_zh: 'å°å—å¸‚ / ä¸€ç´šå¤è¹Ÿ', title_en: 'Chikan Tower', info_en: 'Tainan / Grade 1 Monument', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Chikan+Tower', desc: 'èµ¤å´æ¨“å§‹å»ºæ–¼ 1653 å¹´ï¼Œç‚ºè·è˜­äººæ‰€å»ºï¼Œæ­·ç¶“æ¸…æœé‡å»ºèˆ‡æ—¥æ²»æ™‚æœŸä¿®ç¹•ï¼Œæ˜¯å°å—æœ€å…·ä»£è¡¨æ€§çš„å¤è¹Ÿä¹‹ä¸€ã€‚' },
                { id: '2', title_zh: 'è¥¿é–€ç´…æ¨“', info_zh: 'å°åŒ—å¸‚ / æ­·å²å»ºç¯‰', title_en: 'Ximen Red House', info_en: 'Taipei / Historical Building', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Red+House', desc: 'è¥¿é–€ç´…æ¨“æ˜¯ä¸€åº§å…©å±¤é«˜çš„ç´…ç£šæ´‹æ¨“ï¼Œè¦‹è­‰äº†è¥¿é–€ç”ºçš„æ­·å²ç™¼å±•ã€‚' },
                { id: '3', title_zh: 'åª½ç¥–ç¹å¢ƒ', info_zh: 'ä¸­å°ç£ / ç„¡å½¢æ–‡åŒ–', title_en: 'Mazu Pilgrimage', info_en: 'Central Taiwan / Intangible Heritage', img_url: 'https://via.placeholder.com/300x200/222233/aaaaaa?text=Mazu+Pilgrimage', desc: 'æ¶å­¤æ˜¯ä¸­å…ƒæ™®æ¸¡çš„æ´»å‹•ï¼Œæ†æ˜¥èˆ‡å®œè˜­é ­åŸæœ€ç‚ºè‘—åï¼Œæ—¨åœ¨å¼·èª¿å°å…ˆäººçš„æ•¬ç•èˆ‡ç¤¾å€åœ˜çµã€‚' }
            ];

            // --- ç¿»è­¯å­—å…¸ (ç¶­æŒä¸è®Š) ---
            const translations = {
                'zh-Hant': {
                    title: 'æ–‡åŒ–æ™ºéŠå„€è¡¨æ¿', nav_guide: 'å°è¦½', nav_knowledge: 'çŸ¥è­˜åº«', nav_experience: 'é«”é©—', nav_personal: 'å€‹äººä¸­å¿ƒ',
                    h2_api: 'API æ•´åˆæœå‹™æ¨¡çµ„', p_api: 'ç³»çµ±æœå‹™ç‹€æ…‹èˆ‡é‡‘é‘°è¨­å®š', status_rag: 'RAG æœå‹™ï¼šå°šæœªé€£ç·š', status_data: 'é–‹æ”¾è³‡æ–™ï¼šåŒæ­¥ä¸­', btn_save: 'å„²å­˜è¨­å®š',
                    h2_guide: 'AI æ™ºèƒ½å°è¦½', p_guide: 'æ‚¨çš„éš¨èº«æ–‡åŒ–åš®å°', chat_init: '[ç³»çµ±åˆå§‹åŒ–] æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Gemini Key ä»¥é€£ç·šæ–‡åŒ–çŸ¥è­˜åº«ã€‚', placeholder_chat: 'è¼¸å…¥æ‚¨çš„æ–‡åŒ–å•é¡Œæˆ–å°è¦½éœ€æ±‚...', btn_send: 'ç™¼é€',
                    h2_db: 'æ–‡åŒ–çŸ¥è­˜åº«', p_db: 'æ¢ç´¢å…¨å°æ–‡åŒ–è³‡ç”¢ (RAG è³‡æ–™æº)', btn_import: 'åŒ¯å…¥æ–°è³‡æ–™', placeholder_search: 'æœå°‹å¤è¹Ÿã€æ–‡ç‰©ã€æ­·å²äº‹ä»¶...', 
                    filter_all: 'å…¨éƒ¨', filter_monument: 'å¤è¹Ÿ', filter_museum: 'åšç‰©é¤¨', filter_intangible: 'ç„¡å½¢æ–‡åŒ–',
                    h2_immersive: 'æ²‰æµ¸å¼é«”é©—', p_immersive: 'å•Ÿå‹•æ‚¨çš„æ™‚å…‰æ©Ÿ', tag_ar: 'AR å¯¦æ™¯é‚„åŸ', h4_anping: 'å®‰å¹³å¤å ¡ï¼šç†±è˜­é®åŸ 1632', tag_vr: 'VR è™›æ“¬å±•é¤¨', h4_taipei: 'å·²æ¶ˆå¤±çš„å°åŒ—åŸç‰† (æ•¸ä½é‡å»º)',
                    h2_local: 'åœ¨åœ°å³æ™‚è³‡è¨Š', p_local: 'æ•´åˆé–‹æ”¾è³‡æ–™', map_placeholder: '--- äº’å‹•åœ°åœ–è¼‰å…¥å€åŸŸ ---', bus_route: '[å¸‚å€å…¬è»Š] 77è·¯', bus_status: 'å³å°‡æŠµé”ï¼šèµ¤å´æ¨“ç«™ (3 åˆ†é˜)', event_name: '[ç¯€æ…¶æ´»å‹•] åºœåŸæ–‡åŒ–ç¯€', event_status: 'é€²è¡Œä¸­ï¼šå­”å»Ÿåœ’å€ (è·é›¢ 1.2km)',
                    h2_personal: 'å€‹äººåŒ–ä¸­å¿ƒ', p_personal: 'æ‚¨çš„æ–‡åŒ–è¶³è·¡', card_fav: 'æˆ‘çš„æ”¶è—', card_fav_p: 'æ‚¨å·²æ”¶è— 12 å€‹æ™¯é»èˆ‡ 3 ç¯‡å°è¦½', card_trip: 'æˆ‘çš„è¡Œç¨‹', card_trip_p: 'æ‚¨æœ‰ 1 å€‹å³å°‡åˆ°ä¾†çš„è¡Œç¨‹ (å°å—ä¸‰æ—¥éŠ)', card_ach: 'æˆ‘çš„æˆå°±', card_ach_p: 'å·²è§£é–ã€ŒåºœåŸæ¢ç´¢è€…ã€å¾½ç« ',
                    modal_title: 'åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', modal_label_name: 'è³‡ç”¢åç¨± (å¿…å¡«)', modal_label_location: 'åœ°é» / ç¸£å¸‚ (å¿…å¡«)', modal_label_type: 'é¡å‹', modal_label_desc: 'ç°¡è¦æè¿°', btn_cancel: 'å–æ¶ˆ', btn_submit: 'åŒ¯å…¥ä¸¦å•Ÿç”¨'
                },
                'en': {
                    title: 'Culture Guide Dashboard', nav_guide: 'Guide', nav_knowledge: 'Knowledge Base', nav_experience: 'Experience', nav_personal: 'Personal Center',
                    h2_api: 'API Integration Module', p_api: 'System Status and Key Settings', status_rag: 'RAG Service: Disconnected', status_data: 'Open Data: Syncing', btn_save: 'Save Settings',
                    h2_guide: 'AI Smart Guide', p_guide: 'Your Personal Culture Companion', chat_init: '[System Init] RAG Core Offline. Please enter your Gemini Key above to connect the Knowledge Base.', placeholder_chat: 'Enter your culture question or guidance request...', btn_send: 'Send',
                    h2_db: 'Cultural Knowledge Base', p_db: 'Explore Taiwan\'s Cultural Assets (RAG Source)', btn_import: 'Import New Data', placeholder_search: 'Search: Monuments, artifacts, history...', 
                    filter_all: 'ALL', filter_monument: 'Monuments', filter_museum: 'Museums', filter_intangible: 'Intangible',
                    h2_immersive: 'Immersive Experience', p_immersive: 'Launch Your Time Machine', tag_ar: 'AR Live Restoration', h4_anping: 'Anping Fort: Zeelandia 1632', tag_vr: 'VR Virtual Exhibition', h4_taipei: 'Lost Taipei City Walls (Digital)',
                    h2_local: 'Local Real-Time Info', p_local: 'Open Data Integration', map_placeholder: '--- Interactive Map Loading Area ---', bus_route: '[TRANSIT] Route 77', bus_status: 'Arriving: Chikan Tower (3 min)', event_name: '[EVENT] Fucheng Culture Fest', event_status: 'Active: Confucius Temple (1.2km)',
                    h2_personal: 'Personal Center', p_personal: 'Your Cultural Footprint', card_fav: 'My Favorites', card_fav_p: '12 assets and 3 tours saved.', card_trip: 'My Trips', card_trip_p: '1 upcoming itinerary (Tainan 3-Day)', card_ach: 'My Achievements', card_ach_p: 'Achieved: \'Fucheng Explorer\' Badge',
                    modal_title: 'Import Custom Cultural Asset', modal_label_name: 'Asset Name (Required)', modal_label_location: 'Location / City (Required)', modal_label_type: 'Type', modal_label_desc: 'Brief Description (for RAG)', btn_cancel: 'Cancel', btn_submit: 'Import & Activate'
                }
            };

            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 1: Local Storage å­˜å–èˆ‡é é¢è¼‰å…¥ ---
            // --------------------------------------------------------------------------------

            // å­˜å„²æ•¸æ“šåˆ° Local Storage
            function saveState() {
                localStorage.setItem('geminiKey', geminiApiKeyInput.value);
                localStorage.setItem('isRAGReady', isRAGReady);
                localStorage.setItem('currentLang', currentLang);
            }

            // è¼‰å…¥ API Key å’Œ RAG ç‹€æ…‹
            function loadAPIState() {
                const storedKey = localStorage.getItem('geminiKey');
                const storedRAG = localStorage.getItem('isRAGReady') === 'true';

                if (storedKey) {
                    // æ¢å¾© Key è¼¸å…¥æ¡† (ä»¥å¯†ç¢¼å½¢å¼)
                    geminiApiKeyInput.value = storedKey;
                    
                    // æ¢å¾© RAG ç‹€æ…‹
                    isRAGReady = storedRAG;
                    isApiValid = storedRAG;

                    if (isRAGReady) {
                        ragStatusDot.classList.add('active');
                        ragStatusText.textContent = translations[currentLang].status_rag.replace('å°šæœªé€£ç·š', 'å·²é€£ç·š');
                        geminiApiKeyInput.style.borderColor = 'var(--success-color)';
                        // åˆå§‹èŠå¤©è¨Šæ¯ï¼šå·²é€£ç·š
                        chatWindow.innerHTML = `<div class="chat-bubble ai">${translations[currentLang].chat_init.replace('æª¢æ¸¬åˆ° RAG æ ¸å¿ƒæœªå•Ÿå‹•', 'RAG æ ¸å¿ƒå·²æ–¼ä¸Šæ¬¡é€£ç·šæ™‚å•Ÿå‹•')}</div>`;
                    } else {
                        // é›–ç„¶æœ‰ keyï¼Œä½†ä¸Šæ¬¡å¯èƒ½æ˜¯ç„¡æ•ˆç‹€æ…‹
                        ragStatusDot.classList.remove('active');
                        ragStatusText.textContent = translations[currentLang].status_rag; // å°šæœªé€£ç·š
                        geminiApiKeyInput.style.borderColor = 'var(--glass-border-dark)';
                        // åˆå§‹èŠå¤©è¨Šæ¯ï¼šæœªé€£ç·š
                        chatWindow.innerHTML = `<div class="chat-bubble ai">${translations[currentLang].chat_init}</div>`;
                    }
                }
            }

            // è¼‰å…¥èªè¨€è¨­å®š
            function loadLanguage() {
                const storedLang = localStorage.getItem('currentLang');
                if (storedLang && translations[storedLang]) {
                    applyTranslation(storedLang);
                }
            }
            
            // è¼‰å…¥è‡ªå®šç¾©çŸ¥è­˜åº«æ•¸æ“š
            function loadCustomData() {
                const storedData = localStorage.getItem('customKnowledge');
                const customAssets = storedData ? JSON.parse(storedData) : [];
                
                // æ¸…ç©ºé è¨­å¡ç‰‡ï¼Œåªä¿ç•™é è¨­çš„ 3 å€‹ DOM å…ƒç´ 
                knowledgeGrid.innerHTML = knowledgeGrid.innerHTML.trim().split('</div>').slice(0, 3).join('</div>') + '</div>';

                // é‡æ–°çµ„åˆæ‰€æœ‰æ•¸æ“š (é è¨­ + è‡ªå®šç¾©)
                const allAssets = defaultKnowledge.concat(customAssets);
                
                // é‡æ–°ç¹ªè£½æ‰€æœ‰å¡ç‰‡
                knowledgeGrid.innerHTML = '';
                allAssets.forEach(asset => {
                    knowledgeGrid.prepend(createKnowledgeCardDOM(asset));
                });
            }

            // åŸ·è¡Œè¼‰å…¥æ‰€æœ‰ç‹€æ…‹
            loadLanguage();
            loadCustomData(); 
            loadAPIState(); // å¿…é ˆåœ¨ loadLanguage ä¹‹å¾Œï¼Œæ‰èƒ½ä½¿ç”¨æ­£ç¢ºçš„ç¿»è­¯æ–‡æœ¬

            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 2: æ•¸æ“šç®¡ç†è¼”åŠ©å‡½æ•¸ ---
            // --------------------------------------------------------------------------------

            // å‰µå»ºçŸ¥è­˜åº«å¡ç‰‡çš„ DOM å…ƒç´ 
            function createKnowledgeCardDOM(asset) {
                const newCard = document.createElement('div');
                newCard.className = 'knowledge-card';
                newCard.setAttribute('data-card-id', asset.id);
                newCard.setAttribute('data-title-zh', asset.title_zh);
                newCard.setAttribute('data-info-zh', asset.info_zh);
                newCard.setAttribute('data-title-en', asset.title_en);
                newCard.setAttribute('data-info-en', asset.info_en);

                const imageUrl = asset.img_url || `https://via.placeholder.com/300x200/4a4a5a/ffffff?text=${asset.title_zh.substring(0, 10)}`;

                newCard.innerHTML = `
                    <img src="${imageUrl}" alt="${asset.title_zh}">
                    <div class="knowledge-card-content">
                        <h4 class="card-title">${asset.title_zh}</h4>
                        <p class="card-info">${asset.info_zh}</p>
                    </div>
                `;
                return newCard;
            }

            // ç²å–æ‰€æœ‰ RAG æ•¸æ“š (åŒ…å«é è¨­å’Œè‡ªå®šç¾©)
            function getAllRAGData() {
                const storedData = localStorage.getItem('customKnowledge');
                const customAssets = storedData ? JSON.parse(storedData) : [];
                return defaultKnowledge.concat(customAssets);
            }

            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 3: èªè¨€åˆ‡æ› / è‡ªå‹•ç¿»è­¯ (ä¿®æ”¹ç‚ºå„²å­˜èªè¨€) ---
            // --------------------------------------------------------------------------------
            function applyTranslation(lang) {
                currentLang = lang;
                const dict = translations[lang];

                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    if (dict[key]) {
                        if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                            el.placeholder = dict[key];
                        } else {
                            el.textContent = dict[key];
                        }
                    }
                });

                // ç¿»è­¯çŸ¥è­˜åº«å¡ç‰‡
                document.querySelectorAll('.knowledge-card').forEach(card => {
                    const titleEl = card.querySelector('.card-title');
                    const infoEl = card.querySelector('.card-info');
                    if (titleEl && infoEl) {
                        titleEl.textContent = card.getAttribute(`data-title-${lang}`) || card.getAttribute('data-title-zh');
                        infoEl.textContent = card.getAttribute(`data-info-${lang}`) || card.getAttribute('data-info-zh');
                    }
                });

                // æ›´æ–°èªè¨€æŒ‰éˆ•çš„ active ç‹€æ…‹
                langBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-lang') === lang) {
                        btn.classList.add('active');
                    }
                });
                
                // å„²å­˜èªè¨€è¨­å®š
                localStorage.setItem('currentLang', lang);
            }

            // ç›£è½èªè¨€åˆ‡æ›æŒ‰éˆ•
            langBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.getAttribute('data-lang');
                    applyTranslation(lang);
                    showToast(translations[currentLang].btn_save.replace('å„²å­˜è¨­å®š', `ä»‹é¢å·²åˆ‡æ›ç‚º ${lang === 'zh-Hant' ? 'ç¹é«”ä¸­æ–‡' : 'English'} (æ¨¡æ“¬ç¿»è­¯)`), 'success');
                });
            });

            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 4: API Key å„²å­˜èˆ‡é©—è­‰ (ä¿®æ”¹ç‚ºå„²å­˜ç‹€æ…‹) ---
            // --------------------------------------------------------------------------------
            saveApiBtn.addEventListener('click', () => {
                const apiKey = geminiApiKeyInput.value;
                const isChinese = currentLang === 'zh-Hant';
                
                if (apiKey && apiKey.length > 10) {
                    isApiValid = true;
                    isRAGReady = true; 
                    ragStatusDot.classList.add('active');
                    ragStatusText.textContent = isChinese ? 'RAG æœå‹™ï¼šå·²é€£ç·š' : 'RAG Service: Connected';
                    geminiApiKeyInput.style.borderColor = 'var(--success-color)';
                    showToast(isChinese ? 'Gemini API Key å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼æœå‹™æ ¸å¿ƒå•Ÿå‹•ã€‚' : 'Gemini API Key validated! Service core started.', 'success');
                    addChatMessage('AI', isChinese ? 'æœå‹™å·²å•Ÿå‹•ã€‚RAG æª¢ç´¢åŠŸèƒ½å·²æº–å‚™å°±ç·’ï¼Œæ‚¨å¯ä»¥é–‹å§‹æå•äº†ï¼' : 'Service initiated. RAG retrieval is ready. You may start querying!');
                } else {
                    isApiValid = false;
                    isRAGReady = false;
                    ragStatusDot.classList.remove('active');
                    ragStatusText.textContent = isChinese ? 'RAG æœå‹™ï¼šé‡‘é‘°ç„¡æ•ˆ' : 'RAG Service: Invalid Key';
                    geminiApiKeyInput.style.borderColor = 'var(--error-color)';
                    showToast(isChinese ? 'Gemini API Key æ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆã€‚' : 'Gemini API Key error or invalid.', 'error');
                }
                
                // å‘¼å«å„²å­˜ç‹€æ…‹
                saveState(); 
            });


            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 5: Modal è¡¨å–®æäº¤ (ä¿®æ”¹ç‚ºå„²å­˜è‡ªå®šç¾©æ•¸æ“š) ---
            // --------------------------------------------------------------------------------
            
            // é¡¯ç¤º/éš±è— Modal (ç¶­æŒä¸è®Š)
            importDataBtn.addEventListener('click', () => { modal.classList.add('show'); });
            const hideModal = () => { modal.classList.remove('show'); };
            closeModalBtn.addEventListener('click', hideModal);
            modalCancelBtn.addEventListener('click', hideModal);
            window.addEventListener('click', (event) => { if (event.target === modal) { hideModal(); } });

            // è¡¨å–®æäº¤é‚è¼¯ (ä¿®æ”¹)
            modalSubmitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('asset-name');
                const locationInput = document.getElementById('asset-location');
                const typeInput = document.getElementById('asset-type');
                const descInput = document.getElementById('asset-desc');

                if (!nameInput.value || !locationInput.value) {
                    showToast(translations[currentLang].modal_title.replace('åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', 'è«‹å¡«å¯«è³‡ç”¢åç¨±å’Œåœ°é»ï¼'), 'error');
                    return;
                }
                
                modalSubmitBtn.disabled = true;
                modalSubmitBtn.textContent = 'åŒ¯å…¥ä¸­...';

                // æ¨¡æ“¬è™•ç†å»¶é²
                setTimeout(() => {
                    const newAsset = {
                        id: Date.now().toString(),
                        title_zh: nameInput.value,
                        info_zh: `${locationInput.value} / ${typeInput.value || 'ç”¨æˆ¶è‡ªå®šç¾©'}`,
                        title_en: `[Custom] ${nameInput.value}`,
                        info_en: `${locationInput.value} / Custom Asset`,
                        img_url: `https://via.placeholder.com/300x200/4a4a5a/ffffff?text=${nameInput.value.substring(0, 10)}`,
                        desc: descInput.value
                    };
                    
                    // 1. å„²å­˜åˆ° Local Storage
                    const storedData = localStorage.getItem('customKnowledge');
                    const customAssets = storedData ? JSON.parse(storedData) : [];
                    customAssets.push(newAsset);
                    localStorage.setItem('customKnowledge', JSON.stringify(customAssets));
                    
                    // 2. é‡æ–°è¼‰å…¥ä¸¦ç¹ªè£½ DOM
                    loadCustomData(); 
                    applyTranslation(currentLang); 

                    // 3. æ¢å¾©ç‹€æ…‹ä¸¦é—œé–‰ Modal
                    newDataForm.reset();
                    hideModal();
                    modalSubmitBtn.disabled = false;
                    modalSubmitBtn.textContent = translations[currentLang].btn_submit; 
                    showToast(translations[currentLang].modal_title.replace('åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', `æˆåŠŸåŒ¯å…¥è³‡ç”¢ï¼šã€Œ${newAsset.title_zh}ã€ï¼å·²åŠ å…¥ RAG æ•¸æ“šæºã€‚`), 'success');

                }, 1500);
            });
            

            // --------------------------------------------------------------------------------
            // --- æ ¸å¿ƒåŠŸèƒ½ 6: èŠå¤©åŠ RAG æ¨¡æ“¬ (ä¿®æ”¹ç‚ºåŒ…å«è‡ªå®šç¾©æ•¸æ“š) ---
            // --------------------------------------------------------------------------------
            
            // èŠå¤©è¨Šæ¯ DOM ç”¢ç”Ÿå™¨ (ç¶­æŒä¸è®Š)
            function addChatMessage(sender, message) {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender === 'AI' ? 'ai' : 'user'}`;
                bubble.textContent = message;
                chatWindow.appendChild(bubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // æ¨¡æ“¬ AI (RAG) å›æ‡‰ (ä¿®æ”¹ç‚ºæª¢ç´¢æ‰€æœ‰æ•¸æ“š)
            function simulateRAGResponse(userMessage) {
                const isChinese = currentLang === 'zh-Hant';
                const allData = getAllRAGData(); // ç²å–æ‰€æœ‰æ•¸æ“š
                let foundAsset = null;

                // å˜—è©¦åŒ¹é…ç”¨æˆ¶è¼¸å…¥èˆ‡çŸ¥è­˜åº«ä¸­çš„è³‡ç”¢
                allData.forEach(asset => {
                    if (userMessage.includes(asset.title_zh) || (asset.title_en && userMessage.toLowerCase().includes(asset.title_en.toLowerCase()))) {
                        foundAsset = asset;
                    }
                });

                setTimeout(() => {
                    addChatMessage('AI', isChinese ? 'ï¼ˆRAG æª¢ç´¢ä¸­... æ­£åœ¨å¾çŸ¥è­˜åº«æœå°‹è³‡æ–™...ï¼‰' : '(RAG Retrieval in progress...)');
                }, 500);

                setTimeout(() => {
                    let aiResponse = '';
                    if (foundAsset) {
                        const title = isChinese ? foundAsset.title_zh : foundAsset.title_en;
                        const desc = foundAsset.desc || (isChinese ? 'çŸ¥è­˜åº«ä¸­æš«ç„¡è©³ç´°æè¿°ã€‚' : 'No detailed description found.');
                        aiResponse = isChinese ? 
                            `[RAG å›æ‡‰] é—œæ–¼ ${title}ï¼š${desc} (æ•¸æ“šæºï¼š${foundAsset.info_zh.split(' / ')[1]})` : 
                            `[RAG RESPONSE] Regarding ${title}: ${desc} (Source: ${foundAsset.info_en.split(' / ')[1]})`;
                    } else if (userMessage.toLowerCase().includes('ä½ å¥½') || userMessage.toLowerCase().includes('hello')) {
                        aiResponse = isChinese ? 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ–‡åŒ–æ™ºéŠç³»çµ±ï¼Œæº–å‚™å¥½æ¢ç´¢å°ç£çš„æ­·å²è„ˆçµ¡äº†å—ï¼Ÿ' : 'Hello! I am your Culture Guide System, ready to explore the history of Taiwan?';
                    } else if (isRAGReady) {
                        aiResponse = isChinese ? 
                            '[RAG å›æ‡‰] æˆ‘æ”¶åˆ°äº†æ‚¨çš„æŒ‡ä»¤ï¼šã€Œ' + userMessage + 'ã€ã€‚ç„¡æ³•åœ¨çŸ¥è­˜åº«ä¸­æ‰¾åˆ°åŒ¹é…é …ã€‚' :
                            '[RAG RESPONSE] Received query: "' + userMessage + '". No match found in the knowledge base.';
                    } else {
                         aiResponse = isChinese ? 
                            '[ç³»çµ±] RAG æ ¸å¿ƒæœªé€£ç·šã€‚è«‹æª¢æŸ¥æ‚¨çš„ Gemini API Keyã€‚' :
                            '[SYSTEM] RAG Core is offline. Please check your Gemini API Key.';
                    }
                    addChatMessage('AI', aiResponse);
                }, 2000); 
            }

            // èŠå¤©ç™¼é€åŠŸèƒ½ (ç¶­æŒä¸è®Š)
            chatSendBtn.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message === '') return;

                if (!isRAGReady) {
                    showToast(translations[currentLang].modal_title.replace('åŒ¯å…¥è‡ªå®šç¾©æ–‡åŒ–è³‡ç”¢', 'è«‹å…ˆåœ¨ API è¨­å®šæ¨¡çµ„ä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini Keyã€‚'), 'error');
                    return;
                }

                addChatMessage('User', message);
                chatInput.value = ''; 
                simulateRAGResponse(message);
            });
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { chatSendBtn.click(); }
            });

            // æŠ˜ç–Šæ¨¡çµ„åŠŸèƒ½ (ç¶­æŒä¸è®Š)
            collapsibleHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('expanded');
                    const content = header.nextElementSibling;
                    if (content && content.classList.contains('module-content')) {
                        content.classList.toggle('expanded');
                    }
                });
            });

            // å…¨å±€æç¤ºæ¡† (Toast) åŠŸèƒ½ (ç¶­æŒä¸è®Š)
            function showToast(message, type = 'success') {
                // ... (Toast å‡½æ•¸ä¿æŒä¸è®Š) ...
                const oldToast = document.querySelector('.toast');
                if (oldToast) oldToast.remove();

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100); 

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.parentElement.removeChild(toast);
                        }
                    }, 300); 
                }, 3000);
            }

        });
    </script>

</body>
</html>
